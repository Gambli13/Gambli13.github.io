<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="images/pinkchrome.ico">
    <title>New Tab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font and base styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
            background-color: #fcfcfc; 
        }
        #background-container {
            background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 1 1\'%3E%3Crect width=\'1\' height=\'1\' fill=\'%230f172a\'/%3E%3C/svg%3E'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: background-image 1s ease-in-out;
        }
        .scroll-container {
            overflow-y: auto;
            height: 100vh;
            padding: 20px;
        }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.3); border-radius: 3px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }

        .bookmark-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .bookmark-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            border-color: #3b82f6;
        }
        
        .bookmark-favicon {
            width: 24px; 
            height: 24px;
            object-fit: contain;
            filter: none; 
        }

        .mcast-link-item {
            transition: background-color 0.3s, transform 0.3s;
            cursor: pointer;
        }
        .mcast-link-item:hover {
            background-color: rgba(0, 0, 0, 0.05); 
            transform: translateX(5px);
        }

        .delete-btn, .done-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .assignment-item:hover .delete-btn,
        .assignment-item:hover .done-btn,
        .bookmark-item-wrap:hover .delete-btn,
        .finished-item-wrap:hover .delete-btn {
            opacity: 1;
        }

        .assignment-item-done {
            position: relative;
            z-index: 1;
            transition: opacity 0.5s ease-out,
                        height 0.5s ease-out,
                        padding 0.5s ease-out,
                        margin 0.5s ease-out;
        }

        .assignment-item-done::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, #97ffa0, #74ec3c);
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            z-index: -1;
        }

        .assignment-item-done.swipe-active::before {
            width: 100%;
        }

        .assignment-item.swipe-to-delete {
            opacity: 0;
            height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }


        .background-thumbnail {
            width: 100%;
            padding-top: 56.25%; 
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s, opacity 0.3s;
        }
        .background-thumbnail:hover {
            border-color: #3b82f6; 
            opacity: 0.8;
        }
        .background-thumbnail.selected {
            border-color: #10b981; 
            border-width: 4px;
        }

        #version-timestamp {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            font-size: 0.75rem; 
            color: rgba(0, 0, 0, 0.5); 
            background-color: rgba(255, 255, 255, 0.5);
            padding: 4px 8px;
            border-radius: 6px;
            backdrop-filter: blur(5px);
        }
        
        /* Dark Color Palette for light theme contrast */
        .text-dark-primary { color: #4a2c2c; }
        .text-dark-secondary { color: #6a4a4a; }
        .text-dark-tertiary { color: #8a6a6a; }
        .icon-dark-primary { color: #4a2c2c; }
        
        .finished-assignment-details {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }
        .finished-assignment-details > * { margin-right: 8px; }
        .finished-assignment-details .title {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 1;
            min-width: 50px;
        }
        .finished-assignment-details .date {
            font-size: 0.75rem;
            flex-shrink: 0;
        }

    </style>

    <script>
        const LOCAL_FIREBASE_CONFIG_JSON = JSON.stringify({
           apiKey: "AIzaSyDRYcVVOg_yzTbYQnBj7TxghX-2rNT3f3g",
           authDomain: "personalment-c1a9c.firebaseapp.com",
           projectId: "personalment-c1a9c",
           storageBucket: "personalment-c1a9c.appspot.com",
           messagingSenderId: "461177689665",
           appId: "1:461177689665:web:bddc74fe94c21c097d18c0",
           measurementId: "G-RC5MSQBNK"
        });
        const LOCAL_AUTH_TOKEN = null; 
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, setLogLevel, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const configSource = typeof __firebase_config !== 'undefined' ? __firebase_config : LOCAL_FIREBASE_CONFIG_JSON;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? LOCAL_AUTH_TOKEN : LOCAL_AUTH_TOKEN;
        const firebaseConfig = JSON.parse(configSource);
        
        let db, auth, userId = null;
        let isAuthReady = false;

        setLogLevel('debug');

        const getCollectionPath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}_daniela`;

        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = "daniela_shared_user";
                    isAuthReady = true;
                    console.log("Using shared user ID:", userId);
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    setupDataListeners();
                }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                window.setupMockData();
            }
        };

        const setupDataListeners = () => {
            if (!db || !userId) return;

            onSnapshot(collection(db, getCollectionPath('assignments')), (snapshot) => {
                const assignments = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const deadlineDate = parseDeadlineISO(data.deadline); 
                    assignments.push({ id: doc.id, ...data, deadline: deadlineDate });
                });
                assignments.sort((a, b) => (a.deadline || 0) - (b.deadline || 0));
                window.renderAssignments(assignments);
                // NEW: Re-render calendar when assignments update
                window.renderCalendar(); 
            });

            onSnapshot(collection(db, getCollectionPath('bookmarks')), (snapshot) => {
                const bookmarks = [];
                snapshot.forEach(doc => {
                    bookmarks.push({ id: doc.id, ...doc.data() });
                });
                window.renderBookmarks(bookmarks);
            });
            
            // 3. Backgrounds Listener (FIXED: Added Sorting by Date)
            onSnapshot(collection(db, getCollectionPath('backgrounds')), (snapshot) => {
                const userBackgrounds = [];
                snapshot.forEach(doc => {
                    userBackgrounds.push({ 
                        id: doc.id, 
                        name: doc.data().name || 'Background', 
                        base64: doc.data().base64,
                        uploadedAt: doc.data().uploadedAt || new Date(0).toISOString() // Ensure date exists
                    });
                });
                
                // SORT: Newest uploads first
                userBackgrounds.sort((a, b) => b.uploadedAt.localeCompare(a.uploadedAt));
                
                window.setUserBackgrounds(userBackgrounds);
                window.renderBackgroundGallery(userBackgrounds);
            });

            onSnapshot(collection(db, getCollectionPath('finished')), (snapshot) => {
                const finished = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let deadlineDate = parseDeadlineISO(data.deadline);
                    let completedAtDate = data.completedAt ? new Date(data.completedAt) : new Date();
                    
                    finished.push({ id: doc.id, ...data, deadline: deadlineDate, completedAt: completedAtDate });
                });
                finished.sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));
                window.renderFinishedAssignments(finished);
            });
        };

        
        window.db = {
            addAssignment: async (title, dateString, timeString, notes = '') => {
                if (!db || !userId) return;
                try {
                    const deadlineDate = createDeadlineDate(dateString, timeString);
                    await addDoc(collection(db, getCollectionPath('assignments')), {
                        title: title,
                        deadline: deadlineDate.toISOString(), 
                        notes: notes, 
                        createdAt: new Date().toISOString()
                    });
                } catch (e) { console.error(e); }
            },
            updateAssignment: async (id, title, dateString, timeString, notes = '') => {
                if (!db || !userId) return;
                try {
                    const deadlineDate = createDeadlineDate(dateString, timeString);
                    const deadlineISO = deadlineDate ? deadlineDate.toISOString() : null;
                    await setDoc(doc(db, getCollectionPath('assignments'), id), {
                        title: title,
                        deadline: deadlineISO, 
                        notes: notes || '',
                        updatedAt: new Date().toISOString()
                    }, { merge: true }); 
                } catch (e) { console.error(e); }
            },
            deleteAssignment: async (id) => {
                if (!db || !userId) return;
                try { await deleteDoc(doc(db, getCollectionPath('assignments'), id)); } catch (e) { console.error(e); }
            },
            addFinishedAssignment: async (assignmentData) => {
                if (!db || !userId) return;
                try {
                    await deleteDoc(doc(db, getCollectionPath('assignments'), assignmentData.id));
                    await setDoc(doc(db, getCollectionPath('finished'), assignmentData.id), {
                        ...assignmentData,
                        deadline: typeof assignmentData.deadline === 'object' && assignmentData.deadline !== null ? assignmentData.deadline.toISOString() : assignmentData.deadline,
                        completedAt: new Date().toISOString(), 
                    }, { merge: true });
                } catch (e) { console.error(e); }
            },
            deleteFinishedAssignment: async (id) => {
                if (!db || !userId) return;
                try { await deleteDoc(doc(db, getCollectionPath('finished'), id)); } catch (e) { console.error(e); }
            },
            addBookmark: async (name, url, icon) => {
                if (!db || !userId) return;
                try {
                    await addDoc(collection(db, getCollectionPath('bookmarks')), { name, url, icon });
                } catch (e) { console.error(e); }
            },
            deleteBookmark: async (id) => {
                if (!db || !userId) return;
                try { await deleteDoc(doc(db, getCollectionPath('bookmarks'), id)); } catch (e) { console.error(e); }
            },
            // FIXED: Returns the new ID so we can select it immediately
            addBackground: async (base64String, fileName) => {
                if (!db || !userId) return null;
                try {
                    const docRef = await addDoc(collection(db, getCollectionPath('backgrounds')), {
                        base64: base64String, 
                        name: fileName, 
                        uploadedAt: new Date().toISOString()
                    });
                    return docRef.id;
                } catch (e) { 
                    console.error("Firebase Upload Error:", e); 
                    alert("Failed to upload. The image might be too large even after compression.");
                    return null;
                }
            },
            deleteBackground: async (id) => {
                if (!db || !userId) return;
                try { await deleteDoc(doc(db, getCollectionPath('backgrounds'), id)); } catch (e) { console.error(e); }
            },
        };

        initFirebase();
    </script>

    <script>
        let USER_BACKGROUNDS = [];
        const CURRENT_BG_KEY = 'currentBackgroundId';
        let currentBackgroundId = localStorage.getItem(CURRENT_BG_KEY) || null;
        let backgroundContainer;

        // --- NEW: CALENDAR LOGIC START ---
        // Global date variable for the calendar
        let currentCalendarDate = new Date(); 

        const openCalendarModal = () => {
            const modal = document.getElementById('calendar-modal');
            currentCalendarDate = new Date(); // Reset to today when opening
            modal.classList.remove('opacity-0', 'pointer-events-none');
            renderCalendar();
        };

        const closeCalendarModal = (e) => {
            if (e.target.id === 'calendar-modal') {
                e.target.classList.add('opacity-0', 'pointer-events-none');
            }
        };

        const renderCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const monthYearTitle = document.getElementById('calendar-month-year');
            
            if (!grid || !monthYearTitle) return;

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update Header
            monthYearTitle.textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentCalendarDate);

            // 1. Calculate Monday-Start alignment
            const firstDayRaw = new Date(year, month, 1).getDay();
            const firstDayIndex = (firstDayRaw === 0) ? 6 : firstDayRaw - 1; // 0 = Mon, 6 = Sun

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthLastDate = new Date(year, month, 0).getDate();
            const today = new Date();

            grid.innerHTML = '';

            // --- HELPER: Renders a single cell (Adapted for Light/Pink Theme) ---
            const createDayCell = (dateObj, isCurrentMonth) => {
                const isToday = isCurrentMonth && 
                                dateObj.getDate() === today.getDate() && 
                                dateObj.getMonth() === today.getMonth() && 
                                dateObj.getFullYear() === today.getFullYear();
                
                // Find assignments for this specific day
                const dayAssignments = [
                    ...assignments.map(a => ({ ...a, isFinished: false })),
                    ...finishedAssignments.map(a => ({ ...a, isFinished: true }))
                ].filter(a => {
                    if (!a.deadline) return false;
                    const d = a.deadline instanceof Date ? a.deadline : new Date(a.deadline);
                    return d.getDate() === dateObj.getDate() && 
                           d.getMonth() === dateObj.getMonth() && 
                           d.getFullYear() === dateObj.getFullYear();
                });

                // THEME LOGIC:
                // Current Month: bg-pink-50 (Your original style)
                // Off-Month: bg-gray-50/50 (Lighter, faded)
                const bgClass = isCurrentMonth ? 'bg-pink-50' : 'bg-gray-50/40';
                
                // Text Color:
                // Today: Red-600 (Bold)
                // Current Month: Dark-Secondary
                // Off-Month: Gray-300 (Faded)
                const textClass = isCurrentMonth 
                    ? (isToday ? 'text-pink-400' : 'text-dark-secondary/70') 
                    : 'text-gray-300';
                
                // Today Highlight
                const ringClass = isToday ? 'ring-2 ring-inset ring-pink-300 bg-blue-50/30' : '';

                const cell = document.createElement('div');
                cell.className = `${bgClass} min-h-[120px] p-2 flex flex-col relative group transition-colors hover:bg-pink-100 ${ringClass}`;
                
                // Day Number
                let dayNumberHTML = `<span class="font-bold text-sm mb-1 ${textClass}">${dateObj.getDate()}</span>`;
                
                // Assignments Content
                let contentHTML = '';
                
                if (dayAssignments.length > 0) {
                    // Assignment Colors:
                    // Current Month: bg-red-100 / text-red-700 (Original)
                    // Off-Month: bg-gray-100 / text-gray-400 (Faded)
                    const assignBg = isCurrentMonth ? 'bg-pink-100 hover:bg-pink-200 border-pink-200' : 'bg-gray-100 border-gray-100 opacity-60';
                    const assignText = isCurrentMonth ? 'text-pink-700' : 'text-gray-400';

                    if (dayAssignments.length <= 2) {
                        contentHTML = dayAssignments.map(a => {
                            const safeTitle = a.title.replace(/'/g, "\\'");
                            const safeNotes = (a.notes || '').replace(/'/g, "\\'");
                            const safeDeadline = a.deadline instanceof Date ? a.deadline.toISOString() : a.deadline;

                            // If finished, use gray strikethrough. If active, use the theme colors calculated above.
                            const finalBg = a.isFinished ? 'bg-gray-200 border-gray-300' : assignBg;
                            const finalText = a.isFinished ? 'text-gray-400 line-through' : assignText;

                            return `
                            <div class="mt-1 p-1.5 rounded text-xs truncate shadow-sm border ${finalBg} ${finalText} cursor-pointer"
                                ${!a.isFinished ? `
                                    onclick="window.openAssignmentDetailModal('${a.id}', '${safeTitle}', '${safeDeadline}', '${safeNotes}');
                                    document.getElementById('calendar-modal').classList.add('opacity-0', 'pointer-events-none');
                                    event.stopPropagation();"
                                ` : ''}
                                title="${a.title}">
                                ${a.title}
                            </div>
                            `;
                        }).join('');
                    } else {
                        // Dropdown Logic
                        const hiddenListId = `dropdown-${dateObj.getFullYear()}-${dateObj.getMonth()}-${dateObj.getDate()}`;
                        contentHTML = `
                            <div class="mt-1 p-1.5 rounded text-xs font-bold text-center cursor-pointer shadow-sm select-none border ${assignBg} ${assignText}"
                                onclick="document.getElementById('${hiddenListId}').classList.toggle('hidden'); event.stopPropagation();">
                                ${dayAssignments.length} Assignments
                            </div>
                            <div id="${hiddenListId}" class="hidden absolute top-full left-0 right-0 z-10 bg-white border border-gray-200 rounded-lg shadow-xl mt-1 overflow-hidden">
                                ${dayAssignments.map(a => {
                                    const safeTitle = a.title.replace(/'/g, "\\'");
                                    const safeNotes = (a.notes || '').replace(/'/g, "\\'");
                                    const safeDeadline = a.deadline instanceof Date ? a.deadline.toISOString() : a.deadline;
                                    return `
                                    <div class="p-2 border-b border-gray-100 text-xs truncate
                                        ${a.isFinished ? 'text-gray-400 line-through' : 'text-dark-primary hover:bg-gray-50'}"
                                        onclick="window.openAssignmentDetailModal('${a.id}', '${safeTitle}', '${safeDeadline}', '${safeNotes}');
                                        document.getElementById('calendar-modal').classList.add('opacity-0', 'pointer-events-none');
                                        event.stopPropagation();">
                                        ${a.title}
                                    </div>
                                `}).join('')}
                            </div>
                        `;
                    }
                }

                cell.innerHTML = dayNumberHTML + contentHTML;
                return cell;
            };

            // 2. Render Previous Month padding days
            for (let i = firstDayIndex - 1; i >= 0; i--) {
                const dayNum = prevMonthLastDate - i;
                const dateObj = new Date(year, month - 1, dayNum);
                grid.appendChild(createDayCell(dateObj, false));
            }

            // 3. Render Current Month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(year, month, day);
                grid.appendChild(createDayCell(dateObj, true));
            }

            // 4. Render Next Month padding days
            const totalCellsFilled = firstDayIndex + daysInMonth;
            const remainingCells = (7 - (totalCellsFilled % 7)) % 7;
            
            for (let i = 1; i <= remainingCells; i++) {
                const dateObj = new Date(year, month + 1, i);
                grid.appendChild(createDayCell(dateObj, false));
            }

            lucide.createIcons();
        };
        // --- CALENDAR LOGIC END ---

        window.setUserBackgrounds = (newBackgrounds) => {
            USER_BACKGROUNDS = newBackgrounds;
            const isCurrentValid = USER_BACKGROUNDS.some(bg => bg.id === currentBackgroundId);
            
            if (!isCurrentValid && USER_BACKGROUNDS.length > 0) {
                 currentBackgroundId = USER_BACKGROUNDS[0].id;
                 localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);
            } else if (USER_BACKGROUNDS.length === 0) {
                 currentBackgroundId = null;
                 localStorage.removeItem(CURRENT_BG_KEY);
            }
            changeBackground(currentBackgroundId);
        }

        const changeBackground = (backgroundId) => {
            if (!backgroundContainer) backgroundContainer = document.getElementById('background-container');
            const selectedBackground = USER_BACKGROUNDS.find(bg => bg.id === backgroundId);
            if (selectedBackground) {
                currentBackgroundId = selectedBackground.id;
                localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);
                backgroundContainer.style.backgroundImage = `url('${selectedBackground.base64}')`;
            } else {
                currentBackgroundId = null;
                localStorage.removeItem(CURRENT_BG_KEY);
                backgroundContainer.style.backgroundImage = `url('data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 1 1\\'%3E%3Crect width=\\'1\\' height=\\'1\\' fill=\\'%23fcfcfc\\'/%3E%3C/svg%3E')`; 
            }
        };

        window.renderBackgroundGallery = (userBackgrounds) => {
            const galleryContainer = document.getElementById('background-gallery-grid');
            galleryContainer.innerHTML = ''; 

            if (userBackgrounds.length === 0) {
                 galleryContainer.innerHTML = '<p class="text-dark-tertiary text-center col-span-full">No backgrounds uploaded yet. Use the form below to add one!</p>';
                 return;
            }

            userBackgrounds.forEach(bg => {
                const isSelected = bg.id === currentBackgroundId;
                const item = document.createElement('div');
                item.className = 'relative group';
                item.innerHTML = `
                    <div class="background-thumbnail rounded-xl overflow-hidden shadow-lg border-2" 
                         style="background-image: url('${bg.base64}');"
                         data-bg-id="${bg.id}"
                         title="Click to select: ${bg.name}">
                         </div>
                    <span class="absolute top-2 left-2 px-2 py-1 bg-dark-primary/70 text-white text-xs rounded-full opacity-80">${bg.name}</span>
                    <button onclick="window.db.deleteBackground('${bg.id}')"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-opacity opacity-0 group-hover:opacity-100"
                            title="Delete Background">
                        <span data-lucide="x" class="w-4 h-4 icon-dark-primary"></span>
                    </button>
                `;

                item.querySelector('.background-thumbnail').addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-bg-id');
                    changeBackground(id); 
                    document.querySelectorAll('.background-thumbnail').forEach(el => el.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                });
                if (isSelected) item.querySelector('.background-thumbnail').classList.add('selected');
                galleryContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        let MOCK_ASSIGNMENTS = [];
        let MOCK_FINISHED_ASSIGNMENTS = [
            { id: 'mockf1', title: 'Old Project Report (Mock)', deadline: new Date(new Date().getTime() - (24 * 60 * 60 * 1000)), completedAt: new Date(new Date().getTime() - (12 * 60 * 60 * 1000)), notes: 'Completed ahead of schedule' }
        ];

        const getMockAssignments = () => {
            if (MOCK_ASSIGNMENTS.length === 0) {
                const now = new Date();
                const tomorrow = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                const nextWeek = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));
                MOCK_ASSIGNMENTS = [
                    { id: 'mock1', title: 'Database Design Exam (Mock)', deadline: tomorrow, createdAt: new Date(), notes: 'Focus on ER diagrams.' },
                    { id: 'mock2', title: 'Physics Lab Report (Mock)', deadline: nextWeek, createdAt: new Date(), notes: 'Remember to attach photos.' },
                ];
            }
            return MOCK_ASSIGNMENTS;
        };

        let MOCK_BOOKMARKS = [
            { id: 'bm1', name: "Gemini", url: "https://gemini.google.com/", icon: "sparkles" },
            { id: 'bm2', name: "GitHub", url: "https://github.com/", icon: "code" },
            { id: 'bm4', name: "Mail", url: "https://mail.google.com/", icon: "mail" },
        ];
        
        let MOCK_BACKGROUNDS = [
            { id: 'bg1', name: 'Mock Sunset', base64: 'https://placehold.co/1920x1080/1e3a8a/bfdbfe?text=MOCK+BACKGROUND' }
        ];

        const MCAST_LINKS = [
            { name: "UoM VLE", url: "https://accounts.um.edu.mt/sign-in/go/vle/my/", icon: "school" },
            { name: "Citation Generator", url: "https://www.mybib.com/tools/apa-citation-generator", icon: "quote" },
        ];

        const TIMETABLE = {
            Monday: [
                { start: "09:00", end: "11:00", title: "Journalism Studies", location: "MAKS 313" },
                { start: "11:00", end: "14:00", title: "BREAK", location: null },
                { start: "14:00", end: "16:00", title: "Sociology of Island Life", location: "LC 116" },
                { start: "16:00", end: "17:00", title: "Writing for the Media", location: "GateWay Hall B2" },
                { start: "17:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Tuesday: [
                { start: "09:00", end: "11:00", title: "Urban Society & Culture", location: "CH9411" },
                { start: "11:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Wednesday: [
                { start: "14:00", end: "16:00", title: "Film Studies", location: "Francis Ebejer Hall" },
                { start: "16:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Thursday: [
                { start: "14:00", end: "16:00", title: "Family Life", location: "Gateway Hall D1" },
                { start: "16:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Friday: [
                { start: "09:00", end: "11:00", title: "Marketing Communications", location: "Francis Ebejer Hall" },
                { start: "11:00", end: "17:00", title: "BREAK", location: null },
                { start: "17:00", end: "19:00", title: "New Media & Social World", location: "Francis Ebejer Hall" },
                { start: "19:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Saturday: [{ start: "00:00", end: "23:59", title: "WEEKEND", location: null }],
            Sunday: [{ start: "00:00", end: "23:59", title: "WEEKEND", location: null }]
        };
        const DAYS_OF_WEEK = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let nextLessonInterval;

        const timeToMinutes = (time) => {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        const getNextScheduleItem = () => {
            const now = new Date();
            const dayIndex = now.getDay();
            const currentDayName = DAYS_OF_WEEK[dayIndex];
            const nowMinutes = now.getHours() * 60 + now.getMinutes();

            let todaySchedule = TIMETABLE[currentDayName];
            
            let currentItem = todaySchedule.find(item => 
                 timeToMinutes(item.start) <= nowMinutes && timeToMinutes(item.end) > nowMinutes
            );

            if (currentItem && currentItem.title !== "END OF DAY" && currentItem.title !== "WEEKEND") {
                 let nextItem = todaySchedule.find(item => timeToMinutes(item.start) === timeToMinutes(currentItem.end));
                 if (nextItem) {
                     return {
                        ...currentItem, day: currentDayName, isCurrent: true, 
                        nextTitle: nextItem.title, nextLocation: nextItem.location, nextStart: nextItem.start, nextEnd: nextItem.end,
                        remainingMinutes: timeToMinutes(currentItem.end) - nowMinutes, 
                        remainingSeconds: (timeToMinutes(currentItem.end) * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()), 
                    };
                 }
            }

            let nextItem = todaySchedule.find(item => timeToMinutes(item.start) > nowMinutes);

            if (nextItem && nextItem.title !== "END OF DAY") {
                return {
                    ...nextItem, day: currentDayName,
                    remainingMinutes: timeToMinutes(nextItem.start) - nowMinutes,
                    remainingSeconds: (timeToMinutes(nextItem.start) * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()), 
                    isCurrent: false
                };
            }

            for (let i = 1; i <= 7; i++) {
                const nextDayIndex = (dayIndex + i) % 7;
                const nextDayName = DAYS_OF_WEEK[nextDayIndex];
                const nextDaySchedule = TIMETABLE[nextDayName]; 
                
                const firstEvent = nextDaySchedule.find(item => item.title !== "END OF DAY" && item.title !== "WEEKEND");

                if (firstEvent) {
                     let remainingDaySeconds = (24 * 60 * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()); 
                     let totalSeconds = remainingDaySeconds;
                     for(let j = 1; j < i; j++) totalSeconds += 24 * 60 * 60;
                     totalSeconds += timeToMinutes(firstEvent.start) * 60;
                     
                     return {
                        ...firstEvent, day: nextDayName, remainingMinutes: Math.ceil(totalSeconds / 60), remainingSeconds: totalSeconds, isNextDay: true
                    };
                }
            }
            return { title: "Schedule Error", start: null, end: null, location: null, remainingMinutes: 0, remainingSeconds: 0 };
        };

        const renderScheduleWidget = () => {
            const widgetEl = document.getElementById('next-lesson-widget');
            if (!widgetEl) return;
            const nextItem = getNextScheduleItem();
            let { title, start, end, location, remainingSeconds, day, isNextDay, isCurrent, nextTitle } = nextItem; 
            
            const totalSeconds = remainingSeconds;
            const days = Math.floor(totalSeconds / (60 * 60 * 24));
            const hours = Math.floor((totalSeconds % (60 * 60 * 24)) / (60 * 60));
            const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);

            let countdownHTML;
            let icon = "calendar";
            let statusClass = "text-pink-600"; 
            let subText = `<span class="text-dark-secondary">Next Up:</span> <span class="font-bold text-dark-primary">${title}</span>`; 
            let timeRangeToDisplay = '';
            let locationPrefix = 'Location: ';

            if (isCurrent && totalSeconds > 0) {
                 statusClass = title === "BREAK" ? "text-pink-300" : "text-pink-400";
                 icon = title === "BREAK" ? "coffee" : "hourglass";
                 subText = `<span class="text-dark-secondary">Currently in:</span> <span class="font-bold text-dark-primary">${title}</span>`;
                 countdownHTML = `<span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m left`;
                 timeRangeToDisplay = `${start} - ${end}`;
            } else if (days > 0) {
                countdownHTML = `<span class="font-bold">${days}</span>d <span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m`;
                icon = "calendar-check";
                statusClass = "text-yellow-700";
                subText = `<span class="text-dark-secondary">First Lesson:</span> <span class="font-bold text-dark-primary">${title}</span> (${day})`;
                timeRangeToDisplay = `${start} - ${end}`;
            } else if (totalSeconds > 0) {
                countdownHTML = `<span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m`;
                if (title === "BREAK") { icon = "coffee"; statusClass = "text-pink-300"; } else { icon = "clock"; statusClass = "text-pink-600"; }
                timeRangeToDisplay = `${start} - ${end}`;
            } else {
                countdownHTML = "Finished";
                icon = "sun";
                statusClass = "text-dark-tertiary";
                subText = `<span class="text-dark-secondary">Classes are over. Enjoy your evening!</span>`;
                location = '';
            }

            widgetEl.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <div class="flex items-center">
                        <span data-lucide="${icon}" class="w-5 h-5 mr-2 ${statusClass} icon-dark-primary"></span>
                        <p class="text-sm text-dark-secondary">${subText}</p>
                    </div>
                    <p class="text-sm font-semibold ${statusClass} text-dark-primary">${countdownHTML}</p>
                </div>
                <div class="flex justify-between items-center w-full mt-1 border-t border-dark-tertiary/20 pt-1">
                    <p class="text-xs text-dark-tertiary">${timeRangeToDisplay}</p>
                    <p class="text-xs text-dark-tertiary">${location ? locationPrefix + location : ''}</p>
                </div>
            `;
            lucide.createIcons(); 
        };

        let assignments = [];
        let finishedAssignments = []; 
        let bookmarks = []; 
        let countdownInterval;
        let isEditMode = false;
        let currentAssignmentId = null;

        window.setupMockData = () => {
            bookmarks = MOCK_BOOKMARKS;
            window.renderBookmarks(bookmarks);
            assignments = getMockAssignments();
            window.renderAssignments(assignments);
            window.renderFinishedAssignments(MOCK_FINISHED_ASSIGNMENTS);
            window.setUserBackgrounds(MOCK_BACKGROUNDS);
            window.renderBackgroundGallery(MOCK_BACKGROUNDS); 
            window.renderMCASTLinks();
            renderScheduleWidget();
            if (nextLessonInterval) clearInterval(nextLessonInterval);
            nextLessonInterval = setInterval(renderScheduleWidget, 1000); 

            window.db = {
                addAssignment: (title, deadlineDate, notes = '') => {
                    const newAssignment = { id: crypto.randomUUID(), title: `${title} (Mock)`, deadline: deadlineDate, createdAt: new Date(), notes: notes };
                    assignments.push(newAssignment);
                    assignments.sort((a, b) => (a.deadline || 0) - (b.deadline || 0));
                    window.renderAssignments(assignments);
                    window.renderCalendar(); // Render calendar in mock mode
                },
                updateAssignment: async (id, title, dateString, timeString, notes, subtasks) => {
                    if (!db || !userId) return;
                    try {
                        const deadlineDate = createDeadlineDate(dateString, timeString);
                        const deadlineISO = deadlineDate ? deadlineDate.toISOString() : null;
                        
                        await setDoc(doc(db, getCollectionPath('assignments'), id), {
                            title: title,
                            deadline: deadlineISO, 
                            notes: notes || '',
                            subtasks: subtasks || [], // Save the subtasks
                            updatedAt: new Date().toISOString()
                        }, { merge: true }); 
                    } catch (e) { console.error(e); }
                },
                deleteAssignment: (id) => {
                    assignments = assignments.filter(a => a.id !== id);
                    window.renderAssignments(assignments);
                    window.renderCalendar(); // Render calendar in mock mode
                },
                addFinishedAssignment: (assignmentData) => {
                    assignments = assignments.filter(a => a.id !== assignmentData.id);
                    const finishedItem = { ...assignmentData, completedAt: new Date() };
                    MOCK_FINISHED_ASSIGNMENTS.unshift(finishedItem); 
                    window.renderAssignments(assignments);
                    window.renderFinishedAssignments(MOCK_FINISHED_ASSIGNMENTS);
                    window.renderCalendar(); // Render calendar in mock mode
                },
                deleteFinishedAssignment: (id) => {
                    MOCK_FINISHED_ASSIGNMENTS = MOCK_FINISHED_ASSIGNMENTS.filter(a => a.id !== id);
                    window.renderFinishedAssignments(MOCK_FINISHED_ASSIGNMENTS);
                },
                addBookmark: (name, url, icon) => {
                    const newBookmark = { id: crypto.randomUUID(), name: name, url: url, icon: icon };
                    bookmarks.push(newBookmark);
                    window.renderBookmarks(bookmarks);
                },
                deleteBookmark: (id) => {
                    bookmarks = bookmarks.filter(b => b.id !== id);
                    window.renderBookmarks(bookmarks);
                },
                addBackground: (base64String, fileName) => {
                    const newBackground = { id: crypto.randomUUID(), name: fileName, base64: base64String };
                    MOCK_BACKGROUNDS.push(newBackground);
                    window.setUserBackgrounds(MOCK_BACKGROUNDS);
                    window.renderBackgroundGallery(MOCK_BACKGROUNDS);
                },
                deleteBackground: (id) => {
                    MOCK_BACKGROUNDS = MOCK_BACKGROUNDS.filter(b => b.id !== id);
                    window.setUserBackgrounds(MOCK_BACKGROUNDS);
                    window.renderBackgroundGallery(MOCK_BACKGROUNDS);
                }
            };
        };

        const padZero = (num) => String(Math.floor(num)).padStart(2, '0');
        const getTimeRemaining = (endTime) => {
            const total = endTime - new Date();
            const seconds = padZero((total / 1000) % 60);
            const minutes = padZero((total / (1000 * 60)) % 60);
            const hours = padZero((total / (1000 * 60 * 60)) % 24);
            const days = padZero(total / (1000 * 60 * 60 * 24));
            return { total, days, hours, minutes, seconds };
        };
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };
        const getBaseDomain = (url) => {
            try {
                const safeUrl = url.startsWith('http') ? url : `https://${url}`;
                const domain = new URL(safeUrl).hostname;
                return domain.startsWith('www.') ? domain.substring(4) : domain;
            } catch (e) { return null; }
        };

        window.handleAssignmentDone = async (id) => {
            // find the assignment object
            const assignment = assignments.find(a => a.id === id);
            if (!assignment) return;

            // get the DOM row (the one you already render)
            const item = document.getElementById(`assignment-item-${id}`);
            if (!item) {
                // fallback: still mark done even if element not found
                await window.db.addFinishedAssignment(assignment);
                return;
            }

            // start green swipe animation
            item.classList.add('assignment-item-done');
            void item.offsetWidth; // force reflow so the animation triggers
            item.classList.add('swipe-active');

            // after animation finishes, move it to finished in Firebase
            setTimeout(async () => {
                await window.db.addFinishedAssignment(assignment);
            }, 500);
        };

        
        window.handleAssignmentDelete = (id) => { window.db.deleteAssignment(id); };

        window.renderMCASTLinks = (newLinks) => {
            const container = document.getElementById('mcast-link-list');
            container.innerHTML = MCAST_LINKS.map(link => `
                <div class="mcast-link-item-wrap relative flex items-center group">
                    <a href="${link.url}" 
                       rel="noopener noreferrer"
                       title="${link.name}"
                       class="mcast-link-item block w-full text-left p-3 pr-4 rounded-xl bg-white/70 text-dark-primary hover:bg-white/90 backdrop-blur-sm transition-all duration-300">
                        <span data-lucide="${link.icon || 'link'}" class="inline-block w-4 h-4 mr-2 icon-dark-primary"></span>
                        ${link.name}
                    </a>
                </div>
            `).join('');
            lucide.createIcons();
        };

        window.renderBookmarks = (newBookmarks) => {
            bookmarks = newBookmarks;
            const container = document.getElementById('bookmark-container');
            container.innerHTML = bookmarks.map(b => {
                const domain = getBaseDomain(b.url);
                const faviconUrl = domain ? `https://s2.googleusercontent.com/s2/favicons?domain=${domain}&sz=64` : null;
                const iconContent = faviconUrl 
                    ? `<img src="${faviconUrl}" alt="${b.name} Favicon" class="bookmark-favicon" onerror="this.outerHTML='<span data-lucide=${b.icon || 'link'} class=\\'w-6 h-6 icon-dark-primary\\'></span>'"/>`
                    : `<span data-lucide="${b.icon || 'link'}" class="w-6 h-6 icon-dark-primary"></span>`;
                return `
                <div class="bookmark-item-wrap relative">
                    <a href="${b.url}" rel="noopener noreferrer" title="${b.name}"
                        class="bookmark-icon flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/70 border border-white/90 rounded-2xl hover:border-blue-400">
                        ${iconContent}
                        <span class="text-xs text-dark-secondary mt-1 truncate max-w-full">${b.name}</span>
                    </a>
                    <button onclick="window.db.deleteBookmark('${b.id}')"
                            class="delete-btn absolute top-[-5px] right-[-5px] w-6 h-6 flex items-center justify-center bg-dark-primary/20 text-dark-primary rounded-full p-0.5 shadow-md hover:bg-dark-primary/30 transition-colors">
                        <span data-lucide="x" class="w-3 h-3 icon-dark-primary"></span>
                    </button>
                </div>
                `;
            }).join('');
            container.innerHTML += `
                <button id="open-bookmark-modal-btn"
                        class="flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/50 border border-white/70 rounded-2xl text-dark-tertiary hover:text-dark-primary hover:border-blue-500 transition-all duration-300"
                        title="Add New Bookmark">
                    <span data-lucide="plus" class="w-8 h-8 icon-dark-primary"></span>
                    <span class="text-xs mt-1">Add</span>
                </button>
            `;
            document.getElementById('open-bookmark-modal-btn')?.addEventListener('click', openBookmarkModal);
            lucide.createIcons();
        };

        window.renderAssignments = (newAssignments) => {
            assignments = newAssignments;
            const list = document.getElementById('assignment-list');
            list.innerHTML = ''; 
            if (assignments.length === 0) {
                list.innerHTML = '<p class="text-dark-tertiary text-center mt-4">No upcoming assignments. Add one!</p>';
            }
            assignments.forEach(assignment => {
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const day = String(deadlineDate.getDate()).padStart(2, '0');
                const month = String(deadlineDate.getMonth() + 1).padStart(2, '0');
                const year = deadlineDate.getFullYear();
                const hours = String(deadlineDate.getHours()).padStart(2, '0');
                const minutes = String(deadlineDate.getMinutes()).padStart(2, '0');
                const formattedDate = `${day}/${month}/${year} at ${hours}:${minutes}`;
                const deadlineISO = deadlineDate.toISOString(); 
                const countdownHTML = `<div id="countdown-${assignment.id}" class="text-xs font-mono text-pink-300 mt-1">Calculating...</div>`;
                const itemWrap = document.createElement('div');
                itemWrap.id = `assignment-item-wrap-${assignment.id}`;
                itemWrap.className = 'relative mb-3 group'; 
                
                itemWrap.innerHTML = `
                    <div id="assignment-item-${assignment.id}" 
                        class="assignment-item flex justify-between items-center p-3 rounded-lg bg-white/70 backdrop-blur-sm shadow-md transition-all duration-300 hover:bg-white/90 cursor-pointer" 
                        data-id="${assignment.id}"
                        onclick="window.openAssignmentDetailModal('${assignment.id}', '${assignment.title.replace(/'/g, "\\'")}', '${deadlineISO}', '${(assignment.notes || '').replace(/'/g, "\\'")}')">
                        <div class="flex-grow pr-4">
                            <p class="text-sm font-semibold text-pink-500 text-dark-primary">${assignment.title}</p>
                            <p class="text-xs text-dark-secondary">${formattedDate}</p>
                            ${countdownHTML}
                        </div>
                        <div class="flex items-center space-x-1">
                            <button onclick="event.stopPropagation(); window.handleAssignmentDone('${assignment.id}')" 
                                    class="done-btn p-1 text-green-600 hover:text-green-700 rounded-full transition-colors" 
                                    title="Mark as Done">
                                <span data-lucide="check" class="w-4 h-4 icon-dark-primary"></span>
                            </button>
                            <button onclick="event.stopPropagation(); window.handleAssignmentDelete('${assignment.id}')"
                                    class="delete-btn p-1 text-red-500 hover:text-red-700 rounded-full transition-colors" 
                                    title="Delete Assignment">
                                <span data-lucide="x" class="w-4 h-4 icon-dark-primary"></span>
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(itemWrap);
            });
            lucide.createIcons();
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdowns, 1000);
        };

        window.renderFinishedAssignments = (newFinished) => {
            finishedAssignments = newFinished;
            const list = document.getElementById('assignment-list-finished');
            const toggleBtn = document.getElementById('toggle-finished-assignments-btn');
            const chevronIcon = toggleBtn ? toggleBtn.querySelector('span[data-lucide="chevron-down"]') : null;
            const btnTextSpan = document.getElementById('finished-assignments-count');
            list.innerHTML = ''; 

            if (finishedAssignments.length === 0) {
                btnTextSpan.textContent = "Finished Assignments (0)";
                toggleBtn.disabled = true;
                list.innerHTML = '<p class="text-dark-tertiary text-center mt-4 text-sm">No finished assignments recorded.</p>';
                return;
            }
            toggleBtn.disabled = false;
            btnTextSpan.textContent = `Finished Assignments (${finishedAssignments.length})`;

            finishedAssignments.forEach(assignment => {
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const completedAtDate = assignment.completedAt instanceof Date ? assignment.completedAt : new Date(assignment.completedAt);
                const day = String(deadlineDate.getDate()).padStart(2, '0');
                const month = String(deadlineDate.getMonth() + 1).padStart(2, '0');
                const year = deadlineDate.getFullYear();
                const formattedDate = `${day}/${month}/${year}`;
                const completedDay = String(completedAtDate.getDate()).padStart(2, '0');
                const completedMonth = String(completedAtDate.getMonth() + 1).padStart(2, '0');
                const completedYear = completedAtDate.getFullYear();
                const item = document.createElement('div');
                item.className = 'finished-item-wrap flex justify-between items-center p-3 rounded-lg bg-white/50 backdrop-blur-sm shadow-sm transition-all duration-300 group'; 
                const formattedCompletedDate = `${completedDay}/${completedMonth}/${completedYear}`;

                item.innerHTML = `
                    <div class="finished-assignment-details min-w-0 flex-grow flex items-center justify-between">
                        <span class="title text-sm text-dark-secondary font-semibold truncate flex-shrink">
                            ${assignment.title}
                        </span>
                        <div class="flex flex-col items-end text-right text-dark-tertiary text-xs ml-4 flex-shrink-0">
                            <span class="date">Due: ${formattedDate}</span>
                            <span class="date mt-0.5">Completed: ${formattedCompletedDate}</span>
                        </div>
                    </div>
                    <button onclick="window.db.deleteFinishedAssignment('${assignment.id}')" 
                            class="delete-btn p-1 ml-2 flex-shrink-0 text-red-500 hover:text-red-700 rounded-full transition-colors opacity-0 group-hover:opacity-100" 
                            title="Delete Finished Assignment">
                        <span data-lucide="x" class="w-4 h-4 icon-dark-primary"></span>
                    </button>
                `;
                list.appendChild(item);
            });
            if (chevronIcon && list) {
                if (list.classList.contains('hidden')) chevronIcon.classList.remove('rotate-180');
                else chevronIcon.classList.add('rotate-180');
            }
            lucide.createIcons();
        };

        const updateCountdowns = () => {
            assignments.forEach(assignment => {
                const countdownEl = document.getElementById(`countdown-${assignment.id}`);
                if (!countdownEl) return;
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const remaining = getTimeRemaining(deadlineDate);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const deadlineDay = new Date(deadlineDate.getFullYear(), deadlineDate.getMonth(), deadlineDate.getDate());

                if (deadlineDay.getTime() === today.getTime()) { countdownEl.innerHTML = '<span class="text-green-400 font-semibold">Due Today</span>'; return; }
                if (deadlineDay.getTime() < today.getTime()) { countdownEl.innerHTML = '<span class="text-red-500 font-bold">Deadline Passed</span>'; return; }

                countdownEl.innerHTML = `<span class="font-bold">${remaining.days}</span>d <span class="font-bold">${remaining.hours}</span>h <span class="font-bold">${remaining.minutes}</span>m <span class="font-bold">${remaining.seconds}</span>s`;
            });
        };

        // --- ADD MODAL LOGIC (Simple) ---
        const openAssignmentModalUI = () => {
            document.getElementById('assignment-modal').classList.remove('opacity-0', 'pointer-events-none');
            // Reset "Add" inputs
            document.getElementById('assignment-title').value = '';
            document.getElementById('assignment-deadline-date').value = '';
            document.getElementById('assignment-deadline-time').value = ''; 
            document.getElementById('assignment-notes').value = '';
        };
        
        const closeAssignmentModal = () => {
            document.getElementById('assignment-modal').classList.add('opacity-0', 'pointer-events-none');
        };

        const handleAddAssignment = async () => {
            const title = document.getElementById('assignment-title').value.trim();
            const deadlineDateString = document.getElementById('assignment-deadline-date').value;
            const deadlineTimeString = document.getElementById('assignment-deadline-time').value;
            const notes = document.getElementById('assignment-notes').value.trim();
            
            if (!title || !deadlineDateString) { alert('Please provide an assignment title and a deadline date.'); return; }
            
            await window.db.addAssignment(title, deadlineDateString, deadlineTimeString, notes);
            closeAssignmentModal();
        };

        // --- DETAIL MODAL LOGIC (With Sub-tasks) ---
        let detailModal, detailIdInput, detailTitleInput, detailDeadlineDateInput, detailDeadlineTimeInput, detailNoteInput;
        let currentSubtasks = [];

        const renderSubtaskUI = () => {
            const container = document.getElementById('subtask-list-container');
            container.innerHTML = '';

            currentSubtasks.forEach((task, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center space-x-2 mb-2 animate-fadeIn';
                
                // 1. Checkbox (Green accent)
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.done;
                checkbox.className = "w-5 h-5 rounded border-gray-300 accent-green-500 cursor-pointer flex-shrink-0";
                checkbox.onchange = () => {
                    task.done = checkbox.checked;
                    renderSubtaskUI();
                };

                // 2. Text Input (Styled for Daniela)
                const input = document.createElement('input');
                input.type = 'text';
                input.value = task.text;
                input.placeholder = "Sub-task details...";
                
                // Green background if done, otherwise light gray
                const bgClass = task.done 
                    ? 'bg-green-50 text-green-700 border-green-200 line-through decoration-green-500/30' 
                    : 'bg-gray-50 text-dark-primary border-gray-200 focus:bg-white';
                
                input.className = `flex-1 p-2 rounded-lg border outline-none focus:border-pink-300 transition-all duration-300 ${bgClass}`;
                
                input.oninput = (e) => { task.text = e.target.value; };

                // 3. Delete Button
                const delBtn = document.createElement('button');
                delBtn.innerHTML = '<span data-lucide="x" class="w-4 h-4"></span>';
                delBtn.className = "text-red-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded-lg transition-colors flex-shrink-0";
                delBtn.onclick = () => {
                    currentSubtasks.splice(index, 1);
                    renderSubtaskUI();
                };

                row.appendChild(checkbox);
                row.appendChild(input);
                row.appendChild(delBtn);
                container.appendChild(row);
            });
            lucide.createIcons();
        };

        const addSubtask = () => {
            currentSubtasks.push({ text: '', done: false });
            renderSubtaskUI();
            
            // Auto-scroll logic
            const container = document.querySelector('#assignment-detail-modal .overflow-y-auto');
            setTimeout(() => {
                if(container) container.scrollTop = container.scrollHeight;
                const inputs = document.querySelectorAll('#subtask-list-container input[type="text"]');
                if(inputs.length > 0) inputs[inputs.length - 1].focus();
            }, 50);
        };

        // This replaces the old Open function
        window.openAssignmentDetailModal = (id, title, deadlineISO, notes) => {
            // Retrieve full assignment object to get subtasks
            const assignment = assignments.find(a => a.id === id);
            
            detailIdInput.value = id;
            detailTitleInput.value = title;
            
            if (deadlineISO) {
                const deadlineDate = new Date(deadlineISO);
                const yyyy = deadlineDate.getFullYear();
                const mm = String(deadlineDate.getMonth() + 1).padStart(2, '0');
                const dd = String(deadlineDate.getDate()).padStart(2, '0');
                const hh = String(deadlineDate.getHours()).padStart(2, '0');
                const min = String(deadlineDate.getMinutes()).padStart(2, '0');
                
                detailDeadlineDateInput.value = `${yyyy}-${mm}-${dd}`;
                detailDeadlineTimeInput.value = `${hh}:${min}`;
            } else {
                detailDeadlineDateInput.value = '';
                detailDeadlineTimeInput.value = '';
            }
            
            detailNoteInput.value = notes || '';

            // Load Subtasks
            currentSubtasks = assignment && assignment.subtasks ? JSON.parse(JSON.stringify(assignment.subtasks)) : [];
            renderSubtaskUI();

            detailModal.classList.remove('opacity-0', 'pointer-events-none');
        };

        const closeAssignmentDetailModal = () => {
            detailModal.classList.add('opacity-0', 'pointer-events-none');
            currentSubtasks = [];
        };

        const handleSaveDetailChanges = async () => {
            const dateString = detailDeadlineDateInput.value;
            const timeString = detailDeadlineTimeInput.value || null;
            if (!dateString) return; 

            await window.db.updateAssignment(
                detailIdInput.value, 
                detailTitleInput.value.trim(), 
                dateString, 
                timeString, 
                detailNoteInput.value,
                currentSubtasks
            );
            closeAssignmentDetailModal();
        };

        const handleDeleteFromDetail = async () => {
            if (confirm("Are you sure you want to delete this task?")) {
                await window.db.deleteAssignment(detailIdInput.value);
                closeAssignmentDetailModal();
            }
        };

        const openBookmarkModal = () => document.getElementById('bookmark-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBookmarkModal = () => document.getElementById('bookmark-modal').classList.add('opacity-0', 'pointer-events-none');

        const handleAddBookmark = async () => {
            const nameInput = document.getElementById('bookmark-name');
            const urlInput = document.getElementById('bookmark-url');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            const icon = 'link'; 
            if (!name || !url) { console.error('Validation Error: Please enter both a name and a URL.'); return; }
            try {
                const validUrl = url.startsWith('http://') || url.startsWith('https://') || url.startsWith('file:///') ? url : `https://${url}`;
                await window.db.addBookmark(name, validUrl, icon);
                nameInput.value = ''; urlInput.value = ''; closeBookmarkModal();
            } catch (error) { console.error("Failed to add bookmark:", error); }
        };
        
        const openBackgroundGalleryModal = () => document.getElementById('background-gallery-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBackgroundGalleryModal = () => {
            document.getElementById('background-image-file').value = ''; 
            document.getElementById('background-gallery-modal').classList.add('opacity-0', 'pointer-events-none');
        }

        // NEW UTILITY: Compress image to ensure it fits in Firestore (Limit ~1MB)
        const resizeAndCompressImage = (file, maxWidth = 1920, quality = 0.8) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions (maintain aspect ratio)
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Recursively reduce quality if file is still too big
                        const attemptCompression = (q) => {
                            const dataUrl = canvas.toDataURL('image/jpeg', q);
                            // Target < 1,000,000 characters for Base64 string
                            if (dataUrl.length > 1000000 && q > 0.1) {
                                attemptCompression(q - 0.1);
                            } else {
                                resolve(dataUrl);
                            }
                        };
                        attemptCompression(quality);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // FIXED: Compresses image and auto-selects the new background
        const handleAddBackground = async () => {
            const fileInput = document.getElementById('background-image-file');
            const file = fileInput.files[0];
            const fileNameInput = document.getElementById('background-file-name');
            const fileName = fileNameInput.value.trim() || file?.name;
            const btn = document.getElementById('add-background-btn');

            if (!file) { alert('Please select a file.'); return; }
            if (!file.type.startsWith('image/')) { alert('File must be an image.'); return; }

            // Visual Feedback
            const originalText = btn.textContent;
            btn.textContent = "Compressing & Uploading...";
            btn.disabled = true;

            try {
                // Use new compressor instead of raw fileToBase64
                const base64String = await resizeAndCompressImage(file);
                
                // Upload and get new ID
                const newId = await window.db.addBackground(base64String, fileName);
                
                if (newId) {
                    // Auto-select the new background
                    currentBackgroundId = newId;
                    localStorage.setItem(CURRENT_BG_KEY, newId);
                    
                    fileInput.value = ''; 
                    fileNameInput.value = '';
                }
            } catch (error) { 
                console.error("Failed to add background:", error); 
                alert("An error occurred during upload."); 
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        window.onload = () => {
            changeBackground(currentBackgroundId); 
            window.renderMCASTLinks(); 
            renderScheduleWidget(); 
            if (nextLessonInterval) clearInterval(nextLessonInterval);
            nextLessonInterval = setInterval(renderScheduleWidget, 1000); 

            document.getElementById('open-assignment-modal-btn').addEventListener('click', openAssignmentModalUI);
            document.getElementById('close-assignment-modal-btn').addEventListener('click', closeAssignmentModal);
            document.getElementById('add-assignment-btn').addEventListener('click', handleAddAssignment); 
            document.getElementById('bookmark-container').addEventListener('click', (e) => {
                if (e.target.closest('#open-bookmark-modal-btn')) openBookmarkModal();
            });
            document.getElementById('close-bookmark-modal-btn').addEventListener('click', closeBookmarkModal);
            document.getElementById('add-bookmark-btn').addEventListener('click', handleAddBookmark);
            document.getElementById('open-background-gallery-btn').addEventListener('click', openBackgroundGalleryModal);
            document.getElementById('close-background-gallery-modal-btn').addEventListener('click', closeBackgroundGalleryModal);
            document.getElementById('add-background-btn').addEventListener('click', handleAddBackground);
            document.getElementById('search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const query = document.getElementById('search-input').value;
                if (query) window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            });

            detailModal = document.getElementById('assignment-detail-modal');
            detailIdInput = document.getElementById('detail-assignment-id');
            detailTitleInput = document.getElementById('detail-assignment-title');
            detailDeadlineDateInput = document.getElementById('detail-assignment-deadline-date');
            detailDeadlineTimeInput = document.getElementById('detail-assignment-deadline-time');
            detailNoteInput = document.getElementById('detail-assignment-note');


            document.getElementById('close-detail-modal-btn').addEventListener('click', closeAssignmentDetailModal);
            document.getElementById('save-assignment-detail-btn').addEventListener('click', handleSaveDetailChanges);
            document.getElementById('delete-from-detail-btn').addEventListener('click', handleDeleteFromDetail);
            document.getElementById('add-subtask-btn').addEventListener('click', addSubtask);

            // CALENDAR EVENT LISTENERS (NEW)
            document.getElementById('open-calendar-btn').addEventListener('click', openCalendarModal);
            document.getElementById('calendar-modal').addEventListener('click', closeCalendarModal);
            
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });

            document.getElementById('today-btn').addEventListener('click', () => {
                currentCalendarDate = new Date();
                renderCalendar();
            });
        };

        const createDeadlineDate = (dateString, timeString) => {
            if (!dateString) return null;
            const time = timeString || '23:59'; 
            const [year, month, day] = dateString.split('-').map(Number);
            const [hours, minutes] = time.split(':').map(Number);
            const deadlineDate = new Date(year, month - 1, day, hours, minutes);
            if (isNaN(deadlineDate.getTime())) { console.error("Invalid Date components provided."); return null; }
            return deadlineDate;
        };

        const parseDeadlineISO = (isoString) => {
            if (!isoString) return null;
            try {
                const date = new Date(isoString);
                return isNaN(date) ? null : date;
            } catch (e) { console.error("Error parsing deadline ISO:", e); return null; }
        }
    </script>
</head>
<body class="bg-white">

    <div id="background-container"></div>

    <div class="scroll-container flex justify-center items-start lg:items-center">

        <div class="grid grid-cols-1 lg:grid-cols-7 gap-8 w-full max-w-7xl pt-16 lg:pt-0 pb-16">

            <div class="lg:col-span-2 p-6 bg-white/70 rounded-3xl backdrop-blur-xl shadow-2xl h-fit border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-dark-primary flex items-center">
                        <span data-lucide="graduation-cap" class="w-6 h-6 mr-2 text-red-600 icon-dark-primary"></span>
                        UoM Links
                    </h2>
                    </div>
                <div id="mcast-link-list" class="space-y-3">
                    </div>
            </div>

            <div class="lg:col-span-3 flex flex-col items-center justify-center p-6 space-y-8">
                
                <div id="next-lesson-widget" class="w-full max-w-2xl p-4 bg-white/70 rounded-xl backdrop-blur-md shadow-lg border border-gray-100">
                    <p class="text-dark-tertiary text-center">Loading timetable...</p>
                </div>
                <form id="search-form" class="w-full max-w-2xl relative">
                    <input type="text" id="search-input" placeholder="Search Google or type a URL..."
                            class="w-full p-4 pl-12 bg-white/90 text-dark-primary border-2 border-transparent focus:border-pink-400 rounded-full shadow-lg outline-none transition-all duration-300"
                            autofocus>
                    <span data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-dark-secondary icon-dark-primary"></span>
                    <button type="submit" class="hidden">Search</button>
                </form>

                <div id="bookmark-container" class="grid grid-cols-4 gap-4 sm:gap-6 p-4 rounded-3xl bg-white/50 backdrop-blur-md shadow-inner max-w-2xl w-full border border-gray-100">
                    </div>

                <div class="flex justify-center w-full">
                    <button id="open-background-gallery-btn"
                            class="flex items-center text-sm text-dark-secondary hover:text-dark-primary transition-colors p-3 rounded-full bg-white/70 hover:bg-white/90 border border-gray-100">
                        <span data-lucide="gallery-vertical" class="w-4 h-4 mr-2 icon-dark-primary"></span>
                        Manage Backgrounds
                    </button>
                </div>

                <p id="user-id-display" class="text-xs text-dark-tertiary mt-4"></p>
            </div>

            <div class="lg:col-span-2 p-6 bg-white/70 rounded-3xl backdrop-blur-xl shadow-2xl h-fit border border-gray-100">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-bold text-dark-primary flex items-center">
                    <button id="open-calendar-btn" class="hover:bg-gray-0 rounded-lg p-1 transition-all duration-200 group mr-1" title="Open Calendar View">
                        <span data-lucide="clipboard-list" class="w-6 h-6 text-pink-400 group-hover:scale-110 transition-transform"></span>
                    </button>
                     Upcoming Assignments
                 </h2>
                 <button id="open-assignment-modal-btn"
                         class="w-8 h-8 flex items-center justify-center bg-pink-300 text-white rounded-full shadow-lg hover:bg-pink-400 transition-transform transform hover:scale-110"
                         title="Add New Assignment">
                     <span data-lucide="plus" class="w-5 h-5 icon-dark-primary"></span>
                 </button>
             </div>

                <div id="assignment-list" class="space-y-3 max-h-96 overflow-y-auto scroll-container pr-2"> </div>
 
                <div class="pt-4 border-t border-gray-300">
                    <button id="toggle-finished-assignments-btn"
                            class="w-full mt-4 flex items-center justify-center p-2 rounded-xl bg-gray-100/70 text-dark-secondary hover:bg-gray-200/90 hover:text-dark-primary transition-colors"
                            title="Show/Hide Completed Assignments"
                            onclick="document.getElementById('assignment-list-finished').classList.toggle('hidden'); this.querySelector('span:first-child').classList.toggle('rotate-180')">
                        <span data-lucide="chevrons-down" class="w-4 h-4 mr-2 transition-transform transform"></span>
                        <span id="finished-assignments-count">Finished Assignments (0)</span>
                    </button>
                    
                    <div id="assignment-list-finished" class="space-y-3 mt-4 hidden max-h-20 overflow-y-auto scroll-container pr-2">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="assignment-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-dark-primary mb-6">Add New Assignment</h3>
            <div class="space-y-4">
                <input type="text" id="assignment-title" placeholder="Assignment Title"
                    class="w-full p-3 rounded-xl bg-gray-100 text-dark-primary placeholder-dark-tertiary border border-gray-300 focus:border-green-500 outline-none transition-colors">
                
               <div class="flex space-x-2">
                    <input type="date" id="assignment-deadline-date"
                        class="w-1/2 p-3 rounded-xl bg-gray-100 text-dark-primary placeholder-dark-tertiary border border-gray-300 focus:border-green-500 outline-none transition-colors">
                    
                    <input type="time" id="assignment-deadline-time"
                        class="w-1/2 p-3 rounded-xl bg-gray-100 text-dark-primary placeholder-dark-tertiary border border-gray-300 focus:border-green-500 outline-none transition-colors">
                </div>
                                
                <textarea id="assignment-notes" placeholder="Optional notes..." rows="3"
                    class="w-full p-3 rounded-xl bg-gray-100 text-dark-primary placeholder-dark-tertiary border border-gray-300 focus:border-green-500 outline-none resize-none transition-colors"></textarea>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-assignment-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-300 text-dark-primary hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
                <button id="add-assignment-btn"
                        class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">
                    Save Assignment
                </button>
            </div>
        </div>
    </div>

    <div id="assignment-detail-modal"
         class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg border border-gray-200 transform transition-all duration-300 scale-100 flex flex-col max-h-[85vh]">
            
            <div class="p-6 pb-2 flex-shrink-0">
                <h3 class="text-2xl font-bold text-dark-primary">Task Details</h3>
            </div>
            
            <div class="p-6 pt-2 overflow-y-auto custom-scroll space-y-4 flex-grow">
                <input type="hidden" id="detail-assignment-id">
                
                <div>
                    <label class="block text-dark-secondary text-sm font-semibold mb-1">Title</label>
                    <input type="text" id="detail-assignment-title" 
                           class="w-full p-3 rounded-xl bg-gray-50 text-dark-primary border border-gray-200 focus:border-pink-300 outline-none transition-colors">
                </div>
                
                <div>
                    <label class="block text-dark-secondary text-sm font-semibold mb-1">Deadline</label>
                    <div class="flex space-x-2">
                        <input type="date" id="detail-assignment-deadline-date" 
                               class="w-1/2 p-3 rounded-xl bg-gray-50 text-dark-primary border border-gray-200 focus:border-pink-300 outline-none transition-colors">
                        <input type="time" id="detail-assignment-deadline-time" 
                               class="w-1/2 p-3 rounded-xl bg-gray-50 text-dark-primary border border-gray-200 focus:border-pink-300 outline-none transition-colors">
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-dark-secondary text-sm font-semibold">Sub-tasks</label>
                        <button id="add-subtask-btn" 
                                class="flex items-center text-xs bg-pink-100 hover:bg-pink-200 text-pink-700 px-3 py-1.5 rounded-lg transition-colors border border-pink-200 shadow-sm">
                            <span data-lucide="plus" class="w-3 h-3 mr-1"></span> Add
                        </button>
                    </div>
                    
                    <div id="subtask-list-container" class="flex flex-col w-full">
                        </div>
                </div>

                <div>
                    <label class="block text-dark-secondary text-sm font-semibold mb-1">Notes</label>
                    <textarea id="detail-assignment-note" rows="4" 
                              class="w-full p-3 rounded-xl bg-gray-50 text-dark-primary border border-gray-200 focus:border-pink-300 outline-none resize-none transition-colors"></textarea>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 bg-gray-50 rounded-b-2xl flex-shrink-0">
                <div class="flex justify-between space-x-4">
                    <button id="delete-from-detail-btn" 
                            class="px-4 py-2 rounded-xl bg-red-100 text-red-600 hover:bg-red-200 font-semibold transition-colors text-sm border border-red-200">
                        Delete Task
                    </button>
                    <div class="flex space-x-3">
                        <button id="close-detail-modal-btn" 
                                class="px-4 py-2 rounded-xl bg-gray-200 text-dark-primary hover:bg-gray-300 transition-colors text-sm">
                            Cancel
                        </button>
                        <button id="save-assignment-detail-btn" 
                                class="px-4 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors text-sm shadow-md">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="bookmark-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-dark-primary mb-6">Add New Bookmark</h3>
            <div class="space-y-4">
                <input type="text" id="bookmark-name" placeholder="Name (e.g., Google News)"
                        class="w-full p-3 rounded-xl bg-gray-100 text-dark-primary placeholder-dark-tertiary border border-gray-300 focus:border-blue-500 outline-none transition-colors">
                <input type="url" id="bookmark-url" placeholder="URL (e.g., https://news.google.com)"
                        class="w-full p-3 rounded-xl bg-gray-100 text-dark-primary placeholder-dark-tertiary border border-gray-300 focus:border-blue-500 outline-none transition-colors">
                </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-bookmark-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-300 text-dark-primary hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
                <button id="add-bookmark-btn"
                        class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">
                    Save Bookmark
                </button>
            </div>
        </div>
    </div>

    <div id="background-gallery-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-4xl border border-gray-200 transform transition-all duration-300 scale-100 h-5/6 flex flex-col">
            <h3 class="text-2xl font-bold text-dark-primary mb-6 flex items-center">
                <span data-lucide="gallery-vertical" class="w-6 h-6 mr-2 icon-dark-primary"></span>
                Manage Your Backgrounds
            </h3>

            <div class="flex-grow overflow-y-auto pr-2 mb-6 space-y-4">
                <h4 class="text-lg font-semibold text-dark-primary mb-3 border-b border-gray-300 pb-2">Select or Delete</h4>
                <div id="background-gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    <p class="text-dark-tertiary text-center col-span-full">Loading backgrounds...</p>
                </div>
                
                <h4 class="text-lg font-semibold text-dark-primary mb-3 pt-6 border-t border-gray-300 pt-4">Add New Background</h4>
                
                <div class="space-y-4">
                     <p class="text-sm text-dark-secondary">Upload an image file (e.g., JPG, PNG). Max size: 2MB.</p>
                    <input type="text" id="background-file-name" placeholder="Optional: Give this background a name"
                            class="w-full p-3 rounded-xl bg-gray-100 text-dark-primary placeholder-dark-tertiary border border-gray-300 focus:border-blue-500 outline-none transition-colors">
                    <input type="file" id="background-image-file" accept="image/*"
                            class="w-full text-dark-secondary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-auto border-t border-gray-300 pt-4">
                 <button id="close-background-gallery-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-300 text-dark-primary hover:bg-gray-400 transition-colors">
                    Close Gallery
                </button>
                <button id="add-background-btn"
                        class="px-5 py-2 rounded-xl bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors">
                    Upload Image
                </button>
            </div>
        </div>
    </div>
    
    <div id="weekly-timetable-modal" class="fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 pointer-events-none transition duration-300 z-50">
        <div class="w-auto max-w-[95vw] p-6 rounded-2xl shadow-2xl border border-gray-200 overflow-x-auto overflow-y-hidden relative custom-scroll"
             style="background-image: url('images/flowerBG.jpg'); background-size: cover; background-position: center;">
            <h2 class="text-2xl font-bold text-dark-primary mb-4 text-center sticky left-0 bg-white/80 backdrop-blur-md rounded-xl py-2 shadow-sm border border-white/50">
                Weekly Timetable
            </h2>
            <div id="weekly-timetable-content" class="flex flex-row gap-6 pb-4"></div>
        </div>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300 z-50">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl border border-gray-200 flex flex-col max-h-[90vh]">
            
            <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gray-50/50 rounded-t-2xl" style="background-image: url('images/flowersLily.png'); background-size: cover;">
                <h3 id="calendar-month-year" class="text-2xl font-bold text-dark-primary capitalize">December 2025</h3>
                <div class="flex space-x-2">
                    <button id="prev-month-btn" class="p-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-100 text-dark-secondary transition-colors">
                        <span data-lucide="chevron-left" class="w-5 h-5"></span>
                    </button>
                    <button id="today-btn" class="px-4 py-2 rounded-lg bg-pink-400 hover:bg-pink-500 text-white text-sm font-semibold transition-colors">
                        Today
                    </button>
                    <button id="next-month-btn" class="p-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-100 text-dark-secondary transition-colors">
                        <span data-lucide="chevron-right" class="w-5 h-5"></span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-7 bg-pink-100 border-b border-gray-200">
                <div class="p-3 text-center text-dark-secondary font-semibold text-sm">Mon</div>
                <div class="p-3 text-center text-dark-secondary font-semibold text-sm">Tue</div>
                <div class="p-3 text-center text-dark-secondary font-semibold text-sm">Wed</div>
                <div class="p-3 text-center text-dark-secondary font-semibold text-sm">Thu</div>
                <div class="p-3 text-center text-dark-secondary font-semibold text-sm">Fri</div>
                <div class="p-3 text-center text-Scrodark-secondary font-semibold text-sm">Sat</div>
                <div class="p-3 text-center text-Scrodark-secondary font-semibold text-sm">Sun</div>
            </div>

            <div id="calendar-grid" class="grid grid-cols-7 auto-rows-fr gap-px bg-pink-200 overflow-y-auto custom-scroll p-px">
                </div>
        </div>
    </div>

    <button id="open-weekly-timetable-btn"
        class="fixed bottom-5 left-5 z-50 p-3 rounded-xl bg-white/80 backdrop-blur-md border border-gray-200 shadow-lg hover:bg-white hover:scale-105 transition flex items-center justify-center group">
        <span data-lucide="calendar-range" class="w-6 h-6 text-dark-primary group-hover:text-blue-600 transition-colors"></span>
    </button>

    <div id="version-timestamp" class="text-dark-secondary">Last Update 20/01/2026 - 22:24</div>
    </body>

    <style>
        .custom-scroll::-webkit-scrollbar { height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(74, 44, 44, 0.2); border-radius: 4px; } 
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(74, 44, 44, 0.4); }
    </style>
    <script>
            document.getElementById('open-weekly-timetable-btn').addEventListener('click', () => {
                const modal = document.getElementById("weekly-timetable-modal");
                const content = document.getElementById("weekly-timetable-content");
                const formatLesson = (item, highlight) => {
                    let baseClasses = "p-3 rounded-lg mb-2 transition-all duration-300 border shadow-sm";
                    let bgClass, textTitleClass, subTextClass;
                    if (highlight) {
                        if (item.title === "BREAK") { bgClass = 'bg-pink-100 border-pink-300 ring-2 ring-pink-200'; textTitleClass = 'text-pink-800'; subTextClass = 'text-pink-700'; } 
                        else { bgClass = 'bg-pink-100 border-pink-300 ring-2 ring-pink-200'; textTitleClass = 'text-pink-800'; subTextClass = 'text-pink-700'; }
                    } else if (item.title === "END OF DAY" || item.title === "WEEKEND") { bgClass = 'bg-gray-100 border-transparent opacity-60'; textTitleClass = 'text-gray-500 font-normal italic'; subTextClass = 'text-gray-400'; } 
                    else { bgClass = 'bg-white border-gray-200 hover:border-blue-300'; textTitleClass = 'text-dark-primary'; subTextClass = 'text-dark-secondary'; }
                    return `
                    <div class="${baseClasses} ${bgClass}">
                        <p class="font-semibold ${textTitleClass} text-sm">${item.title}</p>
                        <p class="${subTextClass} text-xs mt-1">${item.start} - ${item.end}</p>
                        <p class="${subTextClass} text-xs opacity-70">${item.location ?? ''}</p>
                    </div>`;
                };
                content.innerHTML = "";
                const now = new Date();
                const dayIndex = now.getDay();
                const nowMinutes = now.getHours() * 60 + now.getMinutes();
                for (const day of DAYS_OF_WEEK) {
                    const lessons = TIMETABLE[day];
                    if(!lessons) continue;
                    let html = `
                    <div class="min-w-[260px] w-[260px] flex-shrink-0 bg-white/80 p-4 rounded-xl border border-gray-200 backdrop-blur-md">
                        <h3 class="text-lg font-bold text-dark-primary mb-4 border-b border-gray-200 pb-2 text-center uppercase tracking-wider">${day}</h3>
                        <div class="space-y-2">`;
                    lessons.forEach(item => {
                        const start = timeToMinutes(item.start);
                        const end = timeToMinutes(item.end);
                        const isCurrent = day === DAYS_OF_WEEK[dayIndex] && nowMinutes >= start && nowMinutes < end && item.title !== "WEEKEND";
                        html += formatLesson(item, isCurrent);
                    });
                    html += "</div></div>";
                    content.innerHTML += html;
                }
                modal.classList.remove("opacity-0", "pointer-events-none");
            });
            document.getElementById("weekly-timetable-modal").addEventListener('click', (e) => {
                 if (e.target === e.currentTarget) e.currentTarget.classList.add("opacity-0", "pointer-events-none");
            });
    </script>
</html>