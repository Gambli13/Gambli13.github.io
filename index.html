<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="images/redchrome.ico">
    <title>New Tab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font and base styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        #background-container {
            background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 1 1\'%3E%3Crect width=\'1\' height=\'1\' fill=\'%230f172a\'/%3E%3C/svg%3E'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: background-image 1s ease-in-out;
        }
        .scroll-container {
            overflow-y: auto;
            height: 100vh;
            padding: 20px;
        }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }

        .bookmark-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .bookmark-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            border-color: #3b82f6;
        }
        
        .bookmark-favicon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.8));
        }

        .mcast-link-item {
            transition: background-color 0.3s, transform 0.3s;
            cursor: pointer;
        }
        .mcast-link-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .assignment-item:hover .delete-btn,
        .bookmark-item-wrap:hover .delete-btn {
            opacity: 1;
        }
        .assignment-item {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .background-thumbnail {
            width: 100%;
            padding-top: 56.25%;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s, opacity 0.3s;
        }
        .background-thumbnail:hover {
            border-color: #3b82f6;
            opacity: 0.8;
        }
        .background-thumbnail.selected {
            border-color: #10b981;
            border-width: 4px;
        }

        #version-timestamp {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 6px;
            backdrop-filter: blur(5px);
        }

        .assignment-item-done {
            position: relative;
            z-index: 1;
            transition: opacity 0.5s ease-out, height 0.5s ease-out, padding 0.5s ease-out, margin 0.5s ease-out;
        }
        .assignment-item-done::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            z-index: -1;
        }
        .assignment-item.swipe-to-delete {
            opacity: 0;
            height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
        .assignment-item-done.swipe-active::before {
            width: 100%;
        }
        
        .finished-assignment-text {
            color: rgba(255, 255, 255, 0.5);
            text-decoration: line-through;
        }
    </style>

    <script>
        const LOCAL_FIREBASE_CONFIG_JSON = JSON.stringify({
           apiKey: "AIzaSyDRYcVVOg_yzTbYQnBj7TxghX-2rNT3f3g",
           authDomain: "personalment-c1a9c.firebaseapp.com",
           projectId: "personalment-c1a9c",
           storageBucket: "personalment-c1a9c.firebasestorage.app",
           messagingSenderId: "461177689665",
           appId: "1:461177689665:web:bddc74fe94c21c097d18c0",
           measurementId: "G-RC5MS7QBNK"
        });
        const LOCAL_AUTH_TOKEN = null; 
    </script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, addDoc, deleteDoc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const STATIC_OVERRIDE_USER_ID = 'zNllEXqmHpaqNZffrgOhyPrSfBB3';
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const configSource = typeof __firebase_config !== 'undefined' ? __firebase_config : LOCAL_FIREBASE_CONFIG_JSON;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : LOCAL_AUTH_TOKEN;
    const firebaseConfig = JSON.parse(configSource);
    
    let db, auth, userId = null;
    let isAuthReady = false;

    setLogLevel('debug');

    const getCollectionPath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}_index`;

    const initFirebase = async () => {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken).catch(e => signInAnonymously(auth));
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                userId = STATIC_OVERRIDE_USER_ID; 
                isAuthReady = true;
                console.log("Firebase Auth Ready. User ID:", userId);
                setupDataListeners();
                document.getElementById('user-id-display').textContent = `Static User ID: ${userId}`;
            });

        } catch (error) {
            console.error("Firebase Initialization failed, falling back to Mock Mode:", error);
            window.setupMockData(); 
        }
    };

    const setupDataListeners = () => {
        if (!db || !userId) return;

        // 1. Assignments Listener
        onSnapshot(collection(db, getCollectionPath('assignments')), (snapshot) => {
            const assignments = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                let deadlineDate;
                if (data.deadline && typeof data.deadline.toDate === 'function') {
                    deadlineDate = data.deadline.toDate();
                } else if (data.deadline) {
                    deadlineDate = new Date(data.deadline);
                } else {
                    deadlineDate = null;
                }
                assignments.push({ id: doc.id, ...data, deadline: deadlineDate });
            });
            assignments.sort((a, b) => (a.deadline || 0) - (b.deadline || 0));
            window.renderAssignments(assignments);
        });

        // 2. Bookmarks Listener
        onSnapshot(collection(db, getCollectionPath('bookmarks')), (snapshot) => {
            const bookmarks = [];
            snapshot.forEach(doc => {
                bookmarks.push({ id: doc.id, ...doc.data() });
            });
            window.renderBookmarks(bookmarks);
        });
        
        // 3. Backgrounds Listener
        onSnapshot(collection(db, getCollectionPath('backgrounds')), (snapshot) => {
            const userBackgrounds = [];
            snapshot.forEach(doc => {
                userBackgrounds.push({ id: doc.id, name: doc.data().name || 'Background', base64: doc.data().base64 });
            });
            window.setUserBackgrounds(userBackgrounds);
            window.renderBackgroundGallery(userBackgrounds);
        });
        
        // 4. Finished Assignments Listener
        onSnapshot(collection(db, getCollectionPath('finished_assignments')), (snapshot) => {
            const finished = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                let deadlineDate;
                if (data.deadline && typeof data.deadline.toDate === 'function') {
                    deadlineDate = data.deadline.toDate();
                } else if (data.deadline) {
                    deadlineDate = new Date(data.deadline);
                } else {
                    deadlineDate = null;
                }
                let completedAtDate = data.completedAt ? new Date(data.completedAt) : new Date();
                finished.push({ id: doc.id, ...data, deadline: deadlineDate, completedAt: completedAtDate });
            });
            finished.sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));
            window.renderFinishedAssignments(finished);
        });
    };

    window.db = {
        addAssignment: async (title, deadlineDate) => {
            if (!db || !userId) return;
            try {
                await addDoc(collection(db, getCollectionPath('assignments')), {
                    title: title,
                    deadline: deadlineDate.toISOString(), 
                    createdAt: new Date().toISOString(),
                    notes: '' 
                });
            } catch (e) { console.error(e); }
        },
        updateAssignment: async (id, title, deadlineDate, notes) => {
            if (!db || !userId) return;
            try {
                const deadlineISO = deadlineDate instanceof Date && !isNaN(deadlineDate) ? deadlineDate.toISOString() : null;
                await setDoc(doc(db, getCollectionPath('assignments'), id), {
                    title: title,
                    deadline: deadlineISO, 
                    notes: notes || '',
                }, { merge: true });
            } catch (e) { console.error(e); }
        },
        deleteAssignment: async (id) => {
            if (!db || !userId) return;
            try { await deleteDoc(doc(db, getCollectionPath('assignments'), id)); } catch (e) { console.error(e); }
        },
        addFinishedAssignment: async (assignmentData) => {
            if (!db || !userId) return;
            try {
                await addDoc(collection(db, getCollectionPath('finished_assignments')), {
                    ...assignmentData,
                    deadline: assignmentData.deadline instanceof Date ? assignmentData.deadline.toISOString() : assignmentData.deadline,
                    completedAt: new Date().toISOString()
                });
            } catch (e) { console.error(e); }
        },
        deleteFinishedAssignment: async (id) => {
            if (!db || !userId) return;
            try { await deleteDoc(doc(db, getCollectionPath('finished_assignments'), id)); } catch (e) { console.error(e); }
        },
        addBookmark: async (name, url, icon) => {
            if (!db || !userId) return;
            try {
                await addDoc(collection(db, getCollectionPath('bookmarks')), { name, url, icon });
            } catch (e) { console.error(e); }
        },
        deleteBookmark: async (id) => {
            if (!db || !userId) return;
            try { await deleteDoc(doc(db, getCollectionPath('bookmarks'), id)); } catch (e) { console.error(e); }
        },
        addBackground: async (base64String, fileName) => {
            if (!db || !userId) return;
            try {
                await addDoc(collection(db, getCollectionPath('backgrounds')), {
                    base64: base64String, name: fileName, uploadedAt: new Date().toISOString()
                });
            } catch (e) { console.error(e); }
        },
        deleteBackground: async (id) => {
            if (!db || !userId) return;
            try { await deleteDoc(doc(db, getCollectionPath('backgrounds'), id)); } catch (e) { console.error(e); }
        },
    };

    initFirebase();
</script>

    <script>
        let USER_BACKGROUNDS = [];
        const CURRENT_BG_KEY = 'currentBackgroundId';
        let currentBackgroundId = localStorage.getItem(CURRENT_BG_KEY) || null;
        let backgroundContainer;

        window.setUserBackgrounds = (newBackgrounds) => {
            USER_BACKGROUNDS = newBackgrounds;
            const isCurrentValid = USER_BACKGROUNDS.some(bg => bg.id === currentBackgroundId);
            if (!isCurrentValid && USER_BACKGROUNDS.length > 0) {
                 currentBackgroundId = USER_BACKGROUNDS[0].id;
                 localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);
            } else if (USER_BACKGROUNDS.length === 0) {
                 currentBackgroundId = null;
                 localStorage.removeItem(CURRENT_BG_KEY);
            }
            changeBackground(currentBackgroundId);
        }

        const changeBackground = (backgroundId) => {
            if (!backgroundContainer) backgroundContainer = document.getElementById('background-container');
            const selectedBackground = USER_BACKGROUNDS.find(bg => bg.id === backgroundId);
            if (selectedBackground) {
                currentBackgroundId = selectedBackground.id;
                localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);
                backgroundContainer.style.backgroundImage = `url('${selectedBackground.base64}')`;
            } else {
                currentBackgroundId = null;
                localStorage.removeItem(CURRENT_BG_KEY);
                backgroundContainer.style.backgroundImage = `url('data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 1 1\\'%3E%3Crect width=\\'1\\' height=\\'1\\' fill=\\'%230f172a\\'/%3E%3C/svg%3E')`; 
            }
        };

        window.renderBackgroundGallery = (userBackgrounds) => {
            const galleryContainer = document.getElementById('background-gallery-grid');
            galleryContainer.innerHTML = ''; 
            if (userBackgrounds.length === 0) {
                 galleryContainer.innerHTML = '<p class="text-white/50 text-center col-span-full">No backgrounds uploaded yet. Use the form below to add one!</p>';
                 return;
            }
            userBackgrounds.forEach(bg => {
                const isSelected = bg.id === currentBackgroundId;
                const item = document.createElement('div');
                item.className = 'relative group';
                item.innerHTML = `
                    <div class="background-thumbnail rounded-xl overflow-hidden shadow-lg border-2" 
                         style="background-image: url('${bg.base64}');" data-bg-id="${bg.id}" title="Click to select: ${bg.name}"></div>
                    <span class="absolute top-2 left-2 px-2 py-1 bg-black/50 text-white text-xs rounded-full opacity-80">${bg.name}</span>
                    <button onclick="window.db.deleteBackground('${bg.id}')"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-opacity opacity-0 group-hover:opacity-100" title="Delete Background">
                        <span data-lucide="x" class="w-4 h-4"></span>
                    </button>
                `;
                item.querySelector('.background-thumbnail').addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-bg-id');
                    changeBackground(id); 
                    document.querySelectorAll('.background-thumbnail').forEach(el => el.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                });
                if (isSelected) item.querySelector('.background-thumbnail').classList.add('selected');
                galleryContainer.appendChild(item);
            });
            lucide.createIcons(); 
        }

        // Mock Data Setup
        window.setupMockData = () => {
            // Mock Bookmarks
            window.renderBookmarks([
                { id: 'bm1', name: "Gemini", url: "https://gemini.google.com/", icon: "sparkles" },
                { id: 'bm2', name: "GitHub", url: "https://github.com/", icon: "code" },
                { id: 'bm4', name: "Mail", url: "https://mail.google.com/", icon: "mail" },
            ]);

            // Mock Assignments 
            let assignments = [
                { id: 'mock1', title: 'Database Design Exam (Mock)', deadline: new Date(new Date().getTime() + 86400000), createdAt: new Date(), notes: '' },
                { id: 'mock2', title: 'Physics Lab Report (Mock)', deadline: new Date(new Date().getTime() + 7 * 86400000), createdAt: new Date(), notes: '' },
            ];
            window.renderAssignments(assignments);
            
            // Mock Finished
            window.renderFinishedAssignments([
                 { id: 'mockDone1', title: 'Calculus Midterm (Mock)', deadline: new Date(), completedAt: new Date() }
            ]);

            // Mock Backgrounds
            let backgrounds = [{ id: 'bg1', name: 'Mock Sunset', base64: 'https://placehold.co/1920x1080/1e3a8a/bfdbfe?text=MOCK+BACKGROUND' }];
            window.setUserBackgrounds(backgrounds);
            window.renderBackgroundGallery(backgrounds);
            
            window.renderMCASTLinks();
            renderScheduleWidget();
            setInterval(renderScheduleWidget, 1000); 

            // Local Override for Mock Logic
            window.db = {
                addAssignment: (title, deadlineDate) => {
                    assignments.push({ id: crypto.randomUUID(), title: `${title} (Mock)`, deadline: deadlineDate, createdAt: new Date(), notes: '' });
                    window.renderAssignments(assignments);
                },
                updateAssignment: (id, title, deadlineDate, notes) => { /* Update logic omitted for brevity in mock */ },
                deleteAssignment: (id) => {
                    assignments = assignments.filter(a => a.id !== id);
                    window.renderAssignments(assignments);
                },
                addFinishedAssignment: (assignmentData) => {
                    assignments = assignments.filter(a => a.id !== assignmentData.id);
                    window.renderAssignments(assignments);
                    window.renderFinishedAssignments([...window.finishedAssignments || [], { ...assignmentData, id: crypto.randomUUID() }]);
                },
                deleteFinishedAssignment: (id) => { /* */ },
                addBookmark: (name, url, icon) => { /* */ },
                deleteBookmark: (id) => { /* */ },
                addBackground: (b, n) => { /* */ },
                deleteBackground: (id) => { /* */ }
            };
        };

        // --- Timetable Data ---
        const TIMETABLE = {
            Monday: [
                { start: "08:30", end: "10:00", title: "Statistics for Computer Science", location: "ICT-B03" },
                { start: "10:00", end: "11:30", title: "BREAK", location: null },
                { start: "11:30", end: "13:00", title: "Systems Programming", location: "ICT-209" },
                { start: "13:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Tuesday: [
                { start: "08:00", end: "10:00", title: "Image Processing and Computer Vision", location: "ICT-103" },
                { start: "10:00", end: "12:00", title: "BREAK", location: null },
                { start: "12:00", end: "14:00", title: "Data Structures And Algorithms II", location: "ICT-309" },
                { start: "14:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Wednesday: [
                { start: "07:00", end: "15:30", title: "MITA Work", location: null },
                { start: "15:30", end: "23:59", title: "FREE", location: null },
            ],
            Thursday: [
                { start: "10:30", end: "12:30", title: "Systems Programming", location: "ICT-B02" },
                { start: "12:30", end: "14:00", title: "Data Structures And Algorithms II", location: "ICT-209" },
                { start: "14:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Friday: [
                { start: "08:30", end: "10:30", title: "Statistics for Computer Science", location: "ICT-B05" },
                { start: "10:30", end: "12:00", title: "Image Processing and Computer Vision", location: "ICT-103" },
                { start: "12:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Saturday: [{ start: "08:00", end: "23:59", title: "WEEKEND", location: null }],
            Sunday: [{ start: "00:00", end: "23:59", title: "WEEKEND", location: null }]
        };
        const DAYS_OF_WEEK = ["Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let nextLessonInterval;

        const timeToMinutes = (time) => {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        const getNextScheduleItem = () => {
            const now = new Date();
            const dayIndex = now.getDay();
            const currentDayName = DAYS_OF_WEEK[dayIndex];
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            let todaySchedule = TIMETABLE[currentDayName];
            
            let currentItem = todaySchedule.find(item => 
                 timeToMinutes(item.start) <= nowMinutes && timeToMinutes(item.end) > nowMinutes
            );

            if (currentItem && currentItem.title !== "END OF DAY" && currentItem.title !== "WEEKEND") {
                 let nextItem = todaySchedule.find(item => timeToMinutes(item.start) === timeToMinutes(currentItem.end));
                 if (nextItem) {
                     return {
                        ...currentItem, 
                        day: currentDayName, isCurrent: true, 
                        nextTitle: nextItem.title, nextLocation: nextItem.location, nextStart: nextItem.start, nextEnd: nextItem.end,
                        remainingMinutes: timeToMinutes(currentItem.end) - nowMinutes, 
                        remainingSeconds: (timeToMinutes(currentItem.end) * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()),
                    };
                 }
            }

            let nextItem = todaySchedule.find(item => timeToMinutes(item.start) > nowMinutes);
            if (nextItem && nextItem.title !== "END OF DAY") {
                return {
                    ...nextItem, day: currentDayName,
                    remainingMinutes: timeToMinutes(nextItem.start) - nowMinutes,
                    remainingSeconds: (timeToMinutes(nextItem.start) * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()),
                    isCurrent: false
                };
            }

            for (let i = 1; i <= 7; i++) {
                const nextDayIndex = (dayIndex + i) % 7;
                const nextDayName = DAYS_OF_WEEK[nextDayIndex];
                const nextDaySchedule = TIMETABLE[nextDayName];
                const firstEvent = nextDaySchedule.find(item => item.title !== "END OF DAY" && item.title !== "WEEKEND");
                if (firstEvent) {
                     let remainingDaySeconds = (24 * 60 * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds());
                     let totalSeconds = remainingDaySeconds;
                     for(let j = 1; j < i; j++) totalSeconds += 24 * 60 * 60;
                     totalSeconds += timeToMinutes(firstEvent.start) * 60;
                     
                     return {
                        ...firstEvent, day: nextDayName, remainingMinutes: Math.ceil(totalSeconds / 60), remainingSeconds: totalSeconds, isNextDay: true
                    };
                }
            }
            return { title: "Schedule Error", start: null, end: null, location: null, remainingMinutes: 0, remainingSeconds: 0 };
        };

        const renderScheduleWidget = () => {
            const widgetEl = document.getElementById('next-lesson-widget');
            if (!widgetEl) return;
            const nextItem = getNextScheduleItem();
            let { title, start, end, location, remainingSeconds, day, isNextDay, isCurrent, nextTitle } = nextItem; 
            
            const totalSeconds = remainingSeconds;
            const days = Math.floor(totalSeconds / (60 * 60 * 24));
            const hours = Math.floor((totalSeconds % (60 * 60 * 24)) / (60 * 60));
            const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);

            let countdownHTML;
            let icon = "calendar";
            let statusClass = "text-blue-300";
            let subText = `Next Up: <span class="font-bold text-white">${title}</span>`;
            let timeRangeToDisplay = '';
            let locationPrefix = 'Location: ';

            if (isCurrent && totalSeconds > 0) {
                 statusClass = title === "BREAK" ? "text-green-300" : "text-purple-300";
                 icon = title === "BREAK" ? "coffee" : "hourglass";
                 subText = `Currently in: <span class="font-bold text-white">${title}</span>`;
                 countdownHTML = `<span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m left`;
                 timeRangeToDisplay = `${start} - ${end}`;
            } else if (days > 0) {
                countdownHTML = `<span class="font-bold">${days}</span>d <span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m`;
                icon = "calendar-check";
                statusClass = "text-yellow-300";
                subText = `First Lesson: <span class="font-bold text-white">${title}</span> (${day})`;
                timeRangeToDisplay = `${start} - ${end}`;
            } else if (totalSeconds > 0) {
                countdownHTML = `<span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m`;
                icon = title === "BREAK" ? "coffee" : "clock";
                statusClass = title === "BREAK" ? "text-green-300" : "text-blue-300";
                timeRangeToDisplay = `${start} - ${end}`;
            } else {
                countdownHTML = "Finished";
                icon = "sun";
                statusClass = "text-gray-400";
                subText = "Classes are over. Enjoy your evening!";
                location = '';
            }

            widgetEl.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <div class="flex items-center">
                        <span data-lucide="${icon}" class="w-5 h-5 mr-2 ${statusClass}"></span>
                        <p class="text-sm text-white/80">${subText}</p>
                    </div>
                    <p class="text-sm font-semibold ${statusClass}">${countdownHTML}</p>
                </div>
                <div class="flex justify-between items-center w-full mt-1 border-t border-white/10 pt-1">
                    <p class="text-xs text-white/60">${timeRangeToDisplay}</p>
                    <p class="text-xs text-white/60">${location ? locationPrefix + location : ''}</p>
                </div>
            `;
            lucide.createIcons(); 
        };

        // --- General State ---
        let assignments = [];
        let finishedAssignments = [];
        let bookmarks = []; 
        let countdownInterval;

        // --- Utils ---
        const padZero = (num) => String(Math.floor(num)).padStart(2, '0');
        const getTimeRemaining = (endTime) => {
            const total = endTime - new Date();
            return { 
                total, 
                days: padZero(total / (1000 * 60 * 60 * 24)), 
                hours: padZero((total / (1000 * 60 * 60)) % 24), 
                minutes: padZero((total / (1000 * 60)) % 60), 
                seconds: padZero((total / 1000) % 60) 
            };
        };
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };
        const getBaseDomain = (url) => {
            try {
                const safeUrl = url.startsWith('http') ? url : `https://${url}`;
                const domain = new URL(safeUrl).hostname;
                return domain.startsWith('www.') ? domain.substring(4) : domain;
            } catch (e) { return null; }
        };

        window.handleMarkAsDone = (id, elementId) => {
            const element = document.getElementById(elementId);
            if (!element) return;
            const assignmentToMove = assignments.find(a => a.id === id);
            if (!assignmentToMove) return;

            element.classList.add('assignment-item-done', 'swipe-active');
            setTimeout(() => {
                element.classList.remove('assignment-item-done');
                element.classList.add('swipe-to-delete'); 
                setTimeout(async () => {
                    if (window.db && window.db.addFinishedAssignment && window.db.deleteAssignment) {
                        await window.db.addFinishedAssignment(assignmentToMove); 
                        await window.db.deleteAssignment(id);
                    } else { element.remove(); }
                }, 500);
            }, 500);
        };

        // --- Renders ---
        const MCAST_LINKS = [
            { name: "MCAST VLE", url: "https://vle.mcast.edu.mt/my/", icon: "graduation-cap" },
            { name: "MCAST Classter", url: "https://mcast.classter.com", icon: "school" },
            { name: "Dissertations & SOI", url: "https://vle.mcast.edu.mt/course/view.php?id=2892 ", icon: "book-open-text"} ,
            { name: "Systems Programming", url: "https://vle.mcast.edu.mt/course/view.php?id=5314", icon: "laptop" },
            { name: "Image Processing & Computer Vision", url: "https://vle.mcast.edu.mt/course/view.php?id=57", icon: "image" },
            { name: "Data Structures & Algorithms II", url: "https://vle.mcast.edu.mt/course/view.php?id=127", icon: "git-branch" },
            { name: "Statistics for Computer Science", url: "https://vle.mcast.edu.mt/course/view.php?id=133", icon: "bar-chart-2" },
        ];

        window.renderMCASTLinks = () => {
            const container = document.getElementById('mcast-link-list');
            container.innerHTML = MCAST_LINKS.map(link => `
                <div class="mcast-link-item-wrap relative flex items-center group">
                    <a href="${link.url}" rel="noopener noreferrer" title="${link.name}"
                       class="mcast-link-item block w-full text-left p-3 pr-4 rounded-xl bg-white/10 text-white hover:bg-white/20 backdrop-blur-sm transition-all duration-300">
                        <span data-lucide="${link.icon || 'link'}" class="inline-block w-4 h-4 mr-2"></span>
                        ${link.name}
                    </a>
                </div>
            `).join('');
            lucide.createIcons(); 
        };

        window.renderBookmarks = (newBookmarks) => {
            bookmarks = newBookmarks;
            const container = document.getElementById('bookmark-container');
            container.innerHTML = bookmarks.map(b => {
                const domain = getBaseDomain(b.url);
                const faviconUrl = domain ? `https://s2.googleusercontent.com/s2/favicons?domain=${domain}&sz=64` : null;
                const iconContent = faviconUrl 
                    ? `<img src="${faviconUrl}" alt="${b.name} Favicon" class="bookmark-favicon" onerror="this.outerHTML='<span data-lucide=${b.icon || 'link'} class=\\'w-6 h-6 text-white\\'></span>'"/>`
                    : `<span data-lucide="${b.icon || 'link'}" class="w-6 h-6 text-white"></span>`;

                return `
                <div class="bookmark-item-wrap relative">
                    <a href="${b.url}" rel="noopener noreferrer" title="${b.name}"
                        class="bookmark-icon flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/10 border border-white/20 rounded-2xl hover:border-blue-400">
                        ${iconContent}
                        <span class="text-xs text-white/80 mt-1 truncate max-w-full">${b.name}</span>
                    </a>
                    <button onclick="window.db.deleteBookmark('${b.id}')"
                            class="delete-btn absolute top-[-5px] right-[-5px] w-6 h-6 flex items-center justify-center bg-white/20 text-white rounded-full p-0.5 shadow-md hover:bg-white/40 transition-colors">
                        <span data-lucide="x" class="w-3 h-3"></span>
                    </button>
                </div>
                `;
            }).join('');
            container.innerHTML += `
                <button id="open-bookmark-modal-btn"
                        class="flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/5 border border-white/10 rounded-2xl text-white/50 hover:text-white hover:border-blue-500 transition-all duration-300">
                    <span data-lucide="plus" class="w-8 h-8"></span>
                    <span class="text-xs mt-1">Add</span>
                </button>
            `;
            document.getElementById('open-bookmark-modal-btn')?.addEventListener('click', openBookmarkModal);
            lucide.createIcons();
        };

        window.renderAssignments = (newAssignments) => {
            assignments = newAssignments;
            const list = document.getElementById('assignment-list');
            list.innerHTML = ''; 
            if (assignments.length === 0) {
                list.innerHTML = '<p class="text-white/50 text-center mt-4">No upcoming assignments. Add one!</p>';
            }
            assignments.forEach(assignment => {
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const formattedDate = `${String(deadlineDate.getDate()).padStart(2, '0')}/${String(deadlineDate.getMonth() + 1).padStart(2, '0')}/${deadlineDate.getFullYear()}`;
                const countdownHTML = `<div id="countdown-${assignment.id}" class="text-xs font-mono text-yellow-300 mt-1">Calculating...</div>`;
                const itemID = `assignment-item-${assignment.id}`;
                const item = document.createElement('div');
                item.id = itemID; 
                item.className = 'assignment-item assignment-item-done flex justify-between items-start p-3 rounded-lg bg-white/5 backdrop-blur-sm shadow-md transition-all duration-300 hover:bg-white/10'; 
                item.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-white">${assignment.title}</p>
                        <p class="text-xs text-white/70">${formattedDate}</p>
                        ${countdownHTML}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.handleMarkAsDone('${assignment.id}', '${itemID}')" class="delete-btn text-green-400 hover:text-green-500 transition-colors duration-200 p-1 rounded"><span data-lucide="check-square" class="w-4 h-4"></span></button>
                        <button onclick="window.db.deleteAssignment('${assignment.id}')" class="delete-btn text-red-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"><span data-lucide="x" class="w-4 h-4"></span></button>
                    </div>
                `;
                list.appendChild(item);
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-btn')) return; 
                    openAssignmentDetailModal(assignment);
                });
            });
            lucide.createIcons();
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdowns, 1000);
        };
        
        window.renderFinishedAssignments = (newFinishedAssignments) => {
            finishedAssignments = newFinishedAssignments;
            const list = document.getElementById('finished-assignment-list');
            const toggleBtn = document.getElementById('toggle-finished-btn');
            list.innerHTML = ''; 
            if (finishedAssignments.length === 0) {
                list.innerHTML = '<p class="text-white/30 text-center mt-4 text-sm">No finished assignments recorded.</p>';
                toggleBtn.querySelector('span:last-child').textContent = "Finished Assignments (0)";
                toggleBtn.disabled = true;
                list.classList.add('hidden');
                return;
            }
            toggleBtn.disabled = false;
            toggleBtn.querySelector('span:last-child').textContent = `Finished Assignments (${finishedAssignments.length})`;

            finishedAssignments.forEach(assignment => {
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const completedAtDate = assignment.completedAt instanceof Date ? assignment.completedAt : new Date(assignment.completedAt);
                const formattedDate = `${String(deadlineDate.getDate()).padStart(2, '0')}/${String(deadlineDate.getMonth() + 1).padStart(2, '0')}/${deadlineDate.getFullYear()}`;
                const formattedCompletedDate = `${String(completedAtDate.getDate()).padStart(2, '0')}/${String(completedAtDate.getMonth() + 1).padStart(2, '0')}/${completedAtDate.getFullYear()}`;
                
                const item = document.createElement('div');
                item.className = 'flex justify-between items-start p-3 rounded-lg bg-white/5 backdrop-blur-sm shadow-md transition-all duration-300 hover:bg-white/10 opacity-70 hover:opacity-100'; 
                item.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold finished-assignment-text">${assignment.title}</p>
                        <p class="text-xs finished-assignment-text">Due: ${formattedDate}</p>
                        <p class="text-xs text-green-400 mt-1">Completed: ${formattedCompletedDate}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.db.deleteFinishedAssignment('${assignment.id}')" class="text-red-400 hover:text-red-500 transition-colors duration-200 p-1 rounded opacity-0 hover:opacity-100 transition-opacity"><span data-lucide="x" class="w-4 h-4"></span></button>
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        };

        const updateCountdowns = () => {
            assignments.forEach(assignment => {
                const countdownEl = document.getElementById(`countdown-${assignment.id}`);
                if (!countdownEl) return;
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const remaining = getTimeRemaining(deadlineDate);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const deadlineDay = new Date(deadlineDate.getFullYear(), deadlineDate.getMonth(), deadlineDate.getDate());

                if (deadlineDay.getTime() === today.getTime()) { countdownEl.innerHTML = '<span class="text-green-400 font-semibold">Due Today</span>'; return; }
                if (deadlineDay.getTime() < today.getTime()) { countdownEl.innerHTML = '<span class="text-red-500 font-bold">Deadline Passed</span>'; return; }

                countdownEl.innerHTML = `<span class="font-bold">${remaining.days}</span>d <span class="font-bold">${remaining.hours}</span>h <span class="font-bold">${remaining.minutes}</span>m <span class="font-bold">${remaining.seconds}</span>s`;
            });
        };
        
        const toggleFinishedAssignments = () => {
            const list = document.getElementById('finished-assignment-list');
            const toggleBtn = document.getElementById('toggle-finished-btn');
            list.classList.toggle('hidden');
            toggleBtn.querySelector('span[data-lucide]').setAttribute('data-lucide', list.classList.contains('hidden') ? 'chevrons-down' : 'chevrons-up');
            lucide.createIcons(); 
        };


        // --- Modal Logic ---
        const openAssignmentModal = () => document.getElementById('assignment-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeAssignmentModal = () => document.getElementById('assignment-modal').classList.add('opacity-0', 'pointer-events-none');
        const handleAddAssignment = async () => {
            const titleInput = document.getElementById('assignment-title');
            const deadlineInput = document.getElementById('assignment-deadline');
            if (!titleInput.value.trim() || !deadlineInput.value) return;
            await window.db.addAssignment(titleInput.value.trim(), new Date(deadlineInput.value)); 
            titleInput.value = ''; deadlineInput.value = ''; closeAssignmentModal();
        };

        let detailModal, detailIdInput, detailTitleInput, detailDeadlineInput, detailNoteInput;
        const formatDateForInput = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };
        const openAssignmentDetailModal = (assignment) => {
            detailIdInput.value = assignment.id;
            detailTitleInput.value = assignment.title;
            detailDeadlineInput.value = formatDateForInput(assignment.deadline);
            detailNoteInput.value = assignment.notes || ''; 
            detailModal.classList.remove('opacity-0', 'pointer-events-none');
        };
        const closeAssignmentDetailModal = () => {
            detailModal.classList.add('opacity-0', 'pointer-events-none');
            detailIdInput.value = ''; detailTitleInput.value = ''; detailDeadlineInput.value = ''; detailNoteInput.value = '';
        };
        const handleSaveDetailChanges = async () => {
            const deadlineDate = detailDeadlineInput.value ? new Date(detailDeadlineInput.value) : null;
            if (window.db && window.db.updateAssignment) await window.db.updateAssignment(detailIdInput.value, detailTitleInput.value.trim(), deadlineDate, detailNoteInput.value); 
            closeAssignmentDetailModal();
        };
        const handleDeleteFromDetail = async () => {
            if (confirm("Are you sure?")) {
                if (window.db && window.db.deleteAssignment) await window.db.deleteAssignment(detailIdInput.value);
                closeAssignmentDetailModal();
            }
        };

        const openBookmarkModal = () => document.getElementById('bookmark-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBookmarkModal = () => document.getElementById('bookmark-modal').classList.add('opacity-0', 'pointer-events-none');
        const handleAddBookmark = async () => {
            const nameInput = document.getElementById('bookmark-name');
            const urlInput = document.getElementById('bookmark-url');
            if (!nameInput.value.trim() || !urlInput.value.trim()) return;
            const url = urlInput.value.trim().startsWith('http') ? urlInput.value.trim() : `https://${urlInput.value.trim()}`;
            await window.db.addBookmark(nameInput.value.trim(), url, 'link');
            nameInput.value = ''; urlInput.value = ''; closeBookmarkModal();
        };

        const openBackgroundGalleryModal = () => document.getElementById('background-gallery-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBackgroundGalleryModal = () => {
            document.getElementById('background-image-file').value = ''; 
            document.getElementById('background-gallery-modal').classList.add('opacity-0', 'pointer-events-none');
        }
        const handleAddBackground = async () => {
            const fileInput = document.getElementById('background-image-file');
            const file = fileInput.files[0];
            const fileName = document.getElementById('background-file-name').value.trim() || file?.name;
            if (!file || !file.type.startsWith('image/') || file.size > 2*1024*1024) return alert('Invalid file.');
            try {
                const base64String = await fileToBase64(file);
                await window.db.addBackground(base64String, fileName);
                fileInput.value = ''; document.getElementById('background-file-name').value = '';
            } catch (error) { console.error("Error:", error); }
        };


        window.onload = () => {
            changeBackground(currentBackgroundId); 
            window.renderMCASTLinks(); 
            renderScheduleWidget(); 
            if (nextLessonInterval) clearInterval(nextLessonInterval);
            nextLessonInterval = setInterval(renderScheduleWidget, 1000); 

            detailModal = document.getElementById('assignment-detail-modal');
            detailIdInput = document.getElementById('detail-assignment-id');
            detailTitleInput = document.getElementById('detail-assignment-title');
            detailDeadlineInput = document.getElementById('detail-assignment-deadline');
            detailNoteInput = document.getElementById('detail-assignment-note');

            // Event Listeners
            document.getElementById('open-assignment-modal-btn').addEventListener('click', openAssignmentModal);
            document.getElementById('close-assignment-modal-btn').addEventListener('click', closeAssignmentModal);
            document.getElementById('add-assignment-btn').addEventListener('click', handleAddAssignment);
            document.getElementById('close-detail-modal-btn')?.addEventListener('click', closeAssignmentDetailModal);
            document.getElementById('save-assignment-btn')?.addEventListener('click', handleSaveDetailChanges);
            document.getElementById('delete-from-detail-btn')?.addEventListener('click', handleDeleteFromDetail);
            document.getElementById('toggle-finished-btn')?.addEventListener('click', toggleFinishedAssignments);
            document.getElementById('bookmark-container').addEventListener('click', (e) => { if (e.target.closest('#open-bookmark-modal-btn')) openBookmarkModal(); });
            document.getElementById('close-bookmark-modal-btn').addEventListener('click', closeBookmarkModal);
            document.getElementById('add-bookmark-btn').addEventListener('click', handleAddBookmark);
            document.getElementById('open-background-gallery-btn').addEventListener('click', openBackgroundGalleryModal);
            document.getElementById('close-background-gallery-modal-btn').addEventListener('click', closeBackgroundGalleryModal);
            document.getElementById('add-background-btn').addEventListener('click', handleAddBackground);
            
            // Weekly Timetable Logic (Merged here for optimization)
            document.getElementById('open-weekly-timetable-btn').addEventListener('click', () => {
                const modal = document.getElementById("weekly-timetable-modal");
                const content = document.getElementById("weekly-timetable-content");
                const formatLesson = (item, highlight) => `
                    <div class="p-3 rounded-lg ${highlight ? 'bg-purple-800/40 border border-purple-400' : 'bg-white/5'}">
                        <p class="font-semibold ${highlight ? 'text-purple-300' : 'text-blue-300'}">${item.title}</p>
                        <p class="text-white/70 text-sm">${item.start} - ${item.end}</p>
                        <p class="text-white/50 text-xs">${item.location ?? ''}</p>
                    </div>`;
                
                content.innerHTML = "";
                const now = new Date();
                const dayIndex = now.getDay();
                const nowMinutes = now.getHours() * 60 + now.getMinutes();

                for (const day of DAYS_OF_WEEK) {
                    const lessons = TIMETABLE[day];
                    let html = `<div class="mb-6"><h3 class="text-xl font-bold text-white mb-2">${day}</h3><div class="space-y-2">`;
                    lessons.forEach(item => {
                        const start = timeToMinutes(item.start);
                        const end = timeToMinutes(item.end);
                        const isCurrent = day === DAYS_OF_WEEK[dayIndex] && nowMinutes >= start && nowMinutes < end && item.title !== "WEEKEND";
                        html += formatLesson(item, isCurrent);
                    });
                    html += "</div></div>";
                    content.innerHTML += html;
                }
                modal.classList.remove("opacity-0", "pointer-events-none");
            });
            document.getElementById('close-weekly-timetable-btn').addEventListener('click', () => document.getElementById("weekly-timetable-modal").classList.add("opacity-0", "pointer-events-none"));

            document.getElementById('search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const query = document.getElementById('search-input').value;
                if (query) {
                    if (query.includes('.') && !query.includes(' ')) {
                        let url = query.startsWith('http') ? query : `https://${query}`;
                        window.location.href = url;
                    } else {
                        window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    }
                }
            });
        };
    </script>
</head>
<body class="bg-gray-900">

    <div id="background-container"></div>

    <div class="scroll-container flex justify-center items-start lg:items-center">

        <div class="grid grid-cols-1 lg:grid-cols-7 gap-8 w-full max-w-7xl pt-16 lg:pt-0 pb-16">

            <div class="lg:col-span-2 p-6 bg-white/10 rounded-3xl backdrop-blur-xl shadow-2xl h-fit">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <span data-lucide="graduation-cap" class="w-6 h-6 mr-2 text-blue-400"></span>
                        MCAST Links
                    </h2>
                    </div>
                <div id="mcast-link-list" class="space-y-3">
                    </div>
            </div>

            <div class="lg:col-span-3 flex flex-col items-center justify-center p-6 space-y-8">
                
                <div id="next-lesson-widget" class="w-full max-w-2xl p-4 bg-white/10 rounded-xl backdrop-blur-md shadow-lg border border-white/20">
                    <p class="text-white/50 text-center">Loading timetable...</p>
                </div>
                <form id="search-form" class="w-full max-w-2xl relative">
                    <input type="text" id="search-input" placeholder="Search Google or type a URL..." 
                        class="w-full p-4 pl-12 pr-24 bg-white/90 text-gray-900 border-2 border-transparent focus:border-blue-500 rounded-full shadow-lg outline-none transition-all duration-300" 
                        autofocus>
                    <span data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500"></span>
                    
                    <a href="https://mail.google.com/" target="_blank" rel="noopener noreferrer" title="Gmail"
                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-red-600 transition-colors">
                        <span data-lucide="mail" class="w-5 h-5"></span>
                    </a>
                    
                    <a href="https://maps.google.com/" target="_blank" rel="noopener noreferrer" title="Google Maps"
                    class="absolute right-12 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-green-600 transition-colors">
                        <span data-lucide="map-pin" class="w-5 h-5"></span>
                    </a>
                    
                    <button type="submit" class="hidden">Search</button>
                </form>

                <div id="bookmark-container" class="grid grid-cols-4 gap-4 sm:gap-6 p-4 rounded-3xl bg-white/5 backdrop-blur-md shadow-inner max-w-2xl w-full">
                    </div>

                <div class="flex justify-center w-full">
                    <button id="open-background-gallery-btn"
                            class="flex items-center text-sm text-white/70 hover:text-white transition-colors p-3 rounded-full bg-white/10 hover:bg-white/20">
                        <span data-lucide="gallery-vertical" class="w-4 h-4 mr-2"></span>
                        Manage Backgrounds
                    </button>
                </div>

                <p id="user-id-display" class="text-xs text-white/50 mt-4"></p>
            </div>

            <div class="lg:col-span-2 p-5 bg-white/10 rounded-2xl backdrop-blur-xl shadow-lg h-fit">
    
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white flex items-center">
                    <span data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-green-400"></span>
                    Upcoming Assignments
                </h2>
                <button id="open-assignment-modal-btn"
                        class="w-8 h-8 flex items-center justify-center bg-green-500 text-white rounded-full shadow-md hover:bg-green-600 transition-transform transform hover:scale-110"
                        title="Add New Assignment">
                    <span data-lucide="plus" class="w-5 h-5"></span>
                </button>
            </div>

            <div id="assignment-list" class="space-y-4 max-h-96 overflow-y-auto scroll-container pr-2">
                </div>
            
                            
                <button id="toggle-finished-btn"
                        class="w-full mt-4 flex items-center justify-center p-2 rounded-xl bg-white/5 text-white/70 hover:bg-white/10 hover:text-white transition-colors"
                        title="Show/Hide Completed Assignments">
                    <span data-lucide="chevrons-down" class="w-4 h-4 mr-2"></span>
                    <span>Finished Assignments</span>
                </button>

                <div id="finished-assignment-list" class="space-y-3 mt-4 hidden">
                    </div>
            </div>
        </div>
    </div>

    <div id="assignment-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Add New Assignment</h3>
            <div class="space-y-4">
                <input type="text" id="assignment-title" placeholder="Assignment Title"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                <input type="date" id="assignment-deadline"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none transition-colors">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-assignment-modal-btn" class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="add-assignment-btn" class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">Save Assignment</button>
            </div>
        </div>
    </div>

    <div id="assignment-detail-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Task Details</h3>
            <input type="hidden" id="detail-assignment-id">
            <div class="space-y-4">
                <label class="block text-white/70 text-sm font-semibold">Title</label>
                <input type="text" id="detail-assignment-title" class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none">
                <label class="block text-white/70 text-sm font-semibold">Deadline</label>
                <input type="date" id="detail-assignment-deadline" class="w-full p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
                <label class="block text-white/70 text-sm font-semibold">Notes</label>
                <textarea id="detail-assignment-note" rows="5" class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none resize-none"></textarea>
            </div>
            <div class="flex justify-between space-x-4 mt-6 border-t border-gray-700 pt-4">
                <button id="delete-from-detail-btn" class="px-5 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700 font-semibold transition-colors">Delete Task</button>
                <div class="flex space-x-4">
                    <button id="close-detail-modal-btn" class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">Cancel</button>
                    <button id="save-assignment-btn" class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="bookmark-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Add New Bookmark</h3>
            <div class="space-y-4">
                <input type="text" id="bookmark-name" placeholder="Name" class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none">
                <input type="url" id="bookmark-url" placeholder="URL" class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-bookmark-modal-btn" class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="add-bookmark-btn" class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">Save Bookmark</button>
            </div>
        </div>
    </div>

    <div id="background-gallery-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-4xl border border-gray-700 transform transition-all duration-300 scale-100 h-5/6 flex flex-col">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <span data-lucide="gallery-vertical" class="w-6 h-6 mr-2"></span>
                Manage Your Backgrounds
            </h3>

            <div class="flex-grow overflow-y-auto pr-2 mb-6 space-y-4">
                <h4 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Select or Delete</h4>
                <div id="background-gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                
                <h4 class="text-lg font-semibold text-white mb-3 pt-6 border-t border-gray-700 pt-4">Add New Background</h4>
                
                <div class="space-y-4">
                     <p class="text-sm text-white/70">Upload an image file (e.g., JPG, PNG). Max size: 2MB.</p>
                    <input type="text" id="background-file-name" placeholder="Optional: Give this background a name"
                            class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                    <input type="file" id="background-image-file" accept="image/*"
                            class="w-full text-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-auto border-t border-gray-700 pt-4">
                 <button id="close-background-gallery-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                    Close Gallery
                </button>
                <button id="add-background-btn"
                        class="px-5 py-2 rounded-xl bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors">
                    Upload Image
                </button>
            </div>
        </div>
    </div>
   
   <div id="weekly-timetable-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 pointer-events-none transition duration-300 z-50">
        <div class="bg-gray-900 w-full max-w-3xl p-6 rounded-2xl shadow-2xl border border-gray-700 overflow-y-auto max-h-[85vh] relative custom-scroll">
            <button id="close-weekly-timetable-btn" class="absolute top-4 right-4 text-white/70 hover:text-red-400 transition"><span data-lucide="x" class="w-6 h-6"></span></button>
            <h2 class="text-2xl font-bold text-blue-400 mb-4 text-center">Weekly Timetable</h2>
            <div id="weekly-timetable-content" class="space-y-6"></div>
        </div>
    </div>

    <button id="open-weekly-timetable-btn"
        class="fixed bottom-5 left-5 z-50 p-3 rounded-xl bg-white/10 backdrop-blur-md border border-white/20 shadow-lg hover:bg-white/20 transition flex items-center justify-center">
        <span data-lucide="square-menu" class="w-6 h-6 text-white"></span>
    </button>

    <div id="version-timestamp">Last Update 21/11/2025 - 16:30</div>
    
    <style>
    .custom-scroll::-webkit-scrollbar { width: 10px; }
    .custom-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.08); border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #3b82f6, #9333ea); border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #60a5fa, #a855f7); }
    </style>

</body>
</html>