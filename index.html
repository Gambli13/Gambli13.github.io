<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="images/redchrome.ico">
    <title>New Tab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font and base styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        #background-container {
            /* Initial background color, no text placeholder */
            background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 1 1\'%3E%3Crect width=\'1\' height=\'1\' fill=\'%230f172a\'/%3E%3C/svg%3E'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* The darkened filter is REMOVED */
            transition: background-image 1s ease-in-out; /* Smooth background transition */
        }
        .scroll-container {
            overflow-y: auto;
            height: 100vh;
            padding: 20px;
        }
        /* Custom scrollbar for a sleek look */
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }

        .bookmark-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .bookmark-icon:hover {
            transform: scale(1.05); /* MODIFIED: Removed translateY(-2px) to fix misalignment */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            border-color: #3b82f6;
        }
        
        /* UPDATED: Favicon styles (from 32px to 24px) */
        .bookmark-favicon {
            width: 24px; /* Set fixed size for favicons */
            height: 24px;
            object-fit: contain;
            /* Optional: add a slight shadow for visibility on dark backgrounds */
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.8));
        }

        .mcast-link-item {
            transition: background-color 0.3s, transform 0.3s;
            cursor: pointer; /* Indicate it's clickable */
        }
        .mcast-link-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        /* Standard transition for projects/assignments/bookmarks */
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .assignment-item:hover .delete-btn,
        .bookmark-item-wrap:hover .delete-btn {
            opacity: 1;
        }
        /* NEW: Make assignment items clickable */
        .assignment-item {
            cursor: pointer;
            position: relative; /* Needed for the absolute positioning of the pseudo-element/gradient */
            overflow: hidden; /* Hide the gradient before animation starts */
        }

        /* Styles for background gallery thumbnails */
        .background-thumbnail {
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s, opacity 0.3s;
        }
        .background-thumbnail:hover {
            border-color: #3b82f6; /* Blue border on hover */
            opacity: 0.8;
        }
        .background-thumbnail.selected {
            border-color: #10b981; /* Green border for selected */
            border-width: 4px;
        }

        /* NEW: Style for the fixed 'Last Updated' timestamp */
        #version-timestamp {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            font-size: 0.75rem; /* text-xs */
            color: rgba(255, 255, 255, 0.5); /* text-white/50 */
            background-color: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 6px;
            backdrop-filter: blur(5px);
        }

        /* NEW: CSS for the "Done" swipe animation */
        .assignment-item-done {
            /* Create a background layer for the animation */
            position: relative;
            z-index: 1;
            transition: opacity 0.5s ease-out, height 0.5s ease-out, padding 0.5s ease-out, margin 0.5s ease-out; /* Added margin transition */
        }
        .assignment-item-done::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0; /* Start width at 0 */
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669); /* Green Gradient */
            border-radius: 0.5rem; /* Match parent's rounded-lg */
            transition: width 0.5s ease-in-out;
            z-index: -1; /* Place behind content */
        }
        /* Class added on click to trigger the swipe and subsequent removal */
        .assignment-item.swipe-to-delete {
            opacity: 0; /* Final state of deletion animation */
            height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
        .assignment-item-done.swipe-active::before {
            width: 100%; /* Swipe to full width */
        }
        
        /* NEW: Style for finished assignment text */
        .finished-assignment-text {
            color: rgba(255, 255, 255, 0.5); /* Dimmer white */
            text-decoration: line-through;
        }
    </style>

    <script>
        // Define fallback variables in global scope for use in the module script below.
        const LOCAL_FIREBASE_CONFIG_JSON = JSON.stringify({
           apiKey: "AIzaSyDRYcVVOg_yzTbYQnBj7TxghX-2rNT3f3g",
           authDomain: "personalment-c1a9c.firebaseapp.com",
           projectId: "personalment-c1a9c",
           storageBucket: "personalment-c1a9c.firebasestorage.app",
           messagingSenderId: "461177689665",
           appId: "1:461177689665:web:bddc74fe94c21c097d18c0",
           measurementId: "G-RC5MS7QBNK"
        });
        const LOCAL_AUTH_TOKEN = null; 
    </script>
    <script type="module">
    // --- USING v12.4.0 CDN LINKS AS REQUESTED ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    // setDoc is imported for updates
    import { getFirestore, doc, addDoc, deleteDoc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    // --- END v12.4.0 IMPORTS ---

    // Define the mandatory static ID requested by the user
    const STATIC_OVERRIDE_USER_ID = 'zNllEXqmHpaqNZffrgOhyPrSfBB3';

    // Determine environment: Use Canvas globals OR local fallbacks
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // FIX: Accessing LOCAL_FIREBASE_CONFIG_JSON and LOCAL_AUTH_TOKEN which are now globally defined.
    const configSource = typeof __firebase_config !== 'undefined' ? __firebase_config : LOCAL_FIREBASE_CONFIG_JSON;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : LOCAL_AUTH_TOKEN;

    // Parse the configuration
    const firebaseConfig = JSON.parse(configSource);
    
    let db, auth, userId = null;
    let isAuthReady = false;

    setLogLevel('debug'); // Enable Firestore logging

    // Utility function to get the current collection path for private user data
    const getCollectionPath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}_index`;

    // Initialize Firebase and Authentication
    const initFirebase = async () => {
        try {
            // Initialize app with the provided configuration
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sign in with custom token if available, otherwise sign in anonymously.
            // Authentication is still performed, but the resulting user.uid is ignored for pathing.
            if (initialAuthToken) {
                console.log("Attempting sign-in with custom token...");
                await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.warn("Custom token sign-in failed, trying anonymous:", e);
                    return signInAnonymously(auth);
                });
            } else {
                console.log("Attempting anonymous sign-in...");
                await signInAnonymously(auth);
            }

            // Wait for auth state to be resolved
            onAuthStateChanged(auth, (user) => {
                // *** MODIFICATION START: FORCE STATIC USER ID ***
                userId = STATIC_OVERRIDE_USER_ID; 
                isAuthReady = true;
                console.log("Firebase Auth Ready. FORCING User ID for pathing to:", userId);

                // Once ready, start loading persistent data
                setupDataListeners();
                // Display the user ID for debugging/sharing purposes
                document.getElementById('user-id-display').textContent = `Static User ID: ${userId}`;
                // *** MODIFICATION END ***
            });

        } catch (error) {
            // This catch block is only for core initialization failures (e.g., bad config, network)
            console.error("Firebase Initialization failed, falling back to Mock Mode:", error);
            window.setupMockData(); 
        }
    };

    // --- Data Listener Setup (Only runs if Firestore is successfully initialized) ---
    const setupDataListeners = () => {
        if (!db || !userId) { 
            console.error("Cannot set up listeners: DB not initialized or User ID missing.");
            return;
        }

        // 1. Assignments Listener (Active)
        onSnapshot(collection(db, getCollectionPath('assignments')), (snapshot) => {
            const assignments = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                let deadlineDate;
                
                if (data.deadline && typeof data.deadline.toDate === 'function') {
                    deadlineDate = data.deadline.toDate();
                } else if (data.deadline) {
                    deadlineDate = new Date(data.deadline);
                } else {
                    deadlineDate = null;
                }
                assignments.push({ id: doc.id, ...data, deadline: deadlineDate });
            });
            
            assignments.sort((a, b) => (a.deadline || 0) - (b.deadline || 0));
            window.renderAssignments(assignments);
        }, (error) => {
            console.error("Error fetching assignments:", error);
        });

        // 2. Bookmarks Listener
        onSnapshot(collection(db, getCollectionPath('bookmarks')), (snapshot) => {
            const bookmarks = [];
            snapshot.forEach(doc => {
                bookmarks.push({ id: doc.id, ...doc.data() });
            });
            window.renderBookmarks(bookmarks);
        }, (error) => {
            console.error("Error fetching bookmarks:", error);
        });
        
        // 3. Backgrounds Listener (NEW)
        onSnapshot(collection(db, getCollectionPath('backgrounds')), (snapshot) => {
            const userBackgrounds = [];
            snapshot.forEach(doc => {
                // Only push the Base64 string for use in the CSS
                userBackgrounds.push({ id: doc.id, name: doc.data().name || 'Background', base64: doc.data().base64 });
            });
            window.setUserBackgrounds(userBackgrounds);
            window.renderBackgroundGallery(userBackgrounds); // RENDER GALLERY
        }, (error) => {
            console.error("Error fetching backgrounds:", error);
        });
        
        // 4. Finished Assignments Listener (NEW)
        onSnapshot(collection(db, getCollectionPath('finished_assignments')), (snapshot) => {
            const finished = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                // Date conversion for deadline
                let deadlineDate;
                if (data.deadline && typeof data.deadline.toDate === 'function') {
                    deadlineDate = data.deadline.toDate();
                } else if (data.deadline) {
                    deadlineDate = new Date(data.deadline);
                } else {
                    deadlineDate = null;
                }
                
                // Date conversion for completedAt
                let completedAtDate = data.completedAt ? new Date(data.completedAt) : new Date();

                finished.push({ id: doc.id, ...data, deadline: deadlineDate, completedAt: completedAtDate });
            });
            
            // Sort by completedAt descending
            finished.sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));
            window.renderFinishedAssignments(finished); // NEW RENDER CALL
        }, (error) => {
            console.error("Error fetching finished assignments:", error);
        });
    };

    // --- Firebase Data Operations (Global Functions) ---
    window.db = {
        // Assignment CRUD (existing)
        addAssignment: async (title, deadlineDate) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                await addDoc(collection(db, getCollectionPath('assignments')), {
                    title: title,
                    // Storing date as ISO string is better for cross-platform/language consistency in Firestore
                    deadline: deadlineDate.toISOString(), 
                    createdAt: new Date().toISOString(),
                    notes: '' // Initialize notes field
                });
                console.log("Assignment added to Firestore successfully.");
            } catch (e) { console.error("Error adding document: ", e); }
        },
        
        // NEW: Function to update an existing assignment
        updateAssignment: async (id, title, deadlineDate, notes) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                // Convert date to ISO string for storage
                const deadlineISO = deadlineDate instanceof Date && !isNaN(deadlineDate) ? deadlineDate.toISOString() : null;

                await setDoc(doc(db, getCollectionPath('assignments'), id), {
                    title: title,
                    deadline: deadlineISO, 
                    notes: notes || '', // Save notes field
                }, { merge: true }); // Use merge: true to update specific fields
                console.log(`Assignment ${id} updated in Firestore successfully.`);
            } catch (e) { console.error("Error updating document: ", e); }
        },
        
        deleteAssignment: async (id) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                await deleteDoc(doc(db, getCollectionPath('assignments'), id));
                console.log("Assignment deleted from Firestore successfully.");
            } catch (e) { console.error("Error deleting document: ", e); }
        },
        
        // NEW: Function to move an active assignment to the finished collection
        addFinishedAssignment: async (assignmentData) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                await addDoc(collection(db, getCollectionPath('finished_assignments')), {
                    ...assignmentData,
                    // Ensure deadline is stored as ISO string if it was a Date object
                    deadline: assignmentData.deadline instanceof Date ? assignmentData.deadline.toISOString() : assignmentData.deadline,
                    completedAt: new Date().toISOString() // Record completion time
                });
                console.log("Assignment moved to finished successfully.");
            } catch (e) { console.error("Error adding finished document: ", e); }
        },

        // NEW: Function to delete a finished assignment (cleanup)
        deleteFinishedAssignment: async (id) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                await deleteDoc(doc(db, getCollectionPath('finished_assignments'), id));
                console.log("Finished assignment deleted from Firestore successfully.");
            } catch (e) { console.error("Error deleting finished document: ", e); }
        },


        // Bookmark CRUD (existing)
        addBookmark: async (name, url, icon) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                await addDoc(collection(db, getCollectionPath('bookmarks')), {
                    name: name,
                    url: url,
                    icon: icon,
                });
                console.log("Bookmark added to Firestore successfully.");
            } catch (e) { console.error("Error adding bookmark: ", e); }
        },
        deleteBookmark: async (id) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                await deleteDoc(doc(db, getCollectionPath('bookmarks'), id));
                console.log("Bookmark deleted from Firestore successfully.");
            } catch (e) { console.error("Error deleting bookmark: ", e); }
        },

        // Background CRUD (NEW)
        addBackground: async (base64String, fileName) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                await addDoc(collection(db, getCollectionPath('backgrounds')), {
                    base64: base64String, // The image data
                    name: fileName,
                    uploadedAt: new Date().toISOString()
                });
                console.log(`Background '${fileName}' added to Firestore successfully.`);
            } catch (e) { console.error("Error adding background: ", e); }
        },
        deleteBackground: async (id) => {
            if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
            try {
                await deleteDoc(doc(db, getCollectionPath('backgrounds'), id));
                console.log("Background deleted from Firestore successfully.");
            } catch (e) { console.error("Error deleting background: ", e); }
        },
    };

    initFirebase();
</script>

    <script>
        // --- Custom Background Image Array ---
        let USER_BACKGROUNDS = [];
        // Use localStorage to persist the ID of the currently selected background
        const CURRENT_BG_KEY = 'currentBackgroundId';
        let currentBackgroundId = localStorage.getItem(CURRENT_BG_KEY) || null;
        let backgroundContainer;

        /** Sets the user's available backgrounds array. */
        window.setUserBackgrounds = (newBackgrounds) => {
            USER_BACKGROUNDS = newBackgrounds;
            
            // Check if the current ID is still valid, if not, pick the first one.
            const isCurrentValid = USER_BACKGROUNDS.some(bg => bg.id === currentBackgroundId);
            if (!isCurrentValid && USER_BACKGROUNDS.length > 0) {
                 // Set the first background as the default if the stored ID is invalid/deleted
                 currentBackgroundId = USER_BACKGROUNDS[0].id;
                 localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);
            } else if (USER_BACKGROUNDS.length === 0) {
                 currentBackgroundId = null;
                 localStorage.removeItem(CURRENT_BG_KEY);
            }
            
            // Update the display with the determined current background
            changeBackground(currentBackgroundId);
        }

        /** Sets the current background to the one matching the given ID. */
        const changeBackground = (backgroundId) => {
            if (!backgroundContainer) {
                backgroundContainer = document.getElementById('background-container');
            }
            
            // Find the background object
            const selectedBackground = USER_BACKGROUNDS.find(bg => bg.id === backgroundId);

            if (selectedBackground) {
                // Set as current and save to local storage
                currentBackgroundId = selectedBackground.id;
                localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);

                // Set the CSS background to the Base64 string
                backgroundContainer.style.backgroundImage = `url('${selectedBackground.base64}')`;
            } else {
                // Fallback if no backgrounds are available
                currentBackgroundId = null;
                localStorage.removeItem(CURRENT_BG_KEY);
                // NEW: Removed placeholder text for a smoother initial look (just dark background)
                backgroundContainer.style.backgroundImage = `url('data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 1 1\\'%3E%3Crect width=\\'1\\' height=\\'1\\' fill=\\'%230f172a\\'/%3E%3C/svg%3E')`; 
            }
        };

        /** Renders the gallery content inside the modal. */
        window.renderBackgroundGallery = (userBackgrounds) => {
            const galleryContainer = document.getElementById('background-gallery-grid');
            galleryContainer.innerHTML = ''; // Clear gallery

            if (userBackgrounds.length === 0) {
                 galleryContainer.innerHTML = '<p class="text-white/50 text-center col-span-full">No backgrounds uploaded yet. Use the form below to add one!</p>';
                 return;
            }

            userBackgrounds.forEach(bg => {
                const isSelected = bg.id === currentBackgroundId;
                const item = document.createElement('div');
                item.className = 'relative group';
                item.innerHTML = `
                    <div class="background-thumbnail rounded-xl overflow-hidden shadow-lg border-2" 
                         style="background-image: url('${bg.base64}');"
                         data-bg-id="${bg.id}"
                         title="Click to select: ${bg.name}">
                         </div>
                    <span class="absolute top-2 left-2 px-2 py-1 bg-black/50 text-white text-xs rounded-full opacity-80">${bg.name}</span>
                    <button onclick="window.db.deleteBackground('${bg.id}')"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-opacity opacity-0 group-hover:opacity-100"
                            title="Delete Background">
                        <span data-lucide="x" class="w-4 h-4"></span>
                    </button>
                `;

                // Add click listener to select background
                item.querySelector('.background-thumbnail').addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-bg-id');
                    changeBackground(id); // Set as current
                    
                    // Update visual selection in the gallery immediately
                    document.querySelectorAll('.background-thumbnail').forEach(el => el.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                });

                // Set the 'selected' class if this is the currently active background
                if (isSelected) {
                    item.querySelector('.background-thumbnail').classList.add('selected');
                }
                
                galleryContainer.appendChild(item);
            });
            lucide.createIcons(); // Initialize icons
        }
        // --- END Custom Background Logic ---


        // --- Mock Data and Configuration ---

        // Mock Assignments for fallback
        let MOCK_ASSIGNMENTS = [];
        const getMockAssignments = () => {
            if (MOCK_ASSIGNMENTS.length === 0) {
                const now = new Date();
                const tomorrow = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                const nextWeek = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));
                MOCK_ASSIGNMENTS = [
                    // Ensure mock deadlines are in the future for display
                    { id: 'mock1', title: 'Database Design Exam (Mock)', deadline: tomorrow, createdAt: new Date(), notes: 'Review normalization forms.' },
                    { id: 'mock2', title: 'Physics Lab Report (Mock)', deadline: nextWeek, createdAt: new Date(), notes: '' },
                ];
            }
            return MOCK_ASSIGNMENTS;
        };
        
        // NEW: Mock Finished Assignments
        let MOCK_FINISHED_ASSIGNMENTS = [];


        // Mock Bookmarks for fallback
        let MOCK_BOOKMARKS = [
            { id: 'bm1', name: "Gemini", url: "https://gemini.google.com/", icon: "sparkles" },
            { id: 'bm2', name: "GitHub", url: "https://github.com/", icon: "code" },
            // REMOVED THE 3RD BOOKMARK OPTION: { id: 'bm3', name: "Learn", url: "https://www.udemy.com/", icon: "book-open" },
            { id: 'bm4', name: "Mail", url: "https://mail.google.com/", icon: "mail" },
        ];
        
        // Mock Backgrounds for fallback (Simple placeholder)
        let MOCK_BACKGROUNDS = [
            { id: 'bg1', name: 'Mock Sunset', base64: 'https://placehold.co/1920x1080/1e3a8a/bfdbfe?text=MOCK+BACKGROUND' }
        ];

        // --- MCAST Links Data (New Section) ---
        const MCAST_LINKS = [
            // General Links
            { name: "MCAST Classter", url: "https://mcast.classter.com", icon: "school" },
            { name: "Dissertations (Moodle)", url: "https://moodle.mcast.edu.mt/enrol/index.php?id=251", icon: "book-open-check" },
            // Subject Links
            { name: "Systems Programming", url: "https://vle.mcast.edu.mt/course/view.php?id=5314", icon: "laptop" },
            { name: "Image Processing & Computer Vision", url: "https://vle.mcast.edu.mt/course/view.php?id=57", icon: "image" },
            { name: "Data Structures & Algorithms II", url: "https://vle.mcast.edu.mt/course/view.php?id=127", icon: "git-branch" },
            { name: "Statistics for Computer Science", url: "https://vle.mcast.edu.mt/course/view.php?id=133", icon: "bar-chart-2" },
        ];
        // --- END MCAST Links Data ---


        // --- Timetable Data (NEW SECTION) ---
        // Note: Time is stored as H:MM string for easy comparison.
        const TIMETABLE = {
            // Each day has an array of schedule items, ordered by start time
            Monday: [
                { start: "08:30", end: "10:30", title: "Statistics for Computer Science", location: "ICT-B03" },
                { start: "10:30", end: "11:30", title: "BREAK", location: null },
                { start: "11:30", end: "13:00", title: "Systems Programming", location: "ICT-209" },
                { start: "13:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Tuesday: [
                { start: "08:00", end: "10:00", title: "Image Processing and Computer Vision", location: "ICT-103" },
                { start: "10:00", end: "12:00", title: "BREAK", location: null },
                { start: "12:00", end: "14:00", title: "Data Structures And Algorithms II", location: "ICT-309" },
                { start: "14:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Wednesday: [
                { start: "08:00", end: "23:59", title: "FREE DAY / Independent Study", location: null },
            ],
            Thursday: [
                { start: "10:30", end: "12:30", title: "Systems Programming", location: "ICT-B02" },
                { start: "12:30", end: "14:00", title: "Data Structures And Algorithms II", location: "ICT-209" },
                { start: "14:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Friday: [
                { start: "08:30", end: "10:30", title: "Statistics for Computer Science", location: "ICT-B05" },
                { start: "10:30", end: "12:00", title: "Image Processing and Computer Vision", location: "ICT-103" },
                { start: "12:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Saturday: [
                { start: "08:00", end: "23:59", title: "WEEKEND", location: null },
            ],
            Sunday: [
                { start: "00:00", end: "23:59", title: "WEEKEND", location: null },
            ]
        };
        const DAYS_OF_WEEK = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let nextLessonInterval;

        // Function to convert "H:MM" to a total minutes from midnight
        const timeToMinutes = (time) => {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        // Function to find the next scheduled event
        const getNextScheduleItem = () => {
            const now = new Date();
            const dayIndex = now.getDay();
            const currentDayName = DAYS_OF_WEEK[dayIndex];
            const nowMinutes = now.getHours() * 60 + now.getMinutes();

            // 1. Check today's schedule
            let todaySchedule = TIMETABLE[currentDayName];
            
            // Filter out items that have already passed
            // We need to check if we are currently *in* a lesson or break
            let currentItem = todaySchedule.find(item => 
                 timeToMinutes(item.start) <= nowMinutes && timeToMinutes(item.end) > nowMinutes
            );

            if (currentItem && currentItem.title !== "END OF DAY" && currentItem.title !== "WEEKEND") {
                // If currently in a lesson/break, the next item is the one that starts right after it
                 let nextItem = todaySchedule.find(item => timeToMinutes(item.start) === timeToMinutes(currentItem.end));
                 
                 // If there's an immediate next item (e.g., break -> lesson) we show the *current* activity with a countdown to the *start* of the *next* activity.
                 if (nextItem) {
                     return {
                        ...currentItem, // Return the current item details
                        day: currentDayName,
                        isCurrent: true, 
                        // Details of the *next* item
                        nextTitle: nextItem.title,
                        nextLocation: nextItem.location,
                        nextStart: nextItem.start,
                        nextEnd: nextItem.end,
                        remainingMinutes: timeToMinutes(currentItem.end) - nowMinutes, // Countdown to end of current activity
                        remainingSeconds: (timeToMinutes(currentItem.end) * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()), // Countdown to end in seconds
                    };
                 }
                 
                 // If currentItem is the last activity of the day (e.g., Systems Programming 11:30-13:00 followed by END OF DAY)
                 // Then we fall through to look for the next event, which will be the next day's first lesson.
            }


            // Find the next item that hasn't started yet
            let nextItem = todaySchedule.find(item => timeToMinutes(item.start) > nowMinutes);

            if (nextItem && nextItem.title !== "END OF DAY") {
                // Found a lesson or break for today (which is NOT the current activity)
                return {
                    ...nextItem,
                    day: currentDayName,
                    remainingMinutes: timeToMinutes(nextItem.start) - nowMinutes,
                    remainingSeconds: (timeToMinutes(nextItem.start) * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()), // Countdown to start in seconds
                    isCurrent: false
                };
            }

            // 2. If nothing is left today (or it's weekend/after END OF DAY), find the first lesson of the next day.
            for (let i = 1; i <= 7; i++) {
                const nextDayIndex = (dayIndex + i) % 7;
                const nextDayName = DAYS_OF_WEEK[nextDayIndex];
                const nextDaySchedule = TIMETABLE[nextDayName];
                
                // Find the first scheduled event that isn't a weekend or end-of-day marker
                const firstEvent = nextDaySchedule.find(item => 
                    item.title !== "END OF DAY" &&
                    item.title !== "WEEKEND"
                );

                if (firstEvent) {
                     // Calculate time until next day's midnight + time until lesson start
                     let remainingDaySeconds = (24 * 60 * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()); // Seconds until midnight tonight
                     let totalSeconds = remainingDaySeconds;

                     // Add seconds for each full day in between (i-1 because we calculated the current day's remainder)
                     for(let j = 1; j < i; j++) {
                         totalSeconds += 24 * 60 * 60;
                     }
                     
                     // Add the seconds from midnight of the next day until the lesson starts
                     totalSeconds += timeToMinutes(firstEvent.start) * 60;
                     
                     return {
                        ...firstEvent,
                        day: nextDayName,
                        remainingMinutes: Math.ceil(totalSeconds / 60), // Keep for backward compatibility/quick check
                        remainingSeconds: totalSeconds, // Use total seconds for accurate display
                        isNextDay: true
                    };
                }
            }
            
            // Fallback for an unlikely scenario
            return { title: "Schedule Error", start: null, end: null, location: null, remainingMinutes: 0, remainingSeconds: 0 };
        };

        // Function to render the schedule widget
        const renderScheduleWidget = () => {
            const widgetEl = document.getElementById('next-lesson-widget');
            if (!widgetEl) return;

            const nextItem = getNextScheduleItem();
            
            // Extract properties. Use 'title', 'start', 'end', 'location' for the activity being displayed.
            let { title, start, end, location, remainingSeconds, day, isNextDay, isCurrent, nextTitle } = nextItem; 
            
            // Handle the countdown - Use remainingSeconds for accuracy
            const totalSeconds = remainingSeconds;
            const days = Math.floor(totalSeconds / (60 * 60 * 24));
            const hours = Math.floor((totalSeconds % (60 * 60 * 24)) / (60 * 60));
            const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
            const seconds = totalSeconds % 60; // seconds are still calculated for accuracy, but hidden from display

            let countdownHTML;
            let icon = "calendar";
            let statusClass = "text-blue-300";
            let subText = `Next Up: <span class="font-bold text-white">${title}</span>`;
            let timeRangeToDisplay = '';
            let locationPrefix = 'Location: ';


            if (isCurrent && totalSeconds > 0) {
                 // If currently in an activity, display that activity and count down to its end time
                 
                 statusClass = title === "BREAK" ? "text-green-300" : "text-purple-300";
                 icon = title === "BREAK" ? "coffee" : "hourglass";
                 
                 // Display the current activity as the main title
                 subText = `Currently in: <span class="font-bold text-white">${title}</span>`;
                 
                 // If there's a defined 'nextTitle', we can say 'until next lesson'
                 const countdownLabel = nextTitle ? `Until ${nextTitle}` : 'Until End';
                 
                 // MODIFIED: REMOVED SECONDS
                 countdownHTML = `<span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m left`;

                 // Display the current lesson's duration and location
                 timeRangeToDisplay = `${start} - ${end}`;
                 // Location is already correct (location of the current activity)

            } else if (days > 0) {
                // If more than a day away (i.e., next day's first lesson)
                // MODIFIED: REMOVED SECONDS
                countdownHTML = `<span class="font-bold">${days}</span>d <span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m`;
                icon = "calendar-check";
                statusClass = "text-yellow-300";
                subText = `First Lesson: <span class="font-bold text-white">${title}</span> (${day})`;
                timeRangeToDisplay = `${start} - ${end}`;
            } else if (totalSeconds > 0) {
                // If less than a day away (today's next lesson/break)
                // MODIFIED: REMOVED SECONDS
                countdownHTML = `<span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m`;
                if (title === "BREAK") {
                    icon = "coffee";
                    statusClass = "text-green-300";
                } else {
                    icon = "clock";
                    statusClass = "text-blue-300";
                }
                timeRangeToDisplay = `${start} - ${end}`;
            } else {
                // End of all scheduled activities or error/countdown expired
                countdownHTML = "Finished";
                icon = "sun";
                statusClass = "text-gray-400";
                subText = "Classes are over. Enjoy your evening!";
                location = '';
            }

            widgetEl.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <div class="flex items-center">
                        <span data-lucide="${icon}" class="w-5 h-5 mr-2 ${statusClass}"></span>
                        <p class="text-sm text-white/80">${subText}</p>
                    </div>
                    <p class="text-sm font-semibold ${statusClass}">${countdownHTML}</p>
                </div>
                <div class="flex justify-between items-center w-full mt-1 border-t border-white/10 pt-1">
                    <p class="text-xs text-white/60">${timeRangeToDisplay}</p>
                    <p class="text-xs text-white/60">${location ? locationPrefix + location : ''}</p>
                </div>
            `;

            lucide.createIcons(); // Re-initialize icons
        };
        // --- END Timetable Data and Logic ---


        // --- State Management ---
        let assignments = [];
        let finishedAssignments = []; // NEW: Array for completed assignments
        let bookmarks = []; 
        let countdownInterval;


        // --- Mock Data Setup (Called if Firestore is unavailable) ---
        window.setupMockData = () => {
            // Load mock bookmarks
            bookmarks = MOCK_BOOKMARKS;
            window.renderBookmarks(bookmarks);

            // Load mock assignments 
            assignments = getMockAssignments();
            window.renderAssignments(assignments);
            
            // Load mock finished assignments (NEW)
            const now = new Date();
            MOCK_FINISHED_ASSIGNMENTS = [
                { id: 'mockDone1', title: 'Calculus Midterm (Mock)', deadline: new Date(now.getTime() - 86400000), notes: 'Reviewed all topics.', completedAt: new Date(now.getTime() - 1000) },
                { id: 'mockDone2', title: 'Web Dev Project Part 1 (Mock)', deadline: new Date(now.getTime() - 7 * 86400000), notes: 'Submitted to Moodle.', completedAt: new Date(now.getTime() - 1000 * 60 * 60) }
            ];
            finishedAssignments = MOCK_FINISHED_ASSIGNMENTS;
            window.renderFinishedAssignments(finishedAssignments); // RENDER FINISHED ASSIGNMENTS

            // Load mock backgrounds
            window.setUserBackgrounds(MOCK_BACKGROUNDS);
            window.renderBackgroundGallery(MOCK_BACKGROUNDS); // RENDER GALLERY
            
            // Render MCAST links
            window.renderMCASTLinks();
            
            // Render Timetable Widget
            renderScheduleWidget();
            if (nextLessonInterval) {
                clearInterval(nextLessonInterval);
            }
            // MODIFIED: Update every second for accuracy (1000ms)
            nextLessonInterval = setInterval(renderScheduleWidget, 1000); 

            // Override global DB functions to only handle local state for mock mode
            window.db = {
                // Assignments Mock
                addAssignment: (title, deadlineDate) => {
                    const newAssignment = { id: crypto.randomUUID(), title: `${title} (Mock)`, deadline: deadlineDate, createdAt: new Date(), notes: '' };
                    assignments.push(newAssignment);
                    assignments.sort((a, b) => (a.deadline || 0) - (b.deadline || 0));
                    window.renderAssignments(assignments);
                    console.warn("MOCK MODE: Assignment added locally, but will NOT persist on refresh.");
                },
                
                // NEW: Mock function to update an existing assignment
                updateAssignment: (id, title, deadlineDate, notes) => {
                    const index = assignments.findIndex(a => a.id === id);
                    if (index !== -1) {
                        assignments[index].title = title;
                        assignments[index].deadline = deadlineDate;
                        assignments[index].notes = notes; // Update notes in mock data
                        // Re-render to show changes
                        window.renderAssignments(assignments);
                    }
                    console.warn(`MOCK MODE: Assignment '${title}' updated locally (not persistent).`);
                },
                
                deleteAssignment: (id) => {
                    assignments = assignments.filter(a => a.id !== id);
                    window.renderAssignments(assignments);
                    console.warn("MOCK MODE: Assignment deleted locally.");
                },

                // NEW: Mock function to move an active assignment to finished
                addFinishedAssignment: (assignmentData) => {
                    // Remove from active list *first* to prevent race condition/flicker
                    assignments = assignments.filter(a => a.id !== assignmentData.id);
                    window.renderAssignments(assignments);
                    
                    const newFinished = { ...assignmentData, id: crypto.randomUUID(), completedAt: new Date() };
                    finishedAssignments.unshift(newFinished); // Add to front
                    window.renderFinishedAssignments(finishedAssignments);
                    console.warn("MOCK MODE: Assignment marked as done locally, but will NOT persist on refresh.");
                },

                // NEW: Mock function to delete a finished assignment
                deleteFinishedAssignment: (id) => {
                    finishedAssignments = finishedAssignments.filter(a => a.id !== id);
                    window.renderFinishedAssignments(finishedAssignments);
                    console.warn("MOCK MODE: Finished assignment deleted locally.");
                },


                // Bookmarks Mock
                addBookmark: (name, url, icon) => {
                    const newBookmark = { id: crypto.randomUUID(), name: name, url: url, icon: icon };
                    bookmarks.push(newBookmark);
                    window.renderBookmarks(bookmarks);
                    console.warn(`MOCK MODE: Bookmark '${name}' added locally (not persistent).`);
                },
                deleteBookmark: (id) => {
                    bookmarks = bookmarks.filter(b => b.id !== id);
                    window.renderBookmarks(bookmarks);
                    console.warn("MOCK MODE: Bookmark deleted locally.");
                },

                // Backgrounds Mock
                addBackground: (base64String, fileName) => {
                    const newBackground = { id: crypto.randomUUID(), name: fileName, base64: base64String };
                    MOCK_BACKGROUNDS.push(newBackground);
                    window.setUserBackgrounds(MOCK_BACKGROUNDS);
                    window.renderBackgroundGallery(MOCK_BACKGROUNDS);
                    console.warn(`MOCK MODE: Background '${fileName}' added locally (not persistent).`);
                },
                deleteBackground: (id) => {
                    MOCK_BACKGROUNDS = MOCK_BACKGROUNDS.filter(b => b.id !== id);
                    window.setUserBackgrounds(MOCK_BACKGROUNDS);
                    window.renderBackgroundGallery(MOCK_BACKGROUNDS);
                    console.warn("MOCK MODE: Background deleted locally.");
                }
            };
        };


        // --- Utility Functions ---

        /** Pads a number with a leading zero if it's less than 10. */
        const padZero = (num) => String(Math.floor(num)).padStart(2, '0');

        /** Converts milliseconds into a countdown object {d, h, m, s} */
        const getTimeRemaining = (endTime) => {
            const total = endTime - new Date();
            const seconds = padZero((total / 1000) % 60);
            const minutes = padZero((total / (1000 * 60)) % 60);
            const hours = padZero((total / (1000 * 60 * 60)) % 24);
            const days = padZero(total / (1000 * 60 * 60 * 24));

            return { total, days, hours, minutes, seconds };
        };

        /** Converts a File object to a Base64 string. */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };
        
        /** Extracts the base domain from a full URL. */
        const getBaseDomain = (url) => {
            try {
                // Ensure URL has a protocol for parsing, add https if missing
                const safeUrl = url.startsWith('http') ? url : `https://${url}`;
                const domain = new URL(safeUrl).hostname;
                // Remove 'www.' prefix if present
                return domain.startsWith('www.') ? domain.substring(4) : domain;
            } catch (e) {
                console.error("Invalid URL for domain extraction:", url);
                return null;
            }
        };
        
        // REMOVED: Function to display the fixed version timestamp

        // --- NEW: Mark as Done Handler ---
        /** * Handles the "Mark as Done" action with an animation before moving and deletion.
         * @param {string} id - The Firestore/Mock ID of the assignment.
         * @param {string} elementId - The full DOM ID of the assignment item.
         */
        window.handleMarkAsDone = (id, elementId) => {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Find the full assignment object from the active list
            // We use the local array as it should be up-to-date from the latest listener snapshot
            const assignmentToMove = assignments.find(a => a.id === id);
            if (!assignmentToMove) return;


            // 1. Add the class to trigger the swipe animation
            element.classList.add('assignment-item-done', 'swipe-active');

            // 2. Wait for the swipe animation to complete (0.5s)
            setTimeout(() => {
                
                // 3. Trigger the delete/collapse animation by adding 'swipe-to-delete'
                element.classList.remove('assignment-item-done'); // Remove the animation base class
                element.classList.add('swipe-to-delete'); 
                
                // 4. Wait for the collapse animation to complete (0.5s)
                setTimeout(async () => {
                    // 5. Perform the actual data move (ADD to finished, DELETE from active)
                    if (window.db && window.db.addFinishedAssignment && window.db.deleteAssignment) {
                        // A. Add to finished collection
                        await window.db.addFinishedAssignment(assignmentToMove); 
                        // B. Delete from active collection (This triggers the assignments listener, re-rendering the active list)
                        await window.db.deleteAssignment(id);
                    } else {
                         // Fallback for an un-responsive/un-init db
                         element.remove();
                    }
                }, 500); // Wait for collapse/delete transition
                
            }, 500); // Wait for the swipe transition
        };


        // --- Rendering Functions (MODIFIED: target="_blank" removed) ---

        /** Renders the MCAST links list. */
        window.renderMCASTLinks = (newLinks) => {
            const container = document.getElementById('mcast-link-list');
            
            container.innerHTML = MCAST_LINKS.map(link => `
                <div class="mcast-link-item-wrap relative flex items-center group">
                    <a href="${link.url}" 
                       rel="noopener noreferrer"
                       title="${link.name}"
                       class="mcast-link-item block w-full text-left p-3 pr-4 rounded-xl bg-white/10 text-white hover:bg-white/20 backdrop-blur-sm transition-all duration-300">
                        <span data-lucide="${link.icon || 'link'}" class="inline-block w-4 h-4 mr-2"></span>
                        ${link.name}
                    </a>
                </div>
            `).join('');
            lucide.createIcons(); // Initialize icons
        };

        /** Renders the bookmarks from Firestore (or Mock Data). */
        window.renderBookmarks = (newBookmarks) => {
            bookmarks = newBookmarks;
            const container = document.getElementById('bookmark-container');
            container.innerHTML = bookmarks.map(b => {
                const domain = getBaseDomain(b.url);
                const faviconUrl = domain ? `https://s2.googleusercontent.com/s2/favicons?domain=${domain}&sz=64` : null;

                // Determine content of the bookmark tile
                // UPDATED: Lucide fallback icon size changed from w-8 h-8 to w-6 h-6
                const iconContent = faviconUrl 
                    ? `<img src="${faviconUrl}" alt="${b.name} Favicon" class="bookmark-favicon" onerror="this.outerHTML='<span data-lucide=${b.icon || 'link'} class=\\'w-6 h-6 text-white\\'></span>'"/>`
                    : `<span data-lucide="${b.icon || 'link'}" class="w-6 h-6 text-white"></span>`;


                return `
                <div class="bookmark-item-wrap relative">
                    <a href="${b.url}" rel="noopener noreferrer" title="${b.name}"
                        class="bookmark-icon flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/10 border border-white/20 rounded-2xl hover:border-blue-400">
                        ${iconContent}
                        <span class="text-xs text-white/80 mt-1 truncate max-w-full">${b.name}</span>
                    </a>
                    <button onclick="window.db.deleteBookmark('${b.id}')"
                            class="delete-btn absolute top-[-5px] right-[-5px] w-6 h-6 flex items-center justify-center bg-white/20 text-white rounded-full p-0.5 shadow-md hover:bg-white/40 transition-colors">
                        <span data-lucide="x" class="w-3 h-3"></span>
                    </button>
                </div>
                `;
            }).join('');

            // Add the 'Add Bookmark' button at the end
            container.innerHTML += `
                <button id="open-bookmark-modal-btn"
                        class="flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/5 border border-white/10 rounded-2xl text-white/50 hover:text-white hover:border-blue-500 transition-all duration-300"
                        title="Add New Bookmark">
                    <span data-lucide="plus" class="w-8 h-8"></span>
                    <span class="text-xs mt-1">Add</span>
                </button>
            `;
            
            // Re-attach event listener for the new button
            document.getElementById('open-bookmark-modal-btn')?.addEventListener('click', openBookmarkModal);

            lucide.createIcons();
        };

        /** Renders the assignment list and manages the countdown timer. */
        window.renderAssignments = (newAssignments) => {
            assignments = newAssignments;
            const list = document.getElementById('assignment-list');
            list.innerHTML = ''; // Clear existing list

            if (assignments.length === 0) {
                list.innerHTML = '<p class="text-white/50 text-center mt-4">No upcoming assignments. Add one!</p>';
            }

            assignments.forEach(assignment => {
                // Ensure deadline is a Date object before calculating
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);

                // START: MODIFICATION FOR DD/MM/YYYY FORMAT
                const day = String(deadlineDate.getDate()).padStart(2, '0');
                const month = String(deadlineDate.getMonth() + 1).padStart(2, '0');
                const year = deadlineDate.getFullYear();
                const formattedDate = `${day}/${month}/${year}`; // European format (dd/mm/yyyy)
                // END: MODIFICATION FOR DD/MM/YYYY FORMAT

                const countdownHTML = `
                    <div id="countdown-${assignment.id}" class="text-xs font-mono text-yellow-300 mt-1">
                        Calculating...
                    </div>
                `;
                
                const itemID = `assignment-item-${assignment.id}`;

                const item = document.createElement('div');
                item.id = itemID; // Add ID for better targeting
                // ADDED assignment-item-done CLASS for the swipe animation's ::before pseudo-element
                item.className = 'assignment-item assignment-item-done flex justify-between items-start p-3 rounded-lg bg-white/5 backdrop-blur-sm shadow-md transition-all duration-300 hover:bg-white/10'; 
                
                // MODIFIED: Added a 'Mark as Done' button next to the 'Delete' button.
                item.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-white">${assignment.title}</p>
                        <p class="text-xs text-white/70">${formattedDate}</p>
                        ${countdownHTML}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.handleMarkAsDone('${assignment.id}', '${itemID}')"
                                class="delete-btn text-green-400 hover:text-green-500 transition-colors duration-200 p-1 rounded"
                                title="Mark as Done">
                            <span data-lucide="check-square" class="w-4 h-4"></span>
                        </button>
                        <button onclick="window.db.deleteAssignment('${assignment.id}')"
                                class="delete-btn text-red-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"
                                title="Delete Assignment">
                            <span data-lucide="x" class="w-4 h-4"></span>
                        </button>
                    </div>
                `;
                list.appendChild(item);
                
                // NEW: Add click listener to open the Assignment Detail Modal
                item.addEventListener('click', (e) => {
                    // Prevent clicking the delete or done button from opening the detail modal
                    if (e.target.closest('.delete-btn')) {
                        return; 
                    }
                    openAssignmentDetailModal(assignment); // FIX: Removed 'window.'
                });
            });

            // Re-create lucide icons for the new elements
            lucide.createIcons();

            // Clear previous interval and start a new one
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            countdownInterval = setInterval(updateCountdowns, 1000);
        };
        
        /** Renders the finished assignment list. (NEW) */
        window.renderFinishedAssignments = (newFinishedAssignments) => {
            finishedAssignments = newFinishedAssignments;
            const list = document.getElementById('finished-assignment-list');
            const toggleBtn = document.getElementById('toggle-finished-btn');
            const btnTextSpan = toggleBtn.querySelector('span:last-child');
            list.innerHTML = ''; // Clear existing list

            if (finishedAssignments.length === 0) {
                list.innerHTML = '<p class="text-white/30 text-center mt-4 text-sm">No finished assignments recorded.</p>';
                // If list is empty, display (0) and disable the toggle
                btnTextSpan.textContent = "Finished Assignments (0)";
                toggleBtn.disabled = true;
                // Hide the list container if it was showing and now empty
                list.classList.add('hidden');
                return;
            }
            
            toggleBtn.disabled = false;
            btnTextSpan.textContent = `Finished Assignments (${finishedAssignments.length})`;


            finishedAssignments.forEach(assignment => {
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const completedAtDate = assignment.completedAt instanceof Date ? assignment.completedAt : new Date(assignment.completedAt);

                // START: MODIFICATION FOR DD/MM/YYYY FORMAT
                const day = String(deadlineDate.getDate()).padStart(2, '0');
                const month = String(deadlineDate.getMonth() + 1).padStart(2, '0');
                const year = deadlineDate.getFullYear();
                const formattedDate = `${day}/${month}/${year}`; // European format (dd/mm/yyyy)
                
                const completedDay = String(completedAtDate.getDate()).padStart(2, '0');
                const completedMonth = String(completedAtDate.getMonth() + 1).padStart(2, '0');
                const completedYear = completedAtDate.getFullYear();
                const formattedCompletedDate = `${completedDay}/${completedMonth}/${completedYear}`;
                // END: MODIFICATION FOR DD/MM/YYYY FORMAT

                const itemID = `finished-assignment-item-${assignment.id}`;

                const item = document.createElement('div');
                item.id = itemID; 
                // Uses custom finished-assignment-text style
                item.className = 'flex justify-between items-start p-3 rounded-lg bg-white/5 backdrop-blur-sm shadow-md transition-all duration-300 hover:bg-white/10 opacity-70 hover:opacity-100'; 
                
                item.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold finished-assignment-text">${assignment.title}</p>
                        <p class="text-xs finished-assignment-text">Due: ${formattedDate}</p>
                        <p class="text-xs text-green-400 mt-1">Completed: ${formattedCompletedDate}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.db.deleteFinishedAssignment('${assignment.id}')"
                                class="text-red-400 hover:text-red-500 transition-colors duration-200 p-1 rounded opacity-0 hover:opacity-100 transition-opacity"
                                title="Permanently Delete">
                            <span data-lucide="x" class="w-4 h-4"></span>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });

            // Re-create lucide icons for the new elements
            lucide.createIcons();
        };

        /** Updates the countdown display for all assignments every second. */
        const updateCountdowns = () => {
            assignments.forEach(assignment => {
                const countdownEl = document.getElementById(`countdown-${assignment.id}`);
                if (!countdownEl) return;

                const deadlineDate = assignment.deadline instanceof Date 
                    ? assignment.deadline 
                    : new Date(assignment.deadline);
                const remaining = getTimeRemaining(deadlineDate);
                const now = new Date();

                // Normalize both dates to ignore the time part
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const deadlineDay = new Date(deadlineDate.getFullYear(), deadlineDate.getMonth(), deadlineDate.getDate());

                // Check if deadline is today
                if (deadlineDay.getTime() === today.getTime()) {
                    countdownEl.innerHTML = '<span class="text-yellow-400 font-semibold">Due Today</span>';
                    return;
                }

                // Check if deadline has passed (strictly before today)
                if (deadlineDay.getTime() < today.getTime()) {
                    countdownEl.innerHTML = '<span class="text-red-500 font-bold">Deadline Passed</span>';
                    return;
                }

                // Otherwise show normal countdown
                countdownEl.innerHTML = `
                    <span class="font-bold">${remaining.days}</span>d
                    <span class="font-bold">${remaining.hours}</span>h
                    <span class="font-bold">${remaining.minutes}</span>m
                    <span class="font-bold">${remaining.seconds}</span>s
                `;
            });
        };


        
        /** Toggles the visibility of the finished assignments list. (NEW) */
        const toggleFinishedAssignments = () => {
            const list = document.getElementById('finished-assignment-list');
            const toggleBtn = document.getElementById('toggle-finished-btn');
            const icon = toggleBtn.querySelector('span[data-lucide]');

            list.classList.toggle('hidden');
            
            // Toggle the icon
            if (list.classList.contains('hidden')) {
                icon.setAttribute('data-lucide', 'chevrons-down');
            } else {
                icon.setAttribute('data-lucide', 'chevrons-up');
            }
            lucide.createIcons(); // Re-initialize icons for the change
        };


        // --- Modal Logic ---

        // Assignment Add Modal
        const openAssignmentModal = () => document.getElementById('assignment-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeAssignmentModal = () => document.getElementById('assignment-modal').classList.add('opacity-0', 'pointer-events-none');

        const handleAddAssignment = async () => {
            const titleInput = document.getElementById('assignment-title');
            const deadlineInput = document.getElementById('assignment-deadline');

            const title = titleInput.value.trim();
            const deadline = deadlineInput.value;

            if (!title || !deadline) {
                console.error('Validation Error: Please enter both a title and a deadline.');
                return;
            }

            try {
                const deadlineDate = new Date(deadline);
                
                await window.db.addAssignment(title, deadlineDate); 

                // Reset form and close modal
                titleInput.value = '';
                deadlineInput.value = '';
                closeAssignmentModal();
            } catch (error) {
                console.error("Failed to add assignment:", error);
            }
        };

        // --- NEW: Assignment Detail/Edit Modal Logic (from work.html) ---

        // Get modal elements - NOW DECLARED AS LET, ASSIGNED IN WINDOW.ONLOAD
        let detailModal; 
        let detailIdInput;
        let detailTitleInput;
        let detailDeadlineInput;
        let detailNoteInput;
        let deleteFromDetailBtn;
        let saveAssignmentBtn;
        let closeDetailModalBtn;


        /** Formats a Date object as a YYYY-MM-DD string for input type="date". */
        const formatDateForInput = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        /** Opens the detail modal and populates it with assignment data. */
        const openAssignmentDetailModal = (assignment) => {
            // FIX: These properties are now guaranteed to be non-null because they are assigned in window.onload
            // Set assignment ID and title
            detailIdInput.value = assignment.id;
            detailTitleInput.value = assignment.title;
            
            // Set deadline
            detailDeadlineInput.value = formatDateForInput(assignment.deadline);
            
            // Set notes: Use the 'notes' field from the assignment object.
            detailNoteInput.value = assignment.notes || ''; 

            // Show modal
            detailModal.classList.remove('opacity-0', 'pointer-events-none');
            detailTitleInput.focus();
        };

        /** Closes the detail modal and cleans up fields. */
        const closeAssignmentDetailModal = () => {
            detailModal.classList.add('opacity-0', 'pointer-events-none');
            // Clear old data when closing
            detailIdInput.value = '';
            detailTitleInput.value = '';
            detailDeadlineInput.value = '';
            detailNoteInput.value = '';
        };

        /** Handles saving the updated title, deadline, and notes. */
        const handleSaveDetailChanges = async () => {
            const id = detailIdInput.value;
            const newTitle = detailTitleInput.value.trim();
            const newDeadlineString = detailDeadlineInput.value;
            const newNotes = detailNoteInput.value;

            if (!newTitle) {
                alert("Assignment title cannot be empty.");
                return;
            }

            // Convert string deadline to Date object for the DB update
            const deadlineDate = newDeadlineString ? new Date(newDeadlineString) : null;
            
            // Update Assignment in DB/Mock (Title, Deadline, Notes)
            if (window.db && window.db.updateAssignment) {
                await window.db.updateAssignment(id, newTitle, deadlineDate, newNotes); 
            }

            closeAssignmentDetailModal();
        };

        /** Handles deleting the assignment from the detail modal. */
        const handleDeleteFromDetail = async () => {
            if (confirm("Are you sure you want to delete this assignment?")) {
                const id = detailIdInput.value;
                // Delete from persistence
                if (window.db && window.db.deleteAssignment) {
                    await window.db.deleteAssignment(id);
                }
                closeAssignmentDetailModal();
            }
        };


        // Bookmark Modal
        const openBookmarkModal = () => document.getElementById('bookmark-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBookmarkModal = () => document.getElementById('bookmark-modal').classList.add('opacity-0', 'pointer-events-none');

        const handleAddBookmark = async () => {
            const nameInput = document.getElementById('bookmark-name');
            const urlInput = document.getElementById('bookmark-url');
            // const iconInput = document.getElementById('bookmark-icon'); // Removed input
            
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            // Hardcode icon to 'link' since the input was removed
            const icon = 'link'; 

            if (!name || !url) {
                console.error('Validation Error: Please enter both a name and a URL.');
                return;
            }

            try {
                const validUrl = url.startsWith('http://') || url.startsWith('https://') || url.startsWith('file:///') ? url : `https://${url}`;

                await window.db.addBookmark(name, validUrl, icon);

                // Reset form and close modal
                nameInput.value = '';
                urlInput.value = '';
                // iconInput.value = ''; // Removed icon input reset
                closeBookmarkModal();
            } catch (error) {
                console.error("Failed to add bookmark:", error);
            }
        };
        
        // Background Gallery Modal (NEW)
        const openBackgroundGalleryModal = () => document.getElementById('background-gallery-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBackgroundGalleryModal = () => {
            document.getElementById('background-image-file').value = ''; // Reset file input
            document.getElementById('background-gallery-modal').classList.add('opacity-0', 'pointer-events-none');
        }

        const handleAddBackground = async () => {
            const fileInput = document.getElementById('background-image-file');
            const file = fileInput.files[0];
            const fileNameInput = document.getElementById('background-file-name');
            const fileName = fileNameInput.value.trim() || file.name;


            if (!file) {
                console.error('Validation Error: Please select an image file.');
                return;
            }
            
            // Basic file validation
            if (!file.type.startsWith('image/')) {
                 console.error('Validation Error: File must be an image.');
                 return;
            }
            
            // Limit file size to 2MB to prevent Firebase document size limit issues (1 MiB limit is the hard limit)
            const MAX_SIZE = 2 * 1024 * 1024; // 2MB
            if (file.size > MAX_SIZE) {
                alert('Image file is too large. Please upload an image under 2MB.');
                return;
            }

            try {
                // Convert to Base64
                const base64String = await fileToBase64(file);

                // Save to Firestore
                await window.db.addBackground(base64String, fileName);

                // Clear form inputs
                fileInput.value = ''; 
                fileNameInput.value = '';
                // The listener will automatically re-render the gallery and update the background.
            } catch (error) {
                console.error("Failed to add background:", error);
                alert("An error occurred during upload. Check console for details.");
            }
        };


        // --- Main Initialization ---
        window.onload = () => {
            // Initial background will be set by the listener fetching user data, 
            // but we call changeBackground(null) here to set the initial fallback image.
            changeBackground(currentBackgroundId); 
            
            // Explicitly call renderMCASTLinks to ensure the list displays immediately
            window.renderMCASTLinks(); 
            
            // Timetable Widget Update (Run now and set interval)
            renderScheduleWidget(); 
            if (nextLessonInterval) {
                clearInterval(nextLessonInterval);
            }
            // Update every second for accuracy (1000ms)
            nextLessonInterval = setInterval(renderScheduleWidget, 1000); 

            // REMOVED: setVersionTimestamp();

            // --- FIX START: Assigning modal elements inside window.onload ---
            detailModal = document.getElementById('assignment-detail-modal');
            detailIdInput = document.getElementById('detail-assignment-id');
            detailTitleInput = document.getElementById('detail-assignment-title');
            detailDeadlineInput = document.getElementById('detail-assignment-deadline');
            detailNoteInput = document.getElementById('detail-assignment-note');
            deleteFromDetailBtn = document.getElementById('delete-from-detail-btn');
            saveAssignmentBtn = document.getElementById('save-assignment-btn');
            closeDetailModalBtn = document.getElementById('close-detail-modal-btn');
            // --- FIX END ---


            // Attach event listeners for Assignment Add Modal
            document.getElementById('open-assignment-modal-btn').addEventListener('click', openAssignmentModal);
            document.getElementById('close-assignment-modal-btn').addEventListener('click', closeAssignmentModal);
            document.getElementById('add-assignment-btn').addEventListener('click', handleAddAssignment);
            
            // NEW: Attach event listeners for Assignment Detail/Edit Modal
            document.getElementById('close-detail-modal-btn')?.addEventListener('click', closeAssignmentDetailModal);
            document.getElementById('save-assignment-btn')?.addEventListener('click', handleSaveDetailChanges);
            document.getElementById('delete-from-detail-btn')?.addEventListener('click', handleDeleteFromDetail);
            
            // Add 'Escape' key listener to close the modal
            const detailModalEl = document.getElementById('assignment-detail-modal');
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && detailModalEl && !detailModalEl.classList.contains('opacity-0')) {
                    closeAssignmentDetailModal();
                }
            });

            // NEW: Attach event listener for the finished assignments toggle button
            document.getElementById('toggle-finished-btn')?.addEventListener('click', toggleFinishedAssignments);

            // Attach event listeners for Bookmark Modal
            document.getElementById('bookmark-container').addEventListener('click', (e) => {
                // Use closest to check if the click target or any parent is the add button
                if (e.target.closest('#open-bookmark-modal-btn')) {
                    openBookmarkModal();
                }
            });
            document.getElementById('close-bookmark-modal-btn').addEventListener('click', closeBookmarkModal);
            document.getElementById('add-bookmark-btn').addEventListener('click', handleAddBookmark);

            // Attach event listeners for Background Gallery Modal (NEW)
            document.getElementById('open-background-gallery-btn').addEventListener('click', openBackgroundGalleryModal);
            document.getElementById('close-background-gallery-modal-btn').addEventListener('click', closeBackgroundGalleryModal);
            document.getElementById('add-background-btn').addEventListener('click', handleAddBackground);


            // Search functionality
            document.getElementById('search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const query = document.getElementById('search-input').value;
                if (query) {
                    // Check if it looks like a URL starting with a domain (e.g., google.com or https://google.com)
                    if (query.includes('.') && !query.includes(' ')) {
                        let url = query.startsWith('http') ? query : `https://${query}`;
                        window.location.href = url;
                    } else {
                        // Use Google search URL
                        window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    }
                }
            });

            // The data listeners are now initiated inside initFirebase on successful authentication.
        };

    </script>
</head>
<body class="bg-gray-900">

    <div id="background-container"></div>

    <div class="scroll-container flex justify-center items-start lg:items-center">

        <div class="grid grid-cols-1 lg:grid-cols-7 gap-8 w-full max-w-7xl pt-16 lg:pt-0 pb-16">

            <div class="lg:col-span-2 p-6 bg-white/10 rounded-3xl backdrop-blur-xl shadow-2xl h-fit">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <span data-lucide="graduation-cap" class="w-6 h-6 mr-2 text-blue-400"></span>
                        MCAST Links
                    </h2>
                    </div>
                <div id="mcast-link-list" class="space-y-3">
                    </div>
            </div>

            <div class="lg:col-span-3 flex flex-col items-center justify-center p-6 space-y-8">
                
                <div id="next-lesson-widget" class="w-full max-w-2xl p-4 bg-white/10 rounded-xl backdrop-blur-md shadow-lg border border-white/20">
                    <p class="text-white/50 text-center">Loading timetable...</p>
                </div>
                <form id="search-form" class="w-full max-w-2xl relative">
                    <input type="text" id="search-input" placeholder="Search Google or type a URL..." 
                        class="w-full p-4 pl-12 pr-24 bg-white/90 text-gray-900 border-2 border-transparent focus:border-blue-500 rounded-full shadow-lg outline-none transition-all duration-300" 
                        autofocus>
                    <span data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500"></span>
                    
                    <a href="https://mail.google.com/" target="_blank" rel="noopener noreferrer" title="Gmail"
                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-red-600 transition-colors">
                        <span data-lucide="mail" class="w-5 h-5"></span>
                    </a>
                    
                    <a href="https://maps.google.com/" target="_blank" rel="noopener noreferrer" title="Google Maps"
                    class="absolute right-12 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-green-600 transition-colors">
                        <span data-lucide="map-pin" class="w-5 h-5"></span>
                    </a>
                    
                    <button type="submit" class="hidden">Search</button>
                </form>

                <div id="bookmark-container" class="grid grid-cols-4 gap-4 sm:gap-6 p-4 rounded-3xl bg-white/5 backdrop-blur-md shadow-inner max-w-2xl w-full">
                    </div>

                <div class="flex justify-center w-full">
                    <button id="open-background-gallery-btn"
                            class="flex items-center text-sm text-white/70 hover:text-white transition-colors p-3 rounded-full bg-white/10 hover:bg-white/20">
                        <span data-lucide="gallery-vertical" class="w-4 h-4 mr-2"></span>
                        Manage Backgrounds
                    </button>
                </div>

                <p id="user-id-display" class="text-xs text-white/50 mt-4"></p>
            </div>

            <div class="lg:col-span-2 p-5 bg-white/10 rounded-2xl backdrop-blur-xl shadow-lg h-fit">
    
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white flex items-center">
                    <span data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-green-400"></span>
                    Upcoming Assignments
                </h2>
                <button id="open-assignment-modal-btn"
                        class="w-8 h-8 flex items-center justify-center bg-green-500 text-white rounded-full shadow-md hover:bg-green-600 transition-transform transform hover:scale-110"
                        title="Add New Assignment">
                    <span data-lucide="plus" class="w-5 h-5"></span>
                </button>
            </div>

            <div id="assignment-list" class="space-y-4 max-h-96 overflow-y-auto scroll-container pr-2">
                </div>
            
                            
                <button id="toggle-finished-btn"
                        class="w-full mt-4 flex items-center justify-center p-2 rounded-xl bg-white/5 text-white/70 hover:bg-white/10 hover:text-white transition-colors"
                        title="Show/Hide Completed Assignments">
                    <span data-lucide="chevrons-down" class="w-4 h-4 mr-2"></span>
                    <span>Finished Assignments</span>
                </button>

                <div id="finished-assignment-list" class="space-y-3 mt-4 hidden">
                    </div>
            </div>
        </div>
    </div>

    <div id="assignment-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Add New Assignment</h3>
            <div class="space-y-4">
                <input type="text" id="assignment-title" placeholder="Assignment Title (e.g., Final Paper)"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                <input type="date" id="assignment-deadline"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none transition-colors">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-assignment-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                    Cancel
                </button>
                <button id="add-assignment-btn"
                        class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">
                    Save Assignment
                </button>
            </div>
        </div>
    </div>

    <div id="assignment-detail-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 id="detail-title" class="text-2xl font-bold text-white mb-6">Task Details</h3>
            <input type="hidden" id="detail-assignment-id">

            <div class="space-y-4">
                <label class="block text-white/70 text-sm font-semibold">Title</label>
                <input type="text" id="detail-assignment-title" 
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                
                <label class="block text-white/70 text-sm font-semibold">Deadline</label>
                <input type="date" id="detail-assignment-deadline"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none transition-colors">

                <label class="block text-white/70 text-sm font-semibold">Notes</label>
                <textarea id="detail-assignment-note" placeholder="Add detailed notes here..."
                          rows="5"
                          class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors resize-none"></textarea>
            </div>
            
            <div class="flex justify-between space-x-4 mt-6 border-t border-gray-700 pt-4">
                <button id="delete-from-detail-btn"
                        class="px-5 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700 font-semibold transition-colors">
                    Delete Task
                </button>
                <div class="flex space-x-4">
                    <button id="close-detail-modal-btn"
                            class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                        Cancel
                    </button>
                    <button id="save-assignment-btn"
                            class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="bookmark-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Add New Bookmark</h3>
            <div class="space-y-4">
                <input type="text" id="bookmark-name" placeholder="Name (e.g., Google News)"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                <input type="url" id="bookmark-url" placeholder="URL (e.g., https://news.google.com)"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-bookmark-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                    Cancel
                </button>
                <button id="add-bookmark-btn"
                        class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">
                    Save Bookmark
                </button>
            </div>
        </div>
    </div>

    <div id="background-gallery-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-4xl border border-gray-700 transform transition-all duration-300 scale-100 h-5/6 flex flex-col">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <span data-lucide="gallery-vertical" class="w-6 h-6 mr-2"></span>
                Manage Your Backgrounds
            </h3>

            <div class="flex-grow overflow-y-auto pr-2 mb-6 space-y-4">
                <h4 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Select or Delete</h4>
                <div id="background-gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    <p class="text-white/50 text-center col-span-full">Loading backgrounds...</p>
                </div>
                
                <h4 class="text-lg font-semibold text-white mb-3 pt-6 border-t border-gray-700 pt-4">Add New Background</h4>
                
                <div class="space-y-4">
                     <p class="text-sm text-white/70">Upload an image file (e.g., JPG, PNG). Max size: 2MB.</p>
                    <input type="text" id="background-file-name" placeholder="Optional: Give this background a name"
                            class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                    <input type="file" id="background-image-file" accept="image/*"
                            class="w-full text-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-auto border-t border-gray-700 pt-4">
                 <button id="close-background-gallery-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                    Close Gallery
                </button>
                <button id="add-background-btn"
                        class="px-5 py-2 rounded-xl bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors">
                    Upload Image
                </button>
            </div>
        </div>
    </div>
    
    <div id="version-timestamp">Last Update 10/11/2025 - 09:29</div>
    </body>


</html>

