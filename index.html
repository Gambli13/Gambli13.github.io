<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="images/redchrome.ico">
    <title>New Tab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Custom font and base styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        #background-container {
            background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 1 1\'%3E%3Crect width=\'1\' height=\'1\' fill=\'%230f172a\'/%3E%3C/svg%3E'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: background-image 1s ease-in-out;
        }
        .scroll-container {
            overflow-y: auto;
            height: 100vh;
            padding: 20px;
        }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }

        .bookmark-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .bookmark-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            border-color: #3b82f6;
        }
        
        .bookmark-favicon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.8));
        }

        .mcast-link-item {
            transition: background-color 0.3s, transform 0.3s;
            cursor: pointer;
        }
        .mcast-link-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .assignment-item:hover .delete-btn,
        .bookmark-item-wrap:hover .delete-btn {
            opacity: 1;
        }
        .assignment-item {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .background-thumbnail {
            width: 100%;
            padding-top: 56.25%;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s, opacity 0.3s;
        }
        .background-thumbnail:hover {
            border-color: #3b82f6;
            opacity: 0.8;
        }
        .background-thumbnail.selected {
            border-color: #10b981;
            border-width: 4px;
        }

        #version-timestamp {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 6px;
            backdrop-filter: blur(5px);
        }

        .assignment-item-done {
            position: relative;
            z-index: 1;
            transition: opacity 0.5s ease-out, height 0.5s ease-out, padding 0.5s ease-out, margin 0.5s ease-out;
        }
        .assignment-item-done::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            z-index: -1;
        }
        .assignment-item.swipe-to-delete {
            opacity: 0;
            height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
        .assignment-item-done.swipe-active::before {
            width: 100%;
        }
        
        .finished-assignment-text {
            color: rgba(255, 255, 255, 0.5);
            text-decoration: line-through;
        }
    </style>

    <script>
        const LOCAL_FIREBASE_CONFIG_JSON = JSON.stringify({
           apiKey: "AIzaSyDRYcVVOg_yzTbYQnBj7TxghX-2rNT3f3g",
           authDomain: "personalment-c1a9c.firebaseapp.com",
           projectId: "personalment-c1a9c",
           storageBucket: "personalment-c1a9c.firebasestorage.app",
           messagingSenderId: "461177689665",
           appId: "1:461177689665:web:bddc74fe94c21c097d18c0",
           measurementId: "G-RC5MS7QBNK"
        });
        const LOCAL_AUTH_TOKEN = null; 
    </script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, addDoc, deleteDoc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const STATIC_OVERRIDE_USER_ID = 'zNllEXqmHpaqNZffrgOhyPrSfBB3';
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const configSource = typeof __firebase_config !== 'undefined' ? __firebase_config : LOCAL_FIREBASE_CONFIG_JSON;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : LOCAL_AUTH_TOKEN;
    const firebaseConfig = JSON.parse(configSource);
    
    let db, auth, userId = null;
    let isAuthReady = false;

    setLogLevel('debug');

    const getCollectionPath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}_index`;

    const initFirebase = async () => {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken).catch(e => signInAnonymously(auth));
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                userId = STATIC_OVERRIDE_USER_ID; 
                isAuthReady = true;
                console.log("Firebase Auth Ready. User ID:", userId);
                setupDataListeners();
                document.getElementById('user-id-display').textContent = `Static User ID: ${userId}`;
            });

        } catch (error) {
            console.error("Firebase Initialization failed, falling back to Mock Mode:", error);
            window.setupMockData(); 
        }
    };

    // Utility to combine Date and optional Time for proper Date object creation (FIXED)
    // This uses local time components to avoid timezone misinterpretation, ensuring 23:59 is 23:59 local time.
    const createDeadlineDate = (dateString, timeString) => {
        if (!dateString) return null;

        // Default to end of day if no time is provided
        const time = timeString || '23:59'; 
        
        // Parse date parts (YYYY-MM-DD)
        const [year, month, day] = dateString.split('-').map(Number);
        // Parse time parts (HH:MM)
        const [hours, minutes] = time.split(':').map(Number);

        // Create a new Date object using local time constructor (month is 0-indexed).
        const deadlineDate = new Date(year, month - 1, day, hours, minutes);

        if (isNaN(deadlineDate.getTime())) {
            console.error("Invalid Date components provided.");
            return null;
        }

        return deadlineDate;
    };
    
    

    // Utility to parse ISO string and return Date object
    const parseDeadlineISO = (isoString) => {
        if (!isoString) return null;
        try {
            const date = new Date(isoString);
            return isNaN(date) ? null : date;
        } catch (e) {
            console.error("Error parsing deadline ISO:", e);
            return null;
        }
    }


    const setupDataListeners = () => {
        if (!db || !userId) return;

        // Helper to find the "real" deadline (earliest of main deadline OR unfinished subtasks)
        const getEffectiveDeadline = (assignment) => {
            let earliest = assignment.deadline || new Date(8640000000000000); // Default to far future if null
            
            if (assignment.subtasks && assignment.subtasks.length > 0) {
                 // Check only unfinished subtasks with valid deadlines
                 const activeSubtasks = assignment.subtasks.filter(t => !t.done && t.deadline);
                 if (activeSubtasks.length > 0) {
                     // Sort subtasks to find the very first one
                     activeSubtasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                     const subDeadline = new Date(activeSubtasks[0].deadline);
                     
                     // If subtask is sooner than main deadline, use that
                     if (subDeadline < earliest) {
                         earliest = subDeadline;
                     }
                 }
            }
            return earliest;
        };

        // 1. Assignments Listener
        onSnapshot(collection(db, getCollectionPath('assignments')), (snapshot) => {
            const assignments = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                const deadlineDate = parseDeadlineISO(data.deadline);
                
                assignments.push({ 
                    id: doc.id, 
                    ...data, 
                    deadline: deadlineDate 
                });
            });

            // UPDATED SORTING LOGIC
            assignments.sort((a, b) => {
                const dateA = getEffectiveDeadline(a);
                const dateB = getEffectiveDeadline(b);
                
                // 1. Primary Sort: Time Remaining (Earliest first)
                const diff = dateA - dateB;
                if (diff !== 0) return diff;
                
                // 2. Secondary Sort: Title (A-Z)
                // This forces "Task 2" to appear before "Task 3" when deadlines are equal
                return a.title.localeCompare(b.title);
            });

            window.renderAssignments(assignments);
            window.renderCalendar(); 
        });

        // 2. Bookmarks Listener
        onSnapshot(collection(db, getCollectionPath('bookmarks')), (snapshot) => {
            const loadedBookmarks = [];
            snapshot.forEach(doc => {
                loadedBookmarks.push({ id: doc.id, ...doc.data() });
            });
            loadedBookmarks.sort((a, b) => (a.order || 0) - (b.order || 0));
            window.renderBookmarks(loadedBookmarks);
        });
        
        // 3. Backgrounds Listener
        onSnapshot(collection(db, getCollectionPath('backgrounds')), (snapshot) => {
            const userBackgrounds = [];
            snapshot.forEach(doc => {
                userBackgrounds.push({ 
                    id: doc.id, 
                    name: doc.data().name || 'Background', 
                    base64: doc.data().base64,
                    uploadedAt: doc.data().uploadedAt || new Date(0).toISOString()
                });
            });
            userBackgrounds.sort((a, b) => b.uploadedAt.localeCompare(a.uploadedAt));
            window.setUserBackgrounds(userBackgrounds);
            window.renderBackgroundGallery(userBackgrounds);
        });
            
        // 4. Finished Assignments Listener
        onSnapshot(collection(db, getCollectionPath('finished_assignments')), (snapshot) => {
            const finished = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                let deadlineDate = parseDeadlineISO(data.deadline);
                let completedAtDate = data.completedAt ? new Date(data.completedAt) : new Date();

                finished.push({ id: doc.id, ...data, deadline: deadlineDate, completedAt: completedAtDate });
            });
            finished.sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));
            window.renderFinishedAssignments(finished);
        });
    };

    window.db = {
        // Now accepts a date string (YYYY-MM-DD) and an optional time string (HH:MM)
        addAssignment: async (title, dateString, timeString) => {
            if (!db || !userId || !dateString) return;
            try {
                const deadlineDate = createDeadlineDate(dateString, timeString);
                await addDoc(collection(db, getCollectionPath('assignments')), {
                    title: title,
                    // Store the combined ISO string in Firestore
                    deadline: deadlineDate.toISOString(), 
                    createdAt: new Date().toISOString(),
                    notes: '' 
                });
            } catch (e) { console.error(e); }
        },
        // Now accepts a date string (YYYY-MM-DD) and an optional time string (HH:MM)
        updateAssignment: async (id, title, dateString, timeString, notes, subtasks) => {
            if (!db || !userId) return;
            try {
                const deadlineDate = createDeadlineDate(dateString, timeString);
                const deadlineISO = deadlineDate ? deadlineDate.toISOString() : null;
                
                await setDoc(doc(db, getCollectionPath('assignments'), id), {
                    title: title,
                    deadline: deadlineISO, 
                    notes: notes || '',
                    // Save the subtasks array (default to empty array if null)
                    subtasks: subtasks || [] 
                }, { merge: true });
            } catch (e) { console.error(e); }
        },
        deleteAssignment: async (id) => {
            if (!db || !userId) return;
            try { await deleteDoc(doc(db, getCollectionPath('assignments'), id)); } catch (e) { console.error(e); }
        },
        addFinishedAssignment: async (assignmentData) => {
            if (!db || !userId) return;
            try {
                // assignmentData.deadline is already a Date object from the listener
                await addDoc(collection(db, getCollectionPath('finished_assignments')), {
                    ...assignmentData,
                    // Convert back to ISO string for storage
                    deadline: assignmentData.deadline instanceof Date ? assignmentData.deadline.toISOString() : assignmentData.deadline,
                    completedAt: new Date().toISOString()
                });
            } catch (e) { console.error(e); }
        },
        deleteFinishedAssignment: async (id) => {
            if (!db || !userId) return;
            try { await deleteDoc(doc(db, getCollectionPath('finished_assignments'), id)); } catch (e) { console.error(e); }
        },
        addBookmark: async (name, url, icon) => {
            if (!db || !userId) return;
            try {
                // Calculate new order index based on current count
                const currentCount = window.bookmarks ? window.bookmarks.length : 0;
                await addDoc(collection(db, getCollectionPath('bookmarks')), { 
                    name, 
                    url, 
                    icon,
                    order: currentCount // Save the order
                });
            } catch (e) { console.error(e); }
        },
        deleteBookmark: async (id) => {
            if (!db || !userId) return;
            try { await deleteDoc(doc(db, getCollectionPath('bookmarks'), id)); } catch (e) { console.error(e); }
        },
        // NEW: Batch update function for reordering
        reorderBookmarks: async (newBookmarkArray) => {
            if (!db || !userId) return;
            try {
                // We don't want to fire 8 separate network requests if we can avoid it,
                // but for simplicity in this setup, we will loop updates.
                // In a production app, you would use a Firebase Batch Write.
                const promises = newBookmarkArray.map((bm, index) => {
                    return setDoc(doc(db, getCollectionPath('bookmarks'), bm.id), {
                        order: index
                    }, { merge: true });
                });
                await Promise.all(promises);
            } catch (e) { console.error("Reorder failed", e); }
        },
        // FIXED: Now returns the ID of the new doc so we can select it immediately
        addBackground: async (base64String, fileName) => {
            if (!db || !userId) return null;
            try {
                const docRef = await addDoc(collection(db, getCollectionPath('backgrounds')), {
                    base64: base64String, 
                    name: fileName, 
                    uploadedAt: new Date().toISOString()
                });
                return docRef.id; // Return the new ID
            } catch (e) { 
                console.error("Firebase Upload Error:", e); 
                alert("Failed to upload. The image might still be too large even after compression.");
                return null;
            }
        },
        deleteBackground: async (id) => {
            if (!db || !userId) return;
            try { await deleteDoc(doc(db, getCollectionPath('backgrounds'), id)); } catch (e) { console.error(e); }
        },
    };

    
    initFirebase();
</script>

    <script>
        let USER_BACKGROUNDS = [];
        const CURRENT_BG_KEY = 'currentBackgroundId';
        let currentBackgroundId = localStorage.getItem(CURRENT_BG_KEY) || null;
        let backgroundContainer;

        // --- Calendar Logic Variables & Functions (MOVED TO GLOBAL SCOPE) ---
        // Initialize this globally, but we'll reset it on modal open.
        let currentCalendarDate = new Date(); 

        const openCalendarModal = () => {
            const modal = document.getElementById('calendar-modal');
            
            // --- FIX APPLIED HERE ---
            // Reset the calendar date to the current month/day/year every time the modal opens.
            currentCalendarDate = new Date(); 
            // -------------------------

            modal.classList.remove('opacity-0', 'pointer-events-none');
            renderCalendar();
        };

        const closeCalendarModal = (e) => {
            // Close if clicking the background overlay (id="calendar-modal")
            if (e.target.id === 'calendar-modal') {
                e.target.classList.add('opacity-0', 'pointer-events-none');
            }
        };

        const renderCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const monthYearTitle = document.getElementById('calendar-month-year');
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update Header
            monthYearTitle.textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentCalendarDate);

            // 1. Calculate Monday-Start alignment
            const firstDayRaw = new Date(year, month, 1).getDay();
            const firstDayIndex = (firstDayRaw === 0) ? 6 : firstDayRaw - 1; // 0 = Mon, 6 = Sun

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthLastDate = new Date(year, month, 0).getDate();
            const today = new Date();

            grid.innerHTML = '';

            // --- HELPER: Checks if two dates are the same day ---
            const isSameDay = (d1, d2) => {
                if (!d1 || !d2) return false;
                const date1 = d1 instanceof Date ? d1 : new Date(d1);
                const date2 = d2 instanceof Date ? d2 : new Date(d2);
                return date1.getDate() === date2.getDate() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getFullYear() === date2.getFullYear();
            };

            // --- HELPER: Renders a single cell for any given date ---
            const createDayCell = (dateObj, isCurrentMonth) => {
                const isToday = isCurrentMonth && isSameDay(dateObj, today);
                
                // --- COLLECT ITEMS FOR THIS DATE ---
                let itemsToRender = [];

                // 1. Active Assignments
                assignments.forEach(a => {
                    // A. Check Main Deadline
                    if (a.deadline && isSameDay(a.deadline, dateObj)) {
                        itemsToRender.push({
                            type: 'main',
                            data: a,
                            isFinished: false
                        });
                    }

                    // B. Check Subtask Deadlines
                    if (a.subtasks) {
                        a.subtasks.forEach(sub => {
                            // ONLY show subtask if it is on this day AND NOT on the same day as the main deadline
                            const isOnSameDayAsMain = a.deadline && isSameDay(sub.deadline, a.deadline);
                            
                            if (sub.deadline && isSameDay(sub.deadline, dateObj) && !isOnSameDayAsMain) {
                                itemsToRender.push({
                                    type: 'subtask',
                                    data: sub,
                                    parent: a, // Reference parent for modal
                                    isFinished: sub.done
                                });
                            }
                        });
                    }
                });

                // 2. Finished Assignments (Main only)
                finishedAssignments.forEach(a => {
                    if (a.deadline && isSameDay(a.deadline, dateObj)) {
                        itemsToRender.push({
                            type: 'main',
                            data: a,
                            isFinished: true
                        });
                    }
                });

                // Basic Cell Styling
                const bgClass = isCurrentMonth ? 'bg-gray-900' : 'bg-gray-900/40';
                const textClass = isCurrentMonth ? (isToday ? 'text-blue-400' : 'text-white/70') : 'text-gray-600';
                const borderClass = 'border-white/5';
                const ringClass = isToday ? 'ring-2 ring-inset ring-blue-500 bg-blue-900/10' : '';

                const cell = document.createElement('div');
                cell.className = `${bgClass} min-h-[120px] p-2 border ${borderClass} flex flex-col relative group transition-colors hover:bg-gray-800 ${ringClass}`;
                
                // Day Number
                cell.innerHTML = `<span class="font-bold text-sm mb-1 ${textClass}">${dateObj.getDate()}</span>`;
                
                // Render Items
                if (itemsToRender.length > 0) {
                    // Sort: Main tasks first, then subtasks
                    itemsToRender.sort((a, b) => (a.type === 'main' ? -1 : 1));

                    if (itemsToRender.length <= 3) {
                        itemsToRender.forEach(item => {
                            // Default styling for container
                            let classes = 'mt-1 p-1.5 rounded text-xs truncate shadow-sm select-none cursor-pointer border border-transparent ';
                            let style = '';
                            let content = '';
                            let clickHandler = '';

                            if (item.type === 'main') {
                                // --- MAIN ASSIGNMENT ---
                                const a = item.data;
                                
                                if (item.isFinished) {
                                    // 1. Finished/Archived State (Grey, Cutout)
                                    classes += 'bg-gray-600/40 text-white/50 line-through cursor-default';
                                    clickHandler = ''; 
                                } else {
                                    // 2. Active State (Check for Progress)
                                    let progressPercent = 0;
                                    if (a.subtasks && a.subtasks.length > 0) {
                                        const doneCount = a.subtasks.filter(t => t.done).length;
                                        progressPercent = (doneCount / a.subtasks.length) * 100;
                                    }

                                    if (progressPercent > 0) {
                                        // PROGRESS BAR: Green for done, Red for remaining
                                        // #10b981 is Green-500, #dc2626 is Red-600
                                        style = `background: linear-gradient(90deg, #10b981 ${progressPercent}%, #dc2626 ${progressPercent}%);`;
                                        classes += 'text-white border-white/10 hover:brightness-110';
                                    } else {
                                        // Standard Red (No Progress yet) - RESTORED RED COLOR
                                        classes += isCurrentMonth 
                                            ? 'bg-red-600/80 hover:bg-red-500 text-white' 
                                            : 'bg-blue-900/20 text-blue-200/50';
                                    }

                                    clickHandler = `openAssignmentDetailModal(assignments.find(x => x.id === '${a.id}')); 
                                                    document.getElementById('calendar-modal').classList.add('opacity-0', 'pointer-events-none'); 
                                                    event.stopPropagation();`;
                                }
                                content = a.title;

                            } else {
                                // --- SUBTASK STYLING ---
                                const sub = item.data;
                                const parent = item.parent;
                                
                                classes += item.isFinished 
                                    ? 'bg-gray-700/30 text-white/30 line-through' 
                                    : 'bg-purple-900/40 text-purple-200 hover:bg-purple-900/60 border-purple-500/20';
                                
                                content = `<span class="opacity-50 mr-1">↳</span> ${sub.text}`;
                                
                                clickHandler = `openAssignmentDetailModal(assignments.find(x => x.id === '${parent.id}')); 
                                                document.getElementById('calendar-modal').classList.add('opacity-0', 'pointer-events-none'); 
                                                event.stopPropagation();`;
                            }

                            const el = document.createElement('div');
                            el.className = classes;
                            if(style) el.style.cssText = style;
                            el.innerHTML = content;
                            el.title = item.type === 'main' ? item.data.title : item.data.text;
                            if(clickHandler) el.setAttribute('onclick', clickHandler);
                            
                            cell.appendChild(el);
                        });
                    } else {
                        // Collapse into "X Items" button if too many
                        const count = itemsToRender.length;
                        const assignmentBg = isCurrentMonth ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-800 text-gray-500';
                        const hiddenListId = `dropdown-${dateObj.getTime()}`;
                        
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = `
                            <div class="mt-1 p-1.5 rounded ${assignmentBg} text-xs font-bold text-center cursor-pointer shadow-sm select-none"
                                onclick="document.getElementById('${hiddenListId}').classList.toggle('hidden'); event.stopPropagation();">
                                ${count} Items
                            </div>
                            <div id="${hiddenListId}" class="hidden absolute top-full left-0 right-0 z-20 bg-gray-800 border border-gray-600 rounded-lg shadow-xl mt-1 overflow-hidden max-h-40 overflow-y-auto custom-scroll">
                                </div>
                        `;
                        cell.appendChild(wrapper);

                        const listContainer = wrapper.querySelector(`#${hiddenListId}`);
                        itemsToRender.forEach(item => {
                            const div = document.createElement('div');
                            const isSub = item.type === 'subtask';
                            const txt = isSub ? `↳ ${item.data.text}` : item.data.title;
                            const pid = isSub ? item.parent.id : item.data.id;
                            
                            div.className = "p-2 border-b border-gray-700 hover:bg-gray-700 text-xs text-white cursor-pointer truncate flex items-center";
                            if(item.isFinished) div.classList.add('line-through', 'opacity-50');
                            
                            // Dot Color: Purple for sub, Red for main
                            const dotColor = isSub ? 'bg-purple-500' : 'bg-red-500';
                            div.innerHTML = `<span class="w-1.5 h-1.5 rounded-full ${dotColor} mr-2 flex-shrink-0"></span>${txt}`;
                            
                            div.onclick = (e) => {
                                e.stopPropagation();
                                const target = assignments.find(x => x.id === pid);
                                if(target) openAssignmentDetailModal(target);
                                document.getElementById('calendar-modal').classList.add('opacity-0', 'pointer-events-none');
                            };
                            listContainer.appendChild(div);
                        });
                    }
                }

                return cell;
            };

            // 2. Render Previous Month padding days
            for (let i = firstDayIndex - 1; i >= 0; i--) {
                const dayNum = prevMonthLastDate - i;
                const dateObj = new Date(year, month - 1, dayNum);
                grid.appendChild(createDayCell(dateObj, false));
            }

            // 3. Render Current Month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(year, month, day);
                grid.appendChild(createDayCell(dateObj, true));
            }

            // 4. Render Next Month padding days
            const totalCellsFilled = firstDayIndex + daysInMonth;
            const remainingCells = (7 - (totalCellsFilled % 7)) % 7;
            
            for (let i = 1; i <= remainingCells; i++) {
                const dateObj = new Date(year, month + 1, i);
                grid.appendChild(createDayCell(dateObj, false));
            }

            lucide.createIcons();
        };
        // --- End Calendar Logic Functions ---

        window.setUserBackgrounds = (newBackgrounds) => {
            USER_BACKGROUNDS = newBackgrounds;
            
            // Check if the currently saved ID actually exists in the new list
            const isCurrentValid = USER_BACKGROUNDS.some(bg => bg.id === currentBackgroundId);
            
            if (!isCurrentValid && USER_BACKGROUNDS.length > 0) {
                 // If the saved background was deleted (or we are initializing), default to the newest one (index 0 because we sorted it)
                 currentBackgroundId = USER_BACKGROUNDS[0].id;
                 localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);
            } else if (USER_BACKGROUNDS.length === 0) {
                 // No backgrounds available
                 currentBackgroundId = null;
                 localStorage.removeItem(CURRENT_BG_KEY);
            }
            
            // Apply the background
            changeBackground(currentBackgroundId);
        }

        const changeBackground = (backgroundId) => {
            if (!backgroundContainer) backgroundContainer = document.getElementById('background-container');
            
            // FIX: If data hasn't loaded yet (length is 0), DO NOT delete the preference.
            // We just return early and wait for Firebase to load the list.
            if (USER_BACKGROUNDS.length === 0 && backgroundId) return;

            const selectedBackground = USER_BACKGROUNDS.find(bg => bg.id === backgroundId);
            
            if (selectedBackground) {
                currentBackgroundId = selectedBackground.id;
                localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);
                backgroundContainer.style.backgroundImage = `url('${selectedBackground.base64}')`;
            } else {
                // Only clear the preference if we actually have data loaded, implying the specific background was deleted.
                if (USER_BACKGROUNDS.length > 0) {
                    currentBackgroundId = null;
                    localStorage.removeItem(CURRENT_BG_KEY);
                }
                backgroundContainer.style.backgroundImage = `url('data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 1 1\\'%3E%3Crect width=\\'1\\' height=\\'1\\' fill=\\'%230f172a\\'/%3E%3C/svg%3E')`; 
            }
        };

        window.renderBackgroundGallery = (userBackgrounds) => {
            const galleryContainer = document.getElementById('background-gallery-grid');
            galleryContainer.innerHTML = ''; 
            if (userBackgrounds.length === 0) {
                 galleryContainer.innerHTML = '<p class="text-white/50 text-center col-span-full">No backgrounds uploaded yet. Use the form below to add one!</p>';
                 return;
            }
            userBackgrounds.forEach(bg => {
                const isSelected = bg.id === currentBackgroundId;
                const item = document.createElement('div');
                item.className = 'relative group';
                item.innerHTML = `
                    <div class="background-thumbnail rounded-xl overflow-hidden shadow-lg border-2" 
                         style="background-image: url('${bg.base64}');" data-bg-id="${bg.id}" title="Click to select: ${bg.name}"></div>
                    <span class="absolute top-2 left-2 px-2 py-1 bg-black/50 text-white text-xs rounded-full opacity-80">${bg.name}</span>
                    <button onclick="window.db.deleteBackground('${bg.id}')"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-opacity opacity-0 group-hover:opacity-100" title="Delete Background">
                        <span data-lucide="x" class="w-4 h-4"></span>
                    </button>
                `;
                item.querySelector('.background-thumbnail').addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-bg-id');
                    changeBackground(id); 
                    document.querySelectorAll('.background-thumbnail').forEach(el => el.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                });
                if (isSelected) item.querySelector('.background-thumbnail').classList.add('selected');
                galleryContainer.appendChild(item);
            });
            lucide.createIcons(); 
        }

        // Mock Data Setup
        window.setupMockData = () => {
            // Mock Bookmarks
            window.renderBookmarks([
                { id: 'bm1', name: "Gemini", url: "https://gemini.google.com/", icon: "sparkles" },
                { id: 'bm2', name: "GitHub", url: "https://github.com/", icon: "code" },
                { id: 'bm4', name: "Mail", url: "https://mail.google.com/", icon: "mail" },
            ]);

            // Mock Assignments 
            let mockAssignments = [
                { id: 'mock1', title: 'Database Design Exam (Mock)', deadline: new Date(new Date().getTime() + 86400000), createdAt: new Date(), notes: '' },
                { id: 'mock2', title: 'Physics Lab Report (Mock)', deadline: new Date(new Date().getTime() + 7 * 86400000), createdAt: new Date(), notes: '' },
            ];
            window.renderAssignments(mockAssignments);
            
            // Mock Finished
            window.renderFinishedAssignments([
                 { id: 'mockDone1', title: 'Calculus Midterm (Mock)', deadline: new Date(), completedAt: new Date() }
            ]);

            // Mock Backgrounds
            let backgrounds = [{ id: 'bg1', name: 'Mock Sunset', base64: 'https://placehold.co/1920x1080/1e3a8a/bfdbfe?text=MOCK+BACKGROUND' }];
            window.setUserBackgrounds(backgrounds);
            window.renderBackgroundGallery(backgrounds);
            
            window.renderMCASTLinks();
            renderScheduleWidget();
            setInterval(renderScheduleWidget, 1000); 

            // Local Override for Mock Logic
            window.db = {
                addAssignment: (title, dateString, timeString) => {
                    const time = timeString || '23:59';
                    const deadlineDate = new Date(`${dateString}T${time}:00`);
                    mockAssignments.push({ id: crypto.randomUUID(), title: `${title} (Mock)`, deadline: deadlineDate, createdAt: new Date(), notes: '' });
                    window.renderAssignments(mockAssignments);
                },
                updateAssignment: (id, title, dateString, timeString, notes) => { /* Update logic omitted for brevity in mock */ },
                deleteAssignment: (id) => {
                    mockAssignments = mockAssignments.filter(a => a.id !== id);
                    window.renderAssignments(mockAssignments);
                },
                addFinishedAssignment: (assignmentData) => {
                    mockAssignments = mockAssignments.filter(a => a.id !== assignmentData.id);
                    window.renderAssignments(mockAssignments);
                    window.renderFinishedAssignments([...window.finishedAssignments || [], { ...assignmentData, id: crypto.randomUUID() }]);
                },
                deleteFinishedAssignment: (id) => { /* */ },
                addBookmark: (name, url, icon) => { /* */ },
                deleteBookmark: (id) => { /* */ },
                addBackground: (b, n) => { /* */ },
                deleteBackground: (id) => { /* */ }
            };
        };

        // --- Timetable Data ---
        // Semester 1 Timetable
        // const TIMETABLE = {
        //     Monday: [
        //         { start: "08:30", end: "10:00", title: "Statistics for Computer Science", location: "ICT-B03" },
        //         { start: "10:00", end: "11:30", title: "BREAK", location: null },
        //         { start: "11:30", end: "13:00", title: "Systems Programming", location: "ICT-209" },
        //         { start: "13:00", end: "23:59", title: "END OF DAY", location: null },
        //     ],
        //     Tuesday: [
        //         { start: "08:00", end: "10:00", title: "Image Processing and Computer Vision", location: "ICT-103" },
        //         { start: "10:00", end: "12:00", title: "BREAK", location: null },
        //         { start: "12:00", end: "14:00", title: "Data Structures And Algorithms II", location: "ICT-309" },
        //         { start: "14:00", end: "23:59", title: "END OF DAY", location: null },
        //     ],
        //     Wednesday: [
        //         { start: "07:00", end: "15:30", title: "MITA Work", location: null },
        //         { start: "15:30", end: "23:59", title: "FREE", location: null },
        //     ],
        //     Thursday: [
        //         { start: "10:30", end: "12:30", title: "Systems Programming", location: "ICT-B02" },
        //         { start: "12:30", end: "14:00", title: "Data Structures And Algorithms II", location: "ICT-209" },
        //         { start: "14:00", end: "23:59", title: "END OF DAY", location: null },
        //     ],
        //     Friday: [
        //         { start: "08:30", end: "10:30", title: "Statistics for Computer Science", location: "ICT-B05" },
        //         { start: "10:30", end: "12:00", title: "Image Processing and Computer Vision", location: "ICT-103" },
        //         { start: "12:00", end: "23:59", title: "END OF DAY", location: null },
        //     ],
        //     Saturday: [{ start: "08:00", end: "23:59", title: "WEEKEND", location: null }],
        //     Sunday: [{ start: "00:00", end: "23:59", title: "WEEKEND", location: null }]
        // };
        // Semester 2 Timetable
        const TIMETABLE = {
            Monday: [
                { start: "09:00", end: "10:30", title: "Research Design II", location: "ICT-304" },
                { start: "10:30", end: "12:00", title: "Business Intelligence & Reporting", location: "ICT-202" },
                { start: "12:00", end: "12:30", title: "BREAK", location: null },
                { start: "12:30", end: "14:30", title: "Programming for the Cloud", location: "ICT-209" },
                { start: "14:30", end: "23:59", title: "END OF DAY", location: null },
            ],
            Tuesday: [
                { start: "08:00", end: "10:00", title: "Business Intelligence & Reporting", location: "ICT-204" },
                { start: "10:00", end: "23:59", title: "END OF DAY", location: null },
            ],
            Wednesday: [
                { start: "07:00", end: "15:30", title: "MITA Work", location: null },
                { start: "15:30", end: "23:59", title: "FREE", location: null },
            ],
            Thursday: [
                { start: "11:00", end: "13:00", title: "Research Design II", location: "ICT-301" },
                { start: "13:00", end: "14:30", title: "Distributed Programming", location: "ICT-304" },
                { start: "14:30", end: "23:59", title: "END OF DAY", location: null },
            ],
            Friday: [
                { start: "09:30", end: "11:30", title: "Distributed Programming", location: "ICT-209" },
                { start: "11:30", end: "12:00", title: "BREAK", location: null },
                { start: "12:00", end: "13:30", title: "Programming for the Cloud", location: "ICT-204" },
                { start: "13:30", end: "23:59", title: "END OF DAY", location: null },
            ],
            Saturday: [{ start: "08:00", end: "23:59", title: "WEEKEND", location: null }],
            Sunday: [{ start: "00:00", end: "23:59", title: "WEEKEND", location: null }]
        };
        const DAYS_OF_WEEK = ["Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let nextLessonInterval;

        const timeToMinutes = (time) => {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        const getNextScheduleItem = () => {
            const now = new Date();
            const dayIndex = now.getDay();
            const currentDayName = DAYS_OF_WEEK[dayIndex];
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            let todaySchedule = TIMETABLE[currentDayName];
            
            let currentItem = todaySchedule.find(item => 
                 timeToMinutes(item.start) <= nowMinutes && timeToMinutes(item.end) > nowMinutes
            );

            if (currentItem && currentItem.title !== "END OF DAY" && currentItem.title !== "WEEKEND") {
                 let nextItem = todaySchedule.find(item => timeToMinutes(item.start) === timeToMinutes(currentItem.end));
                 if (nextItem) {
                     return {
                        ...currentItem, 
                        day: currentDayName, isCurrent: true, 
                        nextTitle: nextItem.title, nextLocation: nextItem.location, nextStart: nextItem.start, nextEnd: nextItem.end,
                        remainingMinutes: timeToMinutes(currentItem.end) - nowMinutes, 
                        remainingSeconds: (timeToMinutes(currentItem.end) * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()),
                    };
                 }
            }

            let nextItem = todaySchedule.find(item => timeToMinutes(item.start) > nowMinutes);
            if (nextItem && nextItem.title !== "END OF DAY") {
                return {
                    ...nextItem, day: currentDayName,
                    remainingMinutes: timeToMinutes(nextItem.start) - nowMinutes,
                    remainingSeconds: (timeToMinutes(nextItem.start) * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()),
                    isCurrent: false
                };
            }

            for (let i = 1; i <= 7; i++) {
                const nextDayIndex = (dayIndex + i) % 7;
                const nextDayName = DAYS_OF_WEEK[nextDayIndex];
                const nextDaySchedule = TIMETABLE[nextDayName];
                const firstEvent = nextDaySchedule.find(item => item.title !== "END OF DAY" && item.title !== "WEEKEND");
                if (firstEvent) {
                     let remainingDaySeconds = (24 * 60 * 60) - (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds());
                     let totalSeconds = remainingDaySeconds;
                     for(let j = 1; j < i; j++) totalSeconds += 24 * 60 * 60;
                     totalSeconds += timeToMinutes(firstEvent.start) * 60;
                     
                     return {
                        ...firstEvent, day: nextDayName, remainingMinutes: Math.ceil(totalSeconds / 60), remainingSeconds: totalSeconds, isNextDay: true
                    };
                }
            }
            return { title: "Schedule Error", start: null, end: null, location: null, remainingMinutes: 0, remainingSeconds: 0 };
        };

        const renderScheduleWidget = () => {
            const widgetEl = document.getElementById('next-lesson-widget');
            if (!widgetEl) return;
            const nextItem = getNextScheduleItem();
            let { title, start, end, location, remainingSeconds, day, isNextDay, isCurrent, nextTitle } = nextItem; 
            
            const totalSeconds = remainingSeconds;
            const days = Math.floor(totalSeconds / (60 * 60 * 24));
            const hours = Math.floor((totalSeconds % (60 * 60 * 24)) / (60 * 60));
            const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);

            let countdownHTML;
            let icon = "calendar";
            let statusClass = "text-blue-300";
            let subText = `Next Up: <span class="font-bold text-white">${title}</span>`;
            let timeRangeToDisplay = '';
            let locationPrefix = 'Location: ';

            if (isCurrent && totalSeconds > 0) {
                 statusClass = title === "BREAK" ? "text-green-300" : "text-purple-300";
                 icon = title === "BREAK" ? "coffee" : "hourglass";
                 subText = `Currently in: <span class="font-bold text-white">${title}</span>`;
                 countdownHTML = `<span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m left`;
                 timeRangeToDisplay = `${start} - ${end}`;
            } else if (days > 0) {
                countdownHTML = `<span class="font-bold">${days}</span>d <span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m`;
                icon = "calendar-check";
                statusClass = "text-yellow-300";
                subText = `First Lesson: <span class="font-bold text-white">${title}</span> (${day})`;
                timeRangeToDisplay = `${start} - ${end}`;
            } else if (totalSeconds > 0) {
                countdownHTML = `<span class="font-bold">${hours}</span>h <span class="font-bold">${minutes}</span>m`;
                icon = title === "BREAK" ? "coffee" : "clock";
                statusClass = title === "BREAK" ? "text-green-300" : "text-blue-300";
                timeRangeToDisplay = `${start} - ${end}`;
            } else {
                countdownHTML = "Finished";
                icon = "sun";
                statusClass = "text-gray-400";
                subText = "Classes are over. Enjoy your evening!";
                location = '';
            }

            widgetEl.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <div class="flex items-center">
                        <span data-lucide="${icon}" class="w-5 h-5 mr-2 ${statusClass}"></span>
                        <p class="text-sm text-white/80">${subText}</p>
                    </div>
                    <p class="text-sm font-semibold ${statusClass}">${countdownHTML}</p>
                </div>
                <div class="flex justify-between items-center w-full mt-1 border-t border-white/10 pt-1">
                    <p class="text-xs text-white/60">${timeRangeToDisplay}</p>
                    <p class="text-xs text-white/60">${location ? locationPrefix + location : ''}</p>
                </div>
            `;
            lucide.createIcons(); 
        };

        // --- General State ---
        let assignments = [];
        let finishedAssignments = [];
        let bookmarks = []; 
        let countdownInterval;

        // --- Utils ---
        const padZero = (num) => String(Math.floor(num)).padStart(2, '0');
        const getTimeRemaining = (endTime) => {
            const total = endTime - new Date();
            return { 
                total, 
                days: padZero(total / (1000 * 60 * 60 * 24)), 
                hours: padZero((total / (1000 * 60 * 60)) % 24), 
                minutes: padZero((total / (1000 * 60)) % 60), 
                seconds: padZero((total / 1000) % 60) 
            };
        };
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };
        const getBaseDomain = (url) => {
            try {
                const safeUrl = url.startsWith('http') ? url : `https://${url}`;
                const domain = new URL(safeUrl).hostname;
                return domain.startsWith('www.') ? domain.substring(4) : domain;
            } catch (e) { return null; }
        };
        
        const formatDateForInput = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        // Utility to format time for display (MODIFIED)
        // This now explicitly returns '23:59' when it is the default, instead of hiding it.
        const formatTimeForInput = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            // Always return the time part for display (which will be '23:59' if defaulted)
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        window.handleMarkAsDone = (id, elementId) => {
            const element = document.getElementById(elementId);
            if (!element) return;
            const assignmentToMove = assignments.find(a => a.id === id);
            if (!assignmentToMove) return;

            element.classList.add('assignment-item-done', 'swipe-active');
            setTimeout(() => {
                element.classList.remove('assignment-item-done');
                element.classList.add('swipe-to-delete'); 
                setTimeout(async () => {
                    if (window.db && window.db.addFinishedAssignment && window.db.deleteAssignment) {
                        await window.db.addFinishedAssignment(assignmentToMove); 
                        await window.db.deleteAssignment(id);
                    } else { element.remove(); }
                }, 500);
            }, 500);
        };

        // 1. Defined Link Groups
        const LINK_DATA = {
            semester1: [
                { name: "MCAST VLE", url: "https://vle.mcast.edu.mt/my/", icon: "graduation-cap" },
                { name: "MCAST Classter", url: "https://mcast.classter.com", icon: "school" },
                { name: "Dissertations & SOI", url: "https://vle.mcast.edu.mt/course/view.php?id=2892 ", icon: "book-open-text"} ,
                { name: "Systems Programming", url: "https://vle.mcast.edu.mt/course/view.php?id=5314", icon: "laptop" },
                { name: "Image Processing & Computer Vision", url: "https://vle.mcast.edu.mt/course/view.php?id=57", icon: "image" },
                { name: "Data Structures & Algorithms II", url: "https://vle.mcast.edu.mt/course/view.php?id=127", icon: "git-branch" },
                { name: "Statistics for Computer Science", url: "https://vle.mcast.edu.mt/course/view.php?id=133", icon: "bar-chart-2" },
            ],
            semester2: [
                { name: "MCAST VLE", url: "https://vle.mcast.edu.mt/my/", icon: "graduation-cap" },
                { name: "MCAST Classter", url: "https://mcast.classter.com", icon: "school" },
                { name: "Dissertations & SOI", url: "https://vle.mcast.edu.mt/course/view.php?id=2892 ", icon: "book-open-text"} ,
                { name: "Research Design II", url: "https://vle.mcast.edu.mt/course/view.php?id=3606", icon: "book-open-text" },
                { name: "Business Intelligence & Reporting", url: "https://vle.mcast.edu.mt/course/view.php?id=5462", icon: "pie-chart" },
                { name: "Programming for the Cloud", url: "#", icon: "cloud" },
                { name: "Distributed Programming", url: "#", icon: "network" },
            ]
        };

        // Initialize from LocalStorage or default to 'semester1'
        let currentLinkMode = localStorage.getItem('mcastLinkMode') || 'semester1';

        // 2. The Toggle Function with Animation
        window.toggleMcastLinks = () => {
            const container = document.getElementById('mcast-link-list');
            const titleSpan = document.getElementById('mcast-section-title');
            const icon = document.getElementById('swap-icon');

            // 1. Slide OUT to the left
            container.classList.add('opacity-0', '-translate-x-10');
            
            // Optional: Rotate the icon
            if(icon) icon.classList.add('rotate-180');

            setTimeout(() => {
                // 2. Switch Data & Save to LocalStorage
                currentLinkMode = currentLinkMode === 'semester1' ? 'semester2' : 'semester1';
                localStorage.setItem('mcastLinkMode', currentLinkMode);
                
                // 3. Update Title Text
                if(titleSpan) titleSpan.textContent = currentLinkMode === 'semester1' ? 'MCAST Semester 1' : 'MCAST Semester 2';

                // 4. Render New Items
                renderMCASTLinks();

                // 5. Prepare for Slide IN (Move to right side invisibly)
                container.classList.remove('-translate-x-10');
                container.classList.add('translate-x-10');

                // 6. Force Reflow (Browser needs to realize element moved)
                void container.offsetWidth; 

                // 7. Slide IN to center
                container.classList.remove('opacity-0', 'translate-x-10');
                if(icon) icon.classList.remove('rotate-180');

            }, 300); // Wait 300ms for the slide-out animation to finish
        };

        // 3. The Render Function
        window.renderMCASTLinks = () => {
            const container = document.getElementById('mcast-link-list');
            const titleSpan = document.getElementById('mcast-section-title');
            
            // Ensure title matches current mode on load
            if(titleSpan) titleSpan.textContent = currentLinkMode === 'semester1' ? 'MCAST Semester 1' : 'MCAST Semester 2';

            const linksToRender = LINK_DATA[currentLinkMode];
            
            // Reset container style for base state
            container.className = "space-y-3 transition-all duration-300 ease-in-out transform";

            container.innerHTML = linksToRender.map(link => `
                <div class="mcast-link-item-wrap relative flex items-center group">
                    <a href="${link.url}" rel="noopener noreferrer" title="${link.name}"
                       class="mcast-link-item block w-full text-left p-3 pr-4 rounded-xl bg-white/10 text-white hover:bg-white/20 backdrop-blur-sm transition-all duration-300">
                        <span data-lucide="${link.icon || 'link'}" class="inline-block w-4 h-4 mr-2"></span>
                        ${link.name}
                    </a>
                </div>
            `).join('');
            lucide.createIcons(); 
        };

        // --- Drag and Drop Logic ---
        let draggedItem = null;

        window.handleDragStart = (e, id) => {
            draggedItem = bookmarks.find(b => b.id === id);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.dropEffect = 'move';

            // 1. Set the "Floating Square" as the drag image
            const dragIcon = e.currentTarget.querySelector('.bookmark-icon');
            if (dragIcon) {
                // Center the ghost image on the mouse
                e.dataTransfer.setDragImage(dragIcon, dragIcon.offsetWidth / 2, dragIcon.offsetHeight / 2);
            }

            // 2. Fade out the original element slightly
            setTimeout(() => {
                const el = document.getElementById(`bookmark-wrap-${id}`);
                if(el) el.classList.add('dragging');
            }, 0);
        };

        window.handleDragEnd = (e, id) => {
            const el = document.getElementById(`bookmark-wrap-${id}`);
            if(el) el.classList.remove('dragging');
            
            // Clean up any leftover 'drag-over' classes
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedItem = null;
        };

        window.handleDragEnter = (e, targetId) => {
            e.preventDefault();
            // Don't highlight if hovering over itself
            if (draggedItem && draggedItem.id !== targetId) {
                const el = document.getElementById(`bookmark-wrap-${targetId}`);
                if(el) el.classList.add('drag-over');
            }
        };

        window.handleDragLeave = (e, targetId) => {
            const el = document.getElementById(`bookmark-wrap-${targetId}`);
            // Only remove if we are actually leaving the element rect
            // (Simple check: just remove it, dragEnter adds it back quickly if still there)
            if(el) el.classList.remove('drag-over');
        };

        window.handleDragOver = (e) => {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';
        };

        window.handleDrop = async (e, targetId) => {
            e.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            
            if (!draggedItem || draggedItem.id === targetId) return;

            // 1. Reorder the array locally
            const oldIndex = bookmarks.findIndex(b => b.id === draggedItem.id);
            const newIndex = bookmarks.findIndex(b => b.id === targetId);

            if (oldIndex === -1 || newIndex === -1) return;

            // Remove from old position
            const [movedItem] = bookmarks.splice(oldIndex, 1);
            // Insert at new position
            bookmarks.splice(newIndex, 0, movedItem);

            // 2. CRITICAL FIX: Update the 'order' property on ALL items immediately
            bookmarks.forEach((bm, index) => {
                bm.order = index;
            });

            // 3. Render immediately with the new order
            window.renderBookmarks(bookmarks);

            // 4. Save new order to Database (Persist on refresh)
            await window.db.reorderBookmarks(bookmarks);
        };

       window.renderBookmarks = (newBookmarks) => {
            // Sort bookmarks by 'order'
            bookmarks = newBookmarks.sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const container = document.getElementById('bookmark-container');
            
            const htmlContent = bookmarks.map(b => {
                // ... (Keep existing mapping logic for htmlContent) ...
                const domain = getBaseDomain(b.url);
                const faviconUrl = domain ? `https://s2.googleusercontent.com/s2/favicons?domain=${domain}&sz=64` : null;
                const iconContent = faviconUrl 
                    ? `<img src="${faviconUrl}" alt="${b.name}" draggable="false" class="bookmark-favicon" onerror="this.outerHTML='<span data-lucide=${b.icon || 'link'} class=\\'w-6 h-6 text-white\\'></span>'"/>`
                    : `<span data-lucide="${b.icon || 'link'}" class="w-6 h-6 text-white"></span>`;

                return `
                <div id="bookmark-wrap-${b.id}" 
                    class="bookmark-item-wrap relative"
                    draggable="true"
                    ondragstart="window.handleDragStart(event, '${b.id}')"
                    ondragend="window.handleDragEnd(event, '${b.id}')"
                    ondragenter="window.handleDragEnter(event, '${b.id}')"
                    ondragleave="window.handleDragLeave(event, '${b.id}')"
                    ondragover="window.handleDragOver(event)"
                    ondrop="window.handleDrop(event, '${b.id}')">
                    
                    <a href="${b.url}" rel="noopener noreferrer" title="${b.name}" draggable="false"
                        class="bookmark-icon flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/10 border border-white/20 rounded-2xl hover:border-blue-400 select-none">
                        ${iconContent}
                        <span class="text-xs text-white/80 mt-1 truncate max-w-full pointer-events-none">${b.name}</span>
                    </a>
                    
                    <button onclick="window.db.deleteBookmark('${b.id}')"
                            class="delete-btn absolute top-[-5px] right-[-5px] w-6 h-6 flex items-center justify-center bg-white/20 text-white rounded-full p-0.5 shadow-md hover:bg-white/40 transition-colors">
                        <span data-lucide="x" class="w-3 h-3"></span>
                    </button>
                </div>
                `;
            }).join('');

            // REMOVED the "if (bookmarks.length < 8)" check
                container.innerHTML = htmlContent + `
                    <button id="open-bookmark-modal-btn"
                            class="flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/5 border border-white/10 rounded-2xl text-white/50 hover:text-white hover:border-blue-500 transition-all duration-300">
                        <span data-lucide="plus" class="w-8 h-8"></span>
                        <span class="text-xs mt-1">Add</span>
                    </button>
                `;

                const addBtn = document.getElementById('open-bookmark-modal-btn');
                if (addBtn) addBtn.addEventListener('click', openBookmarkModal);
                
                lucide.createIcons();
            };

        window.renderAssignments = (newAssignments) => {
            assignments = newAssignments;
            const list = document.getElementById('assignment-list');
            list.innerHTML = ''; 
            if (assignments.length === 0) {
                list.innerHTML = '<p class="text-white/50 text-center mt-4">No upcoming assignments. Add one!</p>';
            }
            assignments.forEach(assignment => {
                const deadlineDate = assignment.deadline; // Already a Date object
                
                let dateDisplay = '';
                if (deadlineDate instanceof Date && !isNaN(deadlineDate)) {
                    const datePart = `${String(deadlineDate.getDate()).padStart(2, '0')}/${String(deadlineDate.getMonth() + 1).padStart(2, '0')}/${deadlineDate.getFullYear()}`;
                    const timePart = formatTimeForInput(deadlineDate); // Get the time part, empty if it's the default 23:59
                    dateDisplay = datePart + (timePart ? ` at ${timePart}` : '');
                } else {
                    dateDisplay = 'No Deadline';
                }

                const countdownHTML = `<div id="countdown-${assignment.id}" class="text-xs font-mono text-yellow-300 mt-1">Calculating...</div>`;
                const itemID = `assignment-item-${assignment.id}`;
                const item = document.createElement('div');
                item.id = itemID; 
                item.className = 'assignment-item assignment-item-done flex justify-between items-start p-3 rounded-lg bg-white/5 backdrop-blur-sm shadow-md transition-all duration-300 hover:bg-white/10'; 
                item.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-white">${assignment.title}</p>
                        <p class="text-xs text-white/70">${dateDisplay}</p>
                        ${countdownHTML}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.handleMarkAsDone('${assignment.id}', '${itemID}')" class="delete-btn text-green-400 hover:text-green-500 transition-colors duration-200 p-1 rounded"><span data-lucide="check-square" class="w-4 h-4"></span></button>
                        <button onclick="window.db.deleteAssignment('${assignment.id}')" class="delete-btn text-red-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"><span data-lucide="x" class="w-4 h-4"></span></button>
                    </div>
                `;
                list.appendChild(item);
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-btn')) return; 
                    openAssignmentDetailModal(assignment);
                });
            });
            lucide.createIcons();
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdowns, 1000);
        };
        
        window.renderFinishedAssignments = (newFinishedAssignments) => {
            finishedAssignments = newFinishedAssignments;
            const list = document.getElementById('finished-assignment-list');
            const toggleBtn = document.getElementById('toggle-finished-btn');
            list.innerHTML = ''; 
            if (finishedAssignments.length === 0) {
                list.innerHTML = '<p class="text-white/30 text-center mt-4 text-sm">No finished assignments recorded.</p>';
                toggleBtn.querySelector('span:last-child').textContent = "Finished Assignments (0)";
                toggleBtn.disabled = true;
                list.classList.add('hidden');
                return;
            }
            toggleBtn.disabled = false;
            toggleBtn.querySelector('span:last-child').textContent = `Finished Assignments (${finishedAssignments.length})`;

            finishedAssignments.forEach(assignment => {
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const completedAtDate = assignment.completedAt instanceof Date ? assignment.completedAt : new Date(assignment.completedAt);
                
                const datePart = `${String(deadlineDate.getDate()).padStart(2, '0')}/${String(deadlineDate.getMonth() + 1).padStart(2, '0')}/${deadlineDate.getFullYear()}`;
                const timePart = formatTimeForInput(deadlineDate); 
                const formattedDate = datePart + (timePart ? ` at ${timePart}` : '');

                const formattedCompletedDate = `${String(completedAtDate.getDate()).padStart(2, '0')}/${String(completedAtDate.getMonth() + 1).padStart(2, '0')}/${completedAtDate.getFullYear()} ${String(completedAtDate.getHours()).padStart(2, '0')}:${String(completedAtDate.getMinutes()).padStart(2, '0')}`;
                
                const item = document.createElement('div');
                item.className = 'flex justify-between items-start p-3 rounded-lg bg-white/5 backdrop-blur-sm shadow-md transition-all duration-300 hover:bg-white/10 opacity-70 hover:opacity-100'; 
                item.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold finished-assignment-text">${assignment.title}</p>
                        <p class="text-xs finished-assignment-text">Due: ${formattedDate}</p>
                        <p class="text-xs text-green-400 mt-1">Completed: ${formattedCompletedDate}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.db.deleteFinishedAssignment('${assignment.id}')" class="text-red-400 hover:text-red-500 transition-colors duration-200 p-1 rounded opacity-0 hover:opacity-100 transition-opacity"><span data-lucide="x" class="w-4 h-4"></span></button>
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        };

        const updateCountdowns = () => {
            assignments.forEach(assignment => {
                const countdownEl = document.getElementById(`countdown-${assignment.id}`);
                if (!countdownEl) return;

                // 1. DETERMINE TARGET DEADLINE
                let targetDeadline = assignment.deadline; // Default to main deadline
                let label = ""; // CHANGED: Default is now empty (hides "Main Due")
                
                // Check for unfinished subtasks with deadlines
                if (assignment.subtasks && assignment.subtasks.length > 0) {
                    // Filter: Not done AND has a valid deadline string
                    const activeSubtasks = assignment.subtasks.filter(t => !t.done && t.deadline);
                    
                    if (activeSubtasks.length > 0) {
                        // Sort by date (Earliest first)
                        activeSubtasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                        
                        // The winner is the first one
                        targetDeadline = new Date(activeSubtasks[0].deadline);
                        
                        // Show which subtask is driving the timer (truncate if too long)
                        const subName = activeSubtasks[0].text.length > 15 ? activeSubtasks[0].text.substring(0,12) + '...' : activeSubtasks[0].text;
                        label = `Sub: ${subName}`;
                    }
                }

                // Ensure targetDeadline is a valid Date object
                if (!(targetDeadline instanceof Date) && typeof targetDeadline === 'string') {
                    targetDeadline = new Date(targetDeadline);
                }

                if (!(targetDeadline instanceof Date) || isNaN(targetDeadline)) {
                     countdownEl.innerHTML = '<span class="text-gray-400 font-semibold">No Deadline Set</span>';
                     return;
                }

                const remaining = getTimeRemaining(targetDeadline);
                const now = new Date();
                
                // Compare Date objects
                if (targetDeadline.getTime() < now.getTime()) { 
                    const labelHtml = label ? `<span class="text-xs text-white/50 mr-2">${label}</span>` : '';
                    countdownEl.innerHTML = `${labelHtml} <span class="text-red-500 font-bold">Overdue</span>`; 
                    return; 
                }

                // Check if due today
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const deadlineDay = new Date(targetDeadline.getFullYear(), targetDeadline.getMonth(), targetDeadline.getDate());

                if (deadlineDay.getTime() === today.getTime() && targetDeadline.getTime() > now.getTime()) {
                    const labelHtml = label ? `<span class="text-xs text-white/50 mr-2">${label}</span>` : '';
                    countdownEl.innerHTML = `${labelHtml} <span class="text-green-400 font-semibold">Today!</span>`; 
                    return;
                }
                
                // Normal countdown with Label (Conditionally Rendered)
                // This check ensures we don't print an empty line if there is no label
                const labelHtml = label ? `<span class="text-[10px] text-white/50 uppercase tracking-wider mb-0.5">${label}</span>` : '';

                countdownEl.innerHTML = `
                    <div class="flex flex-col">
                        ${labelHtml}
                        <span>
                            <span class="font-bold">${remaining.days}</span>d 
                            <span class="font-bold">${remaining.hours}</span>h 
                            <span class="font-bold">${remaining.minutes}</span>m 
                            <span class="font-bold">${remaining.seconds}</span>s
                        </span>
                    </div>`;
            });
        };
        
        const toggleFinishedAssignments = () => {
            const list = document.getElementById('finished-assignment-list');
            const toggleBtn = document.getElementById('toggle-finished-btn');
            list.classList.toggle('hidden');
            toggleBtn.querySelector('span[data-lucide]').setAttribute('data-lucide', list.classList.contains('hidden') ? 'chevrons-down' : 'chevrons-up');
            lucide.createIcons(); 
        };


       // --- Modal Logic ---
        const openAssignmentModal = () => document.getElementById('assignment-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeAssignmentModal = () => document.getElementById('assignment-modal').classList.add('opacity-0', 'pointer-events-none');
        
        const handleAddAssignment = async () => {
            const titleInput = document.getElementById('assignment-title');
            const deadlineDateInput = document.getElementById('assignment-deadline-date');
            const deadlineTimeInput = document.getElementById('assignment-deadline-time');

            if (!titleInput.value.trim() || !deadlineDateInput.value) return;

            await window.db.addAssignment(
                titleInput.value.trim(), 
                deadlineDateInput.value, 
                deadlineTimeInput.value || null 
            ); 

            titleInput.value = ''; 
            deadlineDateInput.value = ''; 
            deadlineTimeInput.value = ''; 
            closeAssignmentModal();
        };

        // --- SUB-TASK LOGIC & DETAIL MODAL ---
        let detailModal, detailIdInput, detailTitleInput, detailDeadlineDateInput, detailDeadlineTimeInput, detailNoteInput; 
        
        // Local state to hold subtasks while the modal is open
        let currentSubtasks = []; 

        const renderSubtaskUI = () => {
            const container = document.getElementById('subtask-list-container');
            container.innerHTML = '';

            currentSubtasks.forEach((task, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col mb-3 bg-gray-700/30 p-2 rounded-lg border border-gray-600/50 animate-fadeIn';

                // ROW 1: Checkbox, Text, Delete
                const topRow = document.createElement('div');
                topRow.className = 'flex items-center space-x-2 mb-2';
                
                // 1. Checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.done;
                checkbox.className = "w-5 h-5 rounded border-gray-500 accent-green-500 cursor-pointer flex-shrink-0";
                checkbox.onchange = () => {
                    task.done = checkbox.checked;
                    renderSubtaskUI(); 
                };

                // 2. Text Input
                const input = document.createElement('input');
                input.type = 'text';
                input.value = task.text;
                input.placeholder = "Sub-task details...";
                
                const bgClass = task.done 
                    ? 'text-green-200 line-through decoration-green-500/50 opacity-50' 
                    : 'text-white';
                
                input.className = `flex-1 p-1.5 bg-transparent border-b border-transparent focus:border-blue-500 outline-none transition-all duration-300 ${bgClass}`;
                
                input.oninput = (e) => { task.text = e.target.value; };

                // 3. Delete Button
                const delBtn = document.createElement('button');
                delBtn.innerHTML = '<span data-lucide="x" class="w-4 h-4"></span>';
                delBtn.className = "text-red-400 hover:text-red-500 p-1 rounded transition-colors flex-shrink-0";
                delBtn.onclick = () => {
                    currentSubtasks.splice(index, 1);
                    renderSubtaskUI();
                };

                topRow.appendChild(checkbox);
                topRow.appendChild(input);
                topRow.appendChild(delBtn);

                // ROW 2: Deadlines
                const botRow = document.createElement('div');
                botRow.className = 'flex items-center space-x-2 pl-7';
                
                // Date Input
                const dateInput = document.createElement('input');
                dateInput.type = 'date';
                dateInput.value = task.tempDate || ''; // Use temp property for UI state
                dateInput.className = "bg-gray-800 text-white text-xs rounded border border-gray-600 p-1 focus:border-blue-500 outline-none";
                dateInput.onchange = (e) => { task.tempDate = e.target.value; };

                // Time Input
                const timeInput = document.createElement('input');
                timeInput.type = 'time';
                timeInput.value = task.tempTime || ''; // Use temp property for UI state
                timeInput.className = "bg-gray-800 text-white text-xs rounded border border-gray-600 p-1 focus:border-blue-500 outline-none";
                timeInput.onchange = (e) => { task.tempTime = e.target.value; };

                botRow.innerHTML = `<span class="text-xs text-white/50 mr-1">Due:</span>`;
                botRow.appendChild(dateInput);
                botRow.appendChild(timeInput);

                wrapper.appendChild(topRow);
                wrapper.appendChild(botRow);
                container.appendChild(wrapper);
            });
            lucide.createIcons();
        };

        const addSubtask = () => {
            // Add empty task to local state
            currentSubtasks.push({ text: '', done: false });
            renderSubtaskUI();
            
            // Auto-scroll to bottom of the list
            const container = document.getElementById('subtask-list-container');
            // Small timeout to ensure DOM is updated before scrolling
            setTimeout(() => {
                const lastInput = container.lastElementChild?.querySelector('input[type="text"]');
                if(lastInput) lastInput.focus();
                // Scroll the PARENT container (the modal body), not just the list div
                const scrollParent = document.querySelector('#assignment-detail-modal .overflow-y-auto');
                if(scrollParent) scrollParent.scrollTop = scrollParent.scrollHeight;
            }, 50);
        };

       const openAssignmentDetailModal = (assignment) => {
            detailIdInput.value = assignment.id;
            detailTitleInput.value = assignment.title;
            
            if (assignment.deadline instanceof Date && !isNaN(assignment.deadline)) {
                detailDeadlineDateInput.value = formatDateForInput(assignment.deadline);
                detailDeadlineTimeInput.value = formatTimeForInput(assignment.deadline); 
            } else {
                detailDeadlineDateInput.value = '';
                detailDeadlineTimeInput.value = '';
            }
            
            detailNoteInput.value = assignment.notes || ''; 

            // Deep copy subtasks
            currentSubtasks = assignment.subtasks ? JSON.parse(JSON.stringify(assignment.subtasks)) : [];
            
            // PRE-PROCESS SUBTASKS: Split stored 'deadline' string into tempDate and tempTime for the UI
            currentSubtasks.forEach(task => {
                if (task.deadline) {
                    const d = new Date(task.deadline);
                    if (!isNaN(d)) {
                        task.tempDate = formatDateForInput(d);
                        task.tempTime = formatTimeForInput(d);
                    }
                }
            });

            renderSubtaskUI();
            detailModal.classList.remove('opacity-0', 'pointer-events-none');
        };

        const closeAssignmentDetailModal = () => {
            detailModal.classList.add('opacity-0', 'pointer-events-none');
            // Clear inputs
            detailIdInput.value = ''; 
            detailTitleInput.value = ''; 
            detailDeadlineDateInput.value = ''; 
            detailDeadlineTimeInput.value = ''; 
            detailNoteInput.value = '';
            currentSubtasks = []; 
        };

        const handleSaveDetailChanges = async () => {
            const dateString = detailDeadlineDateInput.value;
            const timeString = detailDeadlineTimeInput.value || null;
            
            if (!dateString) return; 

            // PROCESS SUBTASKS: Combine tempDate and tempTime back into 'deadline' ISO string
            const processedSubtasks = currentSubtasks.map(task => {
                let isoDeadline = null;
                if (task.tempDate) {
                    const tVal = task.tempTime || '23:59';
                    const d = new Date(`${task.tempDate}T${tVal}:00`);
                    isoDeadline = d.toISOString();
                }
                
                // Return clean object without temp UI fields
                return {
                    text: task.text,
                    done: task.done,
                    deadline: isoDeadline
                };
            });

            if (window.db && window.db.updateAssignment) {
                 await window.db.updateAssignment(
                    detailIdInput.value, 
                    detailTitleInput.value.trim(), 
                    dateString, 
                    timeString, 
                    detailNoteInput.value,
                    processedSubtasks // Pass the processed array
                ); 
            }
            closeAssignmentDetailModal();
        };


        const handleDeleteFromDetail = async () => {
            if (confirm("Are you sure?")) {
                if (window.db && window.db.deleteAssignment) await window.db.deleteAssignment(detailIdInput.value);
                closeAssignmentDetailModal();
            }
        };

        const openBookmarkModal = () => document.getElementById('bookmark-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBookmarkModal = () => document.getElementById('bookmark-modal').classList.add('opacity-0', 'pointer-events-none');
        const handleAddBookmark = async () => {
            
            const nameInput = document.getElementById('bookmark-name');
            const urlInput = document.getElementById('bookmark-url');
            if (!nameInput.value.trim() || !urlInput.value.trim()) return;
            const url = urlInput.value.trim().startsWith('http') ? urlInput.value.trim() : `https://${urlInput.value.trim()}`;
            await window.db.addBookmark(nameInput.value.trim(), url, 'link');
            nameInput.value = ''; urlInput.value = ''; closeBookmarkModal();
        };

        const openBackgroundGalleryModal = () => document.getElementById('background-gallery-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBackgroundGalleryModal = () => {
            document.getElementById('background-image-file').value = ''; 
            document.getElementById('background-gallery-modal').classList.add('opacity-0', 'pointer-events-none');
        }
        // NEW UTILITY: Compress image to ensure it fits in Firestore (Limit ~1MB)
        const resizeAndCompressImage = (file, maxWidth = 1920, quality = 0.8) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions (maintain aspect ratio)
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Recursively reduce quality if file is still too big (aiming for < 900KB)
                        // Firestore limit is 1MB (1,048,576 bytes). Base64 adds ~33% overhead.
                        // Safe target for Base64 string length is ~1,000,000 chars.
                        
                        const attemptCompression = (q) => {
                            const dataUrl = canvas.toDataURL('image/jpeg', q);
                            if (dataUrl.length > 1000000 && q > 0.1) {
                                attemptCompression(q - 0.1);
                            } else {
                                resolve(dataUrl);
                            }
                        };
                        
                        attemptCompression(quality);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // FIXED: handleAddBackground now compresses image and auto-selects it
        const handleAddBackground = async () => {
            const fileInput = document.getElementById('background-image-file');
            const file = fileInput.files[0];
            const nameInput = document.getElementById('background-file-name');
            const fileName = nameInput.value.trim() || file?.name;
            const btn = document.getElementById('add-background-btn');

            if (!file) return alert('Please select a file.');
            if (!file.type.startsWith('image/')) return alert('File must be an image.');
            
            // Visual feedback
            const originalText = btn.textContent;
            btn.textContent = "Compressing & Uploading...";
            btn.disabled = true;

            try {
                // Use the new compressor instead of raw fileToBase64
                // This prevents the "Disappearing" bug caused by large files
                const base64String = await resizeAndCompressImage(file);
                
                // Upload and get the new ID
                const newId = await window.db.addBackground(base64String, fileName);
                
                if (newId) {
                    // AUTO-APPLY FIX: Immediately set this as the current background
                    currentBackgroundId = newId;
                    localStorage.setItem(CURRENT_BG_KEY, newId);
                    
                    // Clear inputs
                    fileInput.value = ''; 
                    nameInput.value = '';
                    
                    // The onSnapshot listener will fire shortly and redraw the gallery,
                    // but since we updated localStorage, it will pick the correct one.
                }
            } catch (error) { 
                console.error("Error:", error); 
                alert("An error occurred processing the image.");
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        
        window.onload = () => {
            // changeBackground(currentBackgroundId); 
            
            window.renderMCASTLinks(); 
            renderScheduleWidget(); 
            if (nextLessonInterval) clearInterval(nextLessonInterval);
            nextLessonInterval = setInterval(renderScheduleWidget, 1000); 

            detailModal = document.getElementById('assignment-detail-modal');
            detailIdInput = document.getElementById('detail-assignment-id');
            detailTitleInput = document.getElementById('detail-assignment-title');
            detailDeadlineDateInput = document.getElementById('detail-assignment-deadline-date'); // Updated name
            detailDeadlineTimeInput = document.getElementById('detail-assignment-deadline-time'); // New element
            detailNoteInput = document.getElementById('detail-assignment-note');

            // Event Listeners
            document.getElementById('open-assignment-modal-btn').addEventListener('click', openAssignmentModal);
            document.getElementById('close-assignment-modal-btn').addEventListener('click', closeAssignmentModal);
            document.getElementById('add-assignment-btn').addEventListener('click', handleAddAssignment);
            document.getElementById('close-detail-modal-btn')?.addEventListener('click', closeAssignmentDetailModal);
            document.getElementById('save-assignment-btn')?.addEventListener('click', handleSaveDetailChanges);
            document.getElementById('delete-from-detail-btn')?.addEventListener('click', handleDeleteFromDetail);
            document.getElementById('toggle-finished-btn')?.addEventListener('click', toggleFinishedAssignments);
            document.getElementById('bookmark-container').addEventListener('click', (e) => { if (e.target.closest('#open-bookmark-modal-btn')) openBookmarkModal(); });
            document.getElementById('close-bookmark-modal-btn').addEventListener('click', closeBookmarkModal);
            document.getElementById('add-bookmark-btn').addEventListener('click', handleAddBookmark);
            document.getElementById('open-background-gallery-btn').addEventListener('click', openBackgroundGalleryModal);
            document.getElementById('close-background-gallery-modal-btn').addEventListener('click', closeBackgroundGalleryModal);
            document.getElementById('add-background-btn').addEventListener('click', handleAddBackground);
            document.getElementById('add-subtask-btn').addEventListener('click', addSubtask);

            // Calendar Event Listeners (NOW CALLING GLOBAL FUNCTIONS)
            document.getElementById('open-calendar-btn').addEventListener('click', openCalendarModal);
            document.getElementById('calendar-modal').addEventListener('click', closeCalendarModal);
            
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });

            document.getElementById('today-btn').addEventListener('click', () => {
                currentCalendarDate = new Date();
                renderCalendar();
            });
            // Weekly Timetable Logic (Merged here for optimization)
            // Weekly Timetable Logic (Horizontal + Gold + Click Outside)
            document.getElementById('open-weekly-timetable-btn').addEventListener('click', () => {
                const modal = document.getElementById("weekly-timetable-modal");
                const content = document.getElementById("weekly-timetable-content");
                
                // Helper to format individual lessons
                const formatLesson = (item, highlight, isGoldContext) => {
                    let baseClasses = "p-3 rounded-lg mb-2 transition-all duration-300 border";
                    let bgClass, textTitleClass;

                    if (highlight) {
                        if (isGoldContext) {
                            // Gold styling for Friday or End of Day
                            bgClass = 'bg-yellow-500/20 border-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.3)]';
                            textTitleClass = 'text-yellow-300';
                        } else {
                            // Standard Purple styling
                            bgClass = 'bg-purple-800/40 border-purple-400';
                            textTitleClass = 'text-purple-300';
                        }
                    } else {
                        // Inactive styling
                        bgClass = 'bg-white/5 border-transparent';
                        textTitleClass = 'text-blue-300';
                    }

                    return `
                    <div class="${baseClasses} ${bgClass}">
                        <p class="font-semibold ${textTitleClass}">${item.title}</p>
                        <p class="text-white/70 text-sm">${item.start} - ${item.end}</p>
                        <p class="text-white/50 text-xs">${item.location ?? ''}</p>
                    </div>`;
                };
                
                content.innerHTML = "";
                const now = new Date();
                const dayIndex = now.getDay();
                const nowMinutes = now.getHours() * 60 + now.getMinutes();

                for (const day of DAYS_OF_WEEK) {
                    const lessons = TIMETABLE[day];
                    
                    // Create a column for the day
                    let html = `
                    <div class="min-w-[280px] w-[280px] flex-shrink-0 bg-white/5 p-4 rounded-xl border border-white/10">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-white/10 pb-2 text-center uppercase tracking-wider">${day}</h3>
                        <div class="space-y-2">`;
                    
                    lessons.forEach(item => {
                        const start = timeToMinutes(item.start);
                        const end = timeToMinutes(item.end);
                        
                        // Check if this specific lesson is currently active
                        const isCurrent = day === DAYS_OF_WEEK[dayIndex] && nowMinutes >= start && nowMinutes < end && item.title !== "WEEKEND";
                        
                        // Condition for Gold Color: Either it is "END OF DAY" OR it is Friday
                        const isGoldContext = item.title === "END OF DAY" || day === "Friday";

                        html += formatLesson(item, isCurrent, isGoldContext);
                    });
                    
                    html += "</div></div>";
                    content.innerHTML += html;
                }
                modal.classList.remove("opacity-0", "pointer-events-none");
            });

            // Handle clicking outside the modal to close it
            document.getElementById("weekly-timetable-modal").addEventListener('click', (e) => {
                 if (e.target === e.currentTarget) {
                     e.currentTarget.classList.add("opacity-0", "pointer-events-none");
                 }
            });

            // MODIFIED CODE (Forces everything to a Google Search)
            document.getElementById('search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const query = document.getElementById('search-input').value;
                if (query) {
                    // Simple logic: always search Google
                    window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                }
            });
        };
    </script>
</head>
<body class="bg-gray-900">

    <div id="background-container"></div>

    <div class="scroll-container flex justify-center items-start lg:items-center">

        <div class="grid grid-cols-1 lg:grid-cols-7 gap-8 w-full max-w-7xl pt-16 lg:pt-0 pb-16">

            <div class="lg:col-span-2 p-6 bg-white/10 rounded-3xl backdrop-blur-xl shadow-2xl h-fit">
                <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <span data-lucide="graduation-cap" class="w-6 h-6 mr-2 text-blue-400"></span>
                        <span id="mcast-section-title">MCAST Semester</span>
                    </h2>
                    
                    <button onclick="window.toggleMcastLinks()" 
                            class="group p-2 rounded-lg bg-white/5 hover:bg-white/10 hover:text-blue-400 text-white transition-all duration-300"
                            title="Switch Link List">
                        <span id="swap-icon" data-lucide="arrow-left-right" class="w-5 h-5 transition-transform duration-500"></span>
                    </button>
                </div>
                
                <div id="mcast-link-list" class="space-y-3 transition-all duration-300 ease-in-out">
                </div>
            </div>

            <div class="lg:col-span-3 flex flex-col items-center justify-center p-6 space-y-8">
                
                <div id="next-lesson-widget" class="w-full max-w-2xl p-4 bg-white/10 rounded-xl backdrop-blur-md shadow-lg border border-white/20">
                    <p class="text-white/50 text-center">Loading timetable...</p>
                </div>
                <form id="search-form" class="w-full max-w-2xl relative">
                    <input type="text" id="search-input" placeholder="Search Google or type a URL..." 
                    class="w-full p-4 pl-12 pr-24 bg-white/90 text-gray-900 border-2 border-transparent focus:border-blue-500 rounded-full shadow-lg outline-none transition-all duration-300">
                    <span data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500"></span>
                    
                    <a href="https://mail.google.com/" target="_blank" rel="noopener noreferrer" title="Gmail"
                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-red-600 transition-colors">
                        <span data-lucide="mail" class="w-5 h-5"></span>
                    </a>
                    
                    <a href="https://maps.google.com/" target="_blank" rel="noopener noreferrer" title="Google Maps"
                    class="absolute right-12 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-green-600 transition-colors">
                        <span data-lucide="map-pin" class="w-5 h-5"></span>
                    </a>
                    
                    <button type="submit" class="hidden">Search</button>
                </form>

                <div id="bookmark-container" class="grid grid-cols-4 gap-4 sm:gap-6 p-4 rounded-3xl bg-white/5 backdrop-blur-md shadow-inner max-w-2xl w-full overflow-y-auto max-h-[220px] no-scrollbar">
                </div>

                <div class="flex justify-center w-full">
                    <button id="open-background-gallery-btn"
                            class="flex items-center text-sm text-white/70 hover:text-white transition-colors p-3 rounded-full bg-white/10 hover:bg-white/20">
                        <span data-lucide="gallery-vertical" class="w-4 h-4 mr-2"></span>
                        Manage Backgrounds
                    </button>
                </div>

                <p id="user-id-display" class="text-xs text-white/50 mt-4"></p>
            </div>

            <div class="lg:col-span-2 p-5 bg-white/10 rounded-2xl backdrop-blur-xl shadow-lg h-fit">
    
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white flex items-center">
                    <button id="open-calendar-btn" class="hover:bg-black/0 rounded-lg p-1 transition-all duration-200 group" title="Open Calendar View">
                        <span data-lucide="clipboard-list" class="w-6 h-6 text-green-400 group-hover:scale-110 transition-transform"></span>
                    </button>
                    Upcoming Assignments
                </h2>
                <button id="open-assignment-modal-btn"
                        class="w-8 h-8 flex items-center justify-center bg-green-500 text-white rounded-full shadow-md hover:bg-green-600 transition-transform transform hover:scale-110"
                        title="Add New Assignment">
                    <span data-lucide="plus" class="w-5 h-5"></span>
                </button>
            </div>

            <div id="assignment-list" class="space-y-4 max-h-96 overflow-y-auto scroll-container pr-2">
                </div>
            
                            
                <button id="toggle-finished-btn"
                        class="w-full mt-4 flex items-center justify-center p-2 rounded-xl bg-white/5 text-white/70 hover:bg-white/10 hover:text-white transition-colors"
                        title="Show/Hide Completed Assignments">
                    <span data-lucide="chevrons-down" class="w-4 h-4 mr-2"></span>
                    <span>Finished Assignments</span>
                </button>

                <div id="finished-assignment-list" class="space-y-3 mt-4 hidden max-h-20 overflow-y-auto scroll-container pr-2">
                    </div>
            </div>
        </div>
    </div>

    <div id="assignment-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Add New Assignment</h3>
            <div class="space-y-4">
                <input type="text" id="assignment-title" placeholder="Assignment Title"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                <div class="flex space-x-2">
                    <input type="date" id="assignment-deadline-date"
                            class="w-1/2 p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                    <input type="time" id="assignment-deadline-time" placeholder="Optional Time"
                            class="w-1/2 p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-assignment-modal-btn" class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="add-assignment-btn" class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">Save Assignment</button>
            </div>
        </div>
    </div>

    <div id="assignment-detail-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700 transform transition-all duration-300 scale-100 flex flex-col max-h-[85vh]">
            
            <div class="p-6 pb-2 flex-shrink-0">
                <h3 class="text-2xl font-bold text-white">Task Details</h3>
            </div>
            
            <div class="p-6 pt-2 overflow-y-auto custom-scroll space-y-4 flex-grow">
                <input type="hidden" id="detail-assignment-id">
                
                <div>
                    <label class="block text-white/70 text-sm font-semibold mb-1">Title</label>
                    <input type="text" id="detail-assignment-title" class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-white/70 text-sm font-semibold mb-1">Deadline</label>
                    <div class="flex space-x-2">
                        <input type="date" id="detail-assignment-deadline-date" class="w-1/2 p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
                        <input type="time" id="detail-assignment-deadline-time" class="w-1/2 p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div class="border-t border-gray-700 pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-white/70 text-sm font-semibold">Sub-tasks</label>
                        <button id="add-subtask-btn" class="flex items-center text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition-colors shadow-lg">
                            <span data-lucide="plus" class="w-3 h-3 mr-1"></span> Add
                        </button>
                    </div>
                    
                    <div id="subtask-list-container" class="flex flex-col w-full">
                        </div>
                </div>

                <div>
                    <label class="block text-white/70 text-sm font-semibold mb-1">Notes</label>
                    <textarea id="detail-assignment-note" rows="4" class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none resize-none"></textarea>
                </div>
            </div>

            <div class="p-6 border-t border-gray-700 bg-gray-800 rounded-b-2xl flex-shrink-0">
                <div class="flex justify-between space-x-4">
                    <button id="delete-from-detail-btn" class="px-4 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700 font-semibold transition-colors text-sm">Delete Task</button>
                    <div class="flex space-x-3">
                        <button id="close-detail-modal-btn" class="px-4 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors text-sm">Cancel</button>
                        <button id="save-assignment-btn" class="px-4 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors text-sm">Save Changes</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="bookmark-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Add New Bookmark</h3>
            <div class="space-y-4">
                <input type="text" id="bookmark-name" placeholder="Name" class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none">
                <input type="url" id="bookmark-url" placeholder="URL" class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-bookmark-modal-btn" class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="add-bookmark-btn" class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">Save Bookmark</button>
            </div>
        </div>
    </div>

    <div id="background-gallery-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-4xl border border-gray-700 transform transition-all duration-300 scale-100 h-5/6 flex flex-col">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <span data-lucide="gallery-vertical" class="w-6 h-6 mr-2"></span>
                Manage Your Backgrounds
            </h3>

            <div class="flex-grow overflow-y-auto pr-2 mb-6 space-y-4">
                <h4 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Select or Delete</h4>
                <div id="background-gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                
                <h4 class="text-lg font-semibold text-white mb-3 pt-6 border-t border-gray-700 pt-4">Add New Background</h4>
                
                <div class="space-y-4">
                     <p class="text-sm text-white/70">Upload an image file (e.g., JPG, PNG). Max size: 2MB.</p>
                    <input type="text" id="background-file-name" placeholder="Optional: Give this background a name"
                            class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                    <input type="file" id="background-image-file" accept="image/*"
                            class="w-full text-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-auto border-t border-gray-700 pt-4">
                 <button id="close-background-gallery-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                    Close Gallery
                </button>
                <button id="add-background-btn"
                        class="px-5 py-2 rounded-xl bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors">
                    Upload Image
                </button>
            </div>
        </div>
    </div>
   
   <div id="weekly-timetable-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 pointer-events-none transition duration-300 z-50">
        <div class="bg-gray-900 w-auto max-w-[95vw] p-6 rounded-2xl shadow-2xl border border-gray-700 overflow-x-auto overflow-y-hidden relative custom-scroll">
            <h2 class="text-2xl font-bold text-blue-400 mb-4 text-center sticky left-0">Weekly Timetable</h2>
            <div id="weekly-timetable-content" class="flex flex-row gap-6 pb-4"></div>
        </div>
    </div>

    <button id="open-weekly-timetable-btn"
        class="fixed bottom-5 left-5 z-50 p-3 rounded-xl bg-white/10 backdrop-blur-md border border-white/20 shadow-lg hover:bg-white/20 transition flex items-center justify-center">
        <span data-lucide="square-menu" class="w-6 h-6 text-white"></span>
    </button>

    <div id="calendar-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300 z-50">
        <div class="bg-gray-900 w-full max-w-5xl rounded-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
            
            <div class="flex items-center justify-between p-6 border-b border-gray-700 bg-gray-800/50 rounded-t-2xl">
                <h3 id="calendar-month-year" class="text-2xl font-bold text-white capitalize">December 2025</h3>
                <div class="flex space-x-2">
                    <button id="prev-month-btn" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white transition-colors">
                        <span data-lucide="chevron-left" class="w-5 h-5"></span>
                    </button>
                    <button id="today-btn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold transition-colors">
                        Today
                    </button>
                    <button id="next-month-btn" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white transition-colors">
                        <span data-lucide="chevron-right" class="w-5 h-5"></span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-7 bg-gray-800/30 border-b border-gray-700">
                <div class="p-3 text-center text-gray-400 font-semibold text-sm">Mon</div>
                <div class="p-3 text-center text-gray-400 font-semibold text-sm">Tue</div>
                <div class="p-3 text-center text-gray-400 font-semibold text-sm">Wed</div>
                <div class="p-3 text-center text-gray-400 font-semibold text-sm">Thu</div>
                <div class="p-3 text-center text-gray-400 font-semibold text-sm">Fri</div>
                <div class="p-3 text-center text-gray-400 font-semibold text-sm">Sat</div>
                <div class="p-3 text-center text-gray-400 font-semibold text-sm">Sun</div>
            </div>

            <div id="calendar-grid" class="grid grid-cols-7 auto-rows-fr gap-px bg-gray-700 overflow-y-auto custom-scroll p-px">
                </div>
        </div>
    </div>

    <div id="version-timestamp">Last Update 09/02/2025 - 15:26</div>
    
    <style>
    /* Custom Scrollbar for horizontal scrolling */
        .custom-scroll::-webkit-scrollbar { height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
    
    /* --- Drag & Drop Animations --- */
       /* --- Drag & Drop Styles --- */
    .bookmark-item-wrap {
        transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1), opacity 0.2s;
        /* Force the "Button Hand" cursor */
        cursor: pointer !important; 
        touch-action: none;
    }
    
    /* Ensure the inner icon also shows the hand */
    .bookmark-icon {
        cursor: pointer !important;
    }

    /* Only show the "Grabbing" (closed hand) when actually clicking/dragging */
    /* REMOVED: .bookmark-item-wrap:active logic to remove grabbing cursor */

    .dragging {
        opacity: 0.01;
    }

    .drag-over .bookmark-icon {
        transform: scale(1.1);
        border-color: #3b82f6; 
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }
    textarea, .custom-scroll {
        /* For Firefox */
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }

    /* 2. WebKit Scrollbar Styling (Chrome, Edge, Safari) */

    /* The total width of the scrollbar */
    textarea::-webkit-scrollbar, 
    .custom-scroll::-webkit-scrollbar {
        width: 6px; /* Match the thin look in your reference */
    }

    /* The background of the scrollbar (the track) */
    textarea::-webkit-scrollbar-track, 
    .custom-scroll::-webkit-scrollbar-track {
        background: transparent; /* Makes the track invisible like in your reference */
    }

    /* The moving part of the scrollbar (the thumb) */
    textarea::-webkit-scrollbar-thumb, 
    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3); /* Grey/White semi-transparent color */
        border-radius: 3px; /* Rounds the edges */
    }
        
    </style>

</body>
</html>